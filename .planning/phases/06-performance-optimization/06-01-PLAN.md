# Plan 06-01: React Query 데이터 페칭 최적화

---
phase: 06-performance-optimization
plan: 01
type: execute
depends_on: []
files_modified:
  - src/lib/queryClient.ts
  - src/app/providers.tsx
  - src/hooks/useSystemMetrics.ts
  - src/hooks/useContainers.ts
  - src/hooks/useMetricsHistory.ts
---

## Objective

기존 setInterval 기반 폴링을 React Query로 마이그레이션하여 캐싱, 중복 요청 방지, 자동 재시도 등 데이터 페칭을 최적화합니다.

Purpose: 불필요한 네트워크 요청 감소, 탭 비활성화 시 폴링 중지, 에러 복구 자동화
Output: React Query 기반 데이터 페칭 시스템

## Execution Context

**Codebase context:**
- `@tanstack/react-query` 5.90.16 이미 설치됨 (미사용 상태)
- `src/hooks/useSystemMetrics.ts` - 5초 폴링
- `src/hooks/useContainers.ts` - 10초 폴링
- `src/hooks/useMetricsHistory.ts` - 30초 폴링
- `src/config/constants.ts` - POLLING_INTERVALS 정의됨

**Dependencies:**
- Phase 5 완료 (히스토리 훅 존재)

**Design patterns:**
- 기존 훅 API 유지 (breaking change 최소화)
- QueryClient 전역 설정
- staleTime/gcTime으로 캐싱 제어

## Context

Phase 6: Performance Optimization의 첫 번째 계획입니다.

**현재 문제:**
- setInterval 기반 폴링으로 탭 비활성화 시에도 요청 지속
- 중복 요청 방지 없음
- 에러 발생 시 수동 재시도 필요
- 컴포넌트 언마운트 시 cleanup만 존재

**React Query 이점:**
- refetchOnWindowFocus: 탭 포커스 시에만 리페치
- staleTime: 데이터 신선도 관리
- 자동 재시도 (retry: 3)
- 요청 중복 제거 (동일 queryKey)
- Devtools 지원

## Tasks

### Task 1: QueryClient 설정 및 Provider 구성

**File:** `src/lib/queryClient.ts` (신규), `src/app/providers.tsx` (신규)

**Changes:**
1. QueryClient 인스턴스 생성 (기본 옵션 설정)
2. QueryClientProvider 래퍼 컴포넌트 생성
3. layout.tsx에서 Provider 적용

**Implementation:**
```typescript
// src/lib/queryClient.ts
import { QueryClient } from '@tanstack/react-query';

export const queryClient = new QueryClient({
  defaultOptions: {
    queries: {
      staleTime: 1000 * 30, // 30초 동안 fresh
      gcTime: 1000 * 60 * 5, // 5분 캐시 유지
      retry: 2,
      refetchOnWindowFocus: true,
      refetchOnReconnect: true,
    },
  },
});
```

**Commit:** `feat(06-01): QueryClient 설정 및 Provider 구성`

### Task 2: useSystemMetrics 마이그레이션

**File:** `src/hooks/useSystemMetrics.ts`

**Changes:**
1. useQuery 적용 (queryKey: ['system-metrics'])
2. refetchInterval로 폴링 구현
3. 기존 반환 형태 유지 (data, loading, error, refetch)

**Implementation:**
```typescript
import { useQuery } from '@tanstack/react-query';

export function useSystemMetrics(refreshInterval = POLLING_INTERVALS.SYSTEM_METRICS) {
  const { data, isLoading, error, refetch } = useQuery({
    queryKey: ['system-metrics'],
    queryFn: async () => {
      const res = await fetch('/api/system');
      const json = await res.json();
      if (!json.success) throw new Error(json.error);
      return json.data as SystemMetricsData;
    },
    refetchInterval: refreshInterval,
    staleTime: refreshInterval / 2,
  });

  return {
    data: data ?? null,
    loading: isLoading,
    error: error?.message ?? null,
    refetch,
  };
}
```

**Commit:** `refactor(06-01): useSystemMetrics를 React Query로 마이그레이션`

### Task 3: useContainers 마이그레이션

**File:** `src/hooks/useContainers.ts`

**Changes:**
1. useQuery 적용 (queryKey: ['containers'])
2. useMutation 적용 (performAction, getLogs)
3. 액션 성공 시 invalidateQueries로 자동 리페치

**Implementation:**
```typescript
import { useQuery, useMutation, useQueryClient } from '@tanstack/react-query';

export function useContainers(refreshInterval = POLLING_INTERVALS.CONTAINERS) {
  const queryClient = useQueryClient();

  const { data, isLoading, error, refetch } = useQuery({
    queryKey: ['containers'],
    queryFn: async () => { /* ... */ },
    refetchInterval: refreshInterval,
  });

  const actionMutation = useMutation({
    mutationFn: async ({ id, action }) => { /* ... */ },
    onSuccess: () => {
      queryClient.invalidateQueries({ queryKey: ['containers'] });
    },
  });

  // 기존 API 유지
  const performAction = async (id: string, action: string) => {
    return actionMutation.mutateAsync({ id, action });
  };

  return { /* 기존 형태 유지 */ };
}
```

**Commit:** `refactor(06-01): useContainers를 React Query로 마이그레이션`

### Task 4: useMetricsHistory 마이그레이션

**File:** `src/hooks/useMetricsHistory.ts`

**Changes:**
1. useQuery 적용 (queryKey: ['metrics-history', minutes])
2. minutes 파라미터를 queryKey에 포함
3. 기존 chartData 변환 로직 유지

**Commit:** `refactor(06-01): useMetricsHistory를 React Query로 마이그레이션`

## Verification

```bash
# 빌드 확인
npm run build

# 테스트 실행
npm run test

# 개발 서버에서 동작 확인
npm run dev
# 1. 대시보드 로드 후 네트워크 탭에서 중복 요청 없는지 확인
# 2. 탭 전환 후 돌아왔을 때 리페치 확인
# 3. 컨테이너 액션 후 자동 새로고침 확인
```

## Success Criteria

- [ ] QueryClient가 앱 전역에 설정됨
- [ ] 모든 훅이 React Query 기반으로 동작
- [ ] 기존 컴포넌트 코드 변경 없이 동작
- [ ] 탭 포커스 시에만 리페치됨
- [ ] 빌드 및 테스트 성공

## Output

**New files:**
- `src/lib/queryClient.ts`
- `src/app/providers.tsx`

**Modified files:**
- `src/app/layout.tsx`
- `src/hooks/useSystemMetrics.ts`
- `src/hooks/useContainers.ts`
- `src/hooks/useMetricsHistory.ts`

**Commits:** 4 commits (per task)

---
*Created: 2026-01-14*
