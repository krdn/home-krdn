---
phase: 19-rbac-access-control
plan: 01
type: execute
depends_on: []
files_modified: [src/lib/rbac.ts, src/types/auth.ts, src/middleware.ts]
---

<objective>
RBAC 권한 매트릭스와 헬퍼 함수를 구현하고, 미들웨어에서 경로별 세분화된 역할 검사를 적용합니다.

Purpose: Phase 18에서 구축한 역할 시스템을 확장하여 더 세밀한 접근 제어를 가능하게 합니다.
Output: 권한 매트릭스 정의, RBAC 헬퍼 함수, 미들웨어 역할 검사 강화
</objective>

<execution_context>
~/.claude/get-shit-done/workflows/execute-plan.md
./summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/18-auth-system-extension/18-03-SUMMARY.md

# 관련 소스 파일:
@src/middleware.ts
@src/lib/auth.ts
@src/lib/user-service.ts
@src/types/auth.ts

**Tech stack available:** jose, bcryptjs, Prisma 7, Zod
**Established patterns:** 미들웨어 역할 검사, JWT payload에 role 포함, lowercase role 형식
**Constraining decisions:**
- Phase 18: JWT role은 lowercase 형식 (admin, user, viewer) 유지
- Phase 18: 이중 역할 검사 (미들웨어 + API) 패턴 채택
</context>

<tasks>

<task type="auto">
  <name>Task 1: RBAC 권한 매트릭스 및 헬퍼 함수 구현</name>
  <files>src/lib/rbac.ts, src/types/auth.ts</files>
  <action>
1. src/types/auth.ts에 Permission 타입과 ResourceAction 타입 추가:
   - Permission: 리소스(system, docker, projects, users, admin)와 액션(read, write, delete, manage) 조합
   - ResourceAction: 각 리소스에 대한 허용 액션 매핑

2. src/lib/rbac.ts 신규 생성:
   - ROLE_PERMISSIONS 권한 매트릭스 상수 정의:
     * ADMIN: 모든 리소스에 대한 모든 권한
     * USER: system(read), docker(read, write), projects(read, write)
     * VIEWER: system(read), docker(read), projects(read)
   - hasPermission(role, resource, action) 헬퍼 함수 구현
   - canAccessRoute(role, pathname) 헬퍼 함수 구현 (경로 → 필요 권한 매핑)
   - getAllowedActions(role, resource) 헬퍼 함수 구현

주의: UserRole 타입은 lowercase('admin', 'user', 'viewer')를 유지해야 합니다. 기존 JWT와의 호환성을 위함.
  </action>
  <verify>
npx tsc --noEmit 타입 체크 통과
src/lib/rbac.ts가 존재하고 export 확인:
grep -n "hasPermission\|canAccessRoute\|ROLE_PERMISSIONS" src/lib/rbac.ts
  </verify>
  <done>
- ROLE_PERMISSIONS 권한 매트릭스 정의됨
- hasPermission, canAccessRoute, getAllowedActions 함수 구현됨
- 타입스크립트 컴파일 에러 없음
  </done>
</task>

<task type="auto">
  <name>Task 2: 미들웨어 RBAC 통합 및 경로별 권한 검사 강화</name>
  <files>src/middleware.ts</files>
  <action>
1. src/middleware.ts 수정:
   - rbac.ts에서 canAccessRoute 함수 import
   - 기존 admin 경로 하드코딩 검사를 canAccessRoute 기반으로 교체
   - 경로별 세분화된 권한 검사 적용:
     * /api/system/* : viewer 이상 (read 권한)
     * /api/docker/* GET : viewer 이상 (read 권한)
     * /api/docker/* POST/DELETE : user 이상 (write 권한)
     * /api/projects/* GET : viewer 이상 (read 권한)
     * /api/projects/* POST/PUT/DELETE : user 이상 (write 권한)
     * /api/admin/* : admin만 (manage 권한)
     * /admin/* 페이지 : admin만

2. 에러 응답 개선:
   - 403 응답에 필요 권한 정보 포함: { error: "...", code: "FORBIDDEN", requiredRole: "..." }

주의: Edge Runtime 호환성을 위해 rbac.ts도 순수 타입스크립트로 구현해야 합니다 (Node.js 전용 모듈 사용 불가).
  </action>
  <verify>
npx tsc --noEmit 타입 체크 통과
curl 테스트 (로그인 후):
- VIEWER 토큰으로 /api/system → 200
- VIEWER 토큰으로 /api/docker/containers POST → 403
- USER 토큰으로 /api/docker/containers POST → 200
- USER 토큰으로 /api/admin/users → 403
  </verify>
  <done>
- 미들웨어에서 canAccessRoute 기반 권한 검사 적용됨
- 경로별 세분화된 역할 검사 동작함
- HTTP 메서드별 권한 분기 구현됨 (GET vs POST/PUT/DELETE)
  </done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] `npx tsc --noEmit` 타입 체크 통과
- [ ] src/lib/rbac.ts 파일 존재 및 함수들 export 확인
- [ ] 미들웨어에서 canAccessRoute 사용 확인
- [ ] VIEWER/USER/ADMIN 역할별 권한 분리 동작 확인
</verification>

<success_criteria>
- 권한 매트릭스(ROLE_PERMISSIONS) 정의됨
- hasPermission, canAccessRoute 헬퍼 함수 구현됨
- 미들웨어에서 경로 + HTTP 메서드별 권한 검사 동작
- 타입스크립트 에러 없음
</success_criteria>

<output>
After completion, create `.planning/phases/19-rbac-access-control/19-01-SUMMARY.md`
</output>
