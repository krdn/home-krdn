---
phase: 19-rbac-access-control
plan: 02
type: execute
depends_on: ["19-01"]
files_modified: [src/app/api/docker/containers/route.ts, src/app/api/docker/containers/[id]/route.ts, src/app/api/projects/route.ts, src/app/api/projects/[id]/route.ts, src/hooks/useAuth.ts, src/components/admin/RoleGuard.tsx]
---

<objective>
기존 API 라우트에 RBAC 역할 검사를 적용하고, 프론트엔드에서 역할 기반 UI 조건부 렌더링을 구현합니다.

Purpose: 미들웨어 레벨의 보호와 더불어 API/UI 레벨에서도 역할 기반 접근 제어를 적용합니다.
Output: API 라우트 역할 검사, useAuth 훅 권한 메서드, RoleGuard 컴포넌트
</objective>

<execution_context>
~/.claude/get-shit-done/workflows/execute-plan.md
./summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/19-rbac-access-control/19-01-SUMMARY.md

# 관련 소스 파일:
@src/lib/rbac.ts
@src/middleware.ts
@src/app/api/docker/containers/route.ts
@src/app/api/docker/containers/[id]/route.ts
@src/app/api/projects/route.ts
@src/app/api/projects/[id]/route.ts

**Tech stack available:** jose, bcryptjs, Prisma 7, Zod, React 19
**Established patterns:** 미들웨어 + API 이중 검사, JWT payload에서 역할 추출
**Constraining decisions:**
- Plan 19-01: hasPermission, canAccessRoute 함수 사용
- Phase 18: 이중 역할 검사 패턴 (미들웨어 빠른 거부, API 상세 에러)
</context>

<tasks>

<task type="auto">
  <name>Task 1: API 라우트에 RBAC 역할 검사 적용</name>
  <files>src/app/api/docker/containers/route.ts, src/app/api/docker/containers/[id]/route.ts, src/app/api/projects/route.ts, src/app/api/projects/[id]/route.ts</files>
  <action>
1. 각 API 라우트에 역할 검사 추가 (미들웨어 통과 후 2차 검사):

**Docker 컨테이너 API:**
- GET /api/docker/containers: viewer 이상 (미들웨어에서 이미 체크)
- POST /api/docker/containers/[id] (start/stop/restart): user 이상 권한 검사 추가
  * JWT에서 role 추출하여 hasPermission(role, 'docker', 'write') 검사
  * 실패 시 403 + 상세 에러 메시지

**Projects API:**
- GET /api/projects, GET /api/projects/[id]: viewer 이상 (미들웨어에서 체크)
- POST /api/projects: user 이상 권한 검사 추가
- PUT /api/projects/[id], DELETE /api/projects/[id]: user 이상 권한 검사 추가
  * hasPermission(role, 'projects', 'write') 검사

2. 권한 검사 헬퍼 추출 (선택적):
   - extractRoleFromRequest(request) 함수로 JWT에서 역할 추출 로직 공통화
   - src/lib/rbac.ts에 추가하거나 각 라우트에서 인라인 구현

주의: 이미 미들웨어에서 기본 인증이 완료된 상태이므로, API에서는 세부 권한만 검사합니다.
에러 메시지는 한국어로, 필요 권한 정보를 포함합니다.
  </action>
  <verify>
npx tsc --noEmit 타입 체크 통과
grep -n "hasPermission" src/app/api/docker/containers/\[id\]/route.ts
grep -n "hasPermission" src/app/api/projects/route.ts
  </verify>
  <done>
- Docker 컨테이너 제어 API에 user 이상 권한 검사 적용됨
- Projects CRUD API에 적절한 권한 검사 적용됨
- 403 에러 시 상세 메시지 포함
  </done>
</task>

<task type="auto">
  <name>Task 2: 프론트엔드 역할 기반 UI 구현</name>
  <files>src/hooks/useAuth.ts, src/components/admin/RoleGuard.tsx</files>
  <action>
1. src/hooks/useAuth.ts 수정/생성:
   - 현재 사용자 세션에서 역할 정보 가져오기
   - hasPermission(resource, action) 메서드 추가 (rbac.ts 함수 활용)
   - isAdmin, isUser, isViewer 편의 프로퍼티 추가
   - 예시 인터페이스:
     ```
     interface UseAuthReturn {
       user: User | null;
       role: UserRole | null;
       isLoading: boolean;
       hasPermission: (resource: Resource, action: Action) => boolean;
       isAdmin: boolean;
       isUser: boolean;
       isViewer: boolean;
     }
     ```

2. src/components/admin/RoleGuard.tsx 신규 생성:
   - 역할 기반 조건부 렌더링 컴포넌트
   - Props: allowedRoles, fallback(선택), children
   - 현재 사용자 역할이 allowedRoles에 포함되면 children 렌더링
   - 그렇지 않으면 fallback 렌더링 또는 null
   - 예시:
     ```
     <RoleGuard allowedRoles={['admin', 'user']}>
       <DeleteButton />
     </RoleGuard>
     ```

3. "use client" 지시문 추가 (클라이언트 컴포넌트)

주의: rbac.ts의 순수 함수들은 서버/클라이언트 양쪽에서 사용 가능합니다.
Edge Runtime 이슈가 없도록 Node.js 전용 모듈을 피합니다.
  </action>
  <verify>
npx tsc --noEmit 타입 체크 통과
grep -n "hasPermission\|isAdmin" src/hooks/useAuth.ts
ls -la src/components/admin/RoleGuard.tsx
  </verify>
  <done>
- useAuth 훅에 hasPermission, isAdmin, isUser, isViewer 메서드/프로퍼티 추가됨
- RoleGuard 컴포넌트 구현됨
- 클라이언트 컴포넌트로 "use client" 적용됨
  </done>
</task>

<task type="auto">
  <name>Task 3: 역할 기반 UI 적용 및 통합 검증</name>
  <files>src/app/admin/page.tsx, src/components/containers/ContainerCard.tsx</files>
  <action>
1. Admin 대시보드 역할 검사 적용:
   - src/app/admin/page.tsx에서 RoleGuard 또는 useAuth 사용
   - ADMIN이 아닌 경우 접근 제한 메시지 표시 (미들웨어에서 이미 막지만 UI 피드백용)

2. ContainerCard 버튼 역할 검사:
   - Start/Stop/Restart 버튼을 RoleGuard로 감싸기
   - VIEWER는 버튼이 보이지 않거나 disabled 상태
   - USER 이상만 컨테이너 제어 버튼 활성화

3. 통합 검증:
   - npm run build 성공 확인
   - npm run dev로 실행 후 브라우저에서 역할별 UI 차이 확인

주의: 기존 UI/UX를 크게 변경하지 않고, 권한에 따른 버튼 표시/숨김만 적용합니다.
  </action>
  <verify>
npm run build 성공
grep -n "RoleGuard\|useAuth" src/app/admin/page.tsx
grep -n "RoleGuard\|hasPermission" src/components/containers/ContainerCard.tsx
  </verify>
  <done>
- Admin 페이지에 역할 검사 UI 적용됨
- ContainerCard에서 역할별 버튼 표시 조건 적용됨
- 빌드 성공, Phase 19 RBAC Access Control 완료
  </done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] `npm run build` 성공
- [ ] API 라우트에 hasPermission 검사 적용 확인
- [ ] useAuth 훅에 권한 메서드 추가 확인
- [ ] RoleGuard 컴포넌트 존재 확인
- [ ] Admin 페이지 및 ContainerCard에 역할 기반 UI 적용 확인
</verification>

<success_criteria>
- All tasks completed
- All verification checks pass
- API 라우트에서 역할 검사 동작
- 프론트엔드에서 역할별 UI 분기 동작
- Phase 19 RBAC Access Control complete
</success_criteria>

<output>
After completion, create `.planning/phases/19-rbac-access-control/19-02-SUMMARY.md`
</output>
