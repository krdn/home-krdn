---
phase: 34-github-integration
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - prisma/schema.prisma
  - src/types/github.ts
  - src/lib/github-service.ts
autonomous: true
user_setup:
  - service: github
    why: "GitHub API 인증을 위한 Personal Access Token 필요"
    env_vars:
      - name: GITHUB_PAT
        source: "GitHub Settings → Developer settings → Personal access tokens → Fine-grained tokens → Generate new token"
    account_setup:
      - url: "https://github.com/settings/tokens?type=beta"
        skip_if: "이미 GitHub 계정 보유"
    dashboard_config:
      - task: "Fine-grained PAT 생성"
        location: "GitHub → Settings → Developer settings → Personal access tokens → Fine-grained tokens"
        details: "권한: Repository access (read), Actions (read), Metadata (read). 만료: 90일 권장"

must_haves:
  truths:
    - "GitHub 토큰이 DB에 안전하게 저장된다"
    - "Octokit으로 GitHub API 호출이 가능하다"
    - "레포지토리 목록을 조회할 수 있다"
  artifacts:
    - path: "prisma/schema.prisma"
      provides: "GitHubSettings 모델"
      contains: "model GitHubSettings"
    - path: "src/types/github.ts"
      provides: "GitHub 관련 TypeScript 타입"
      exports: ["GitHubRepo", "GitHubCommit", "GitHubWorkflow", "GitHubWorkflowRun"]
    - path: "src/lib/github-service.ts"
      provides: "GitHub API 클라이언트"
      exports: ["getRepositories", "getCommits", "getWorkflows", "getWorkflowRuns"]
  key_links:
    - from: "github-service.ts"
      to: "Octokit"
      via: "octokit.rest.repos"
      pattern: "octokit\\.rest\\."
    - from: "github-service.ts"
      to: "GitHubSettings"
      via: "prisma.gitHubSettings"
      pattern: "prisma\\.gitHubSettings"
---

<objective>
GitHub API 연동을 위한 데이터베이스 모델, 타입 정의, 서비스 레이어 구현

Purpose: GitHub REST API를 안전하게 호출할 수 있는 인프라 구축 (octokit 기반)
Output: GitHubSettings Prisma 모델, TypeScript 타입, github-service.ts
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md

# Prior phase reference (Port Registry 패턴 참조)
@.planning/phases/33-port-registry-system/33-01-SUMMARY.md

# Existing patterns
@src/lib/team-service.ts (Service Layer 패턴)
@src/types/port.ts (타입 정의 패턴)
@prisma/schema.prisma (현재 스키마)
</context>

<tasks>

<task type="auto">
  <name>Task 1: Prisma GitHubSettings 모델 추가</name>
  <files>prisma/schema.prisma</files>
  <action>
    GitHubSettings 모델을 추가한다:
    - id: Int, @id, @default(autoincrement())
    - userId: Int, @unique, User 관계
    - accessToken: String (암호화된 PAT 저장)
    - tokenExpiresAt: DateTime? (선택적 만료일)
    - username: String? (GitHub 사용자명, API 응답에서 획득)
    - avatarUrl: String? (GitHub 아바타)
    - createdAt: DateTime, @default(now())
    - updatedAt: DateTime, @updatedAt

    User 모델에 gitHubSettings 관계 추가 (1:1)

    마이그레이션 실행: npx prisma migrate dev --name add-github-settings
  </action>
  <verify>npx prisma migrate status 에서 에러 없음, prisma/dev.db에 GitHubSettings 테이블 생성</verify>
  <done>GitHubSettings 모델이 스키마에 추가되고 마이그레이션 완료</done>
</task>

<task type="auto">
  <name>Task 2: GitHub 타입 정의 및 Zod 스키마</name>
  <files>src/types/github.ts</files>
  <action>
    GitHub 관련 타입 정의:

    ```typescript
    // GitHub API 응답 타입
    export interface GitHubRepo {
      id: number;
      name: string;
      full_name: string;
      description: string | null;
      html_url: string;
      private: boolean;
      default_branch: string;
      language: string | null;
      stargazers_count: number;
      forks_count: number;
      open_issues_count: number;
      pushed_at: string;
      updated_at: string;
    }

    export interface GitHubCommit {
      sha: string;
      message: string;
      author: {
        name: string;
        email: string;
        date: string;
      };
      committer: {
        name: string;
        email: string;
        date: string;
      };
      html_url: string;
    }

    export interface GitHubWorkflow {
      id: number;
      name: string;
      path: string;
      state: 'active' | 'disabled_manually' | 'disabled_inactivity';
      html_url: string;
    }

    export interface GitHubWorkflowRun {
      id: number;
      name: string | null;
      workflow_id: number;
      status: 'queued' | 'in_progress' | 'completed' | 'waiting';
      conclusion: 'success' | 'failure' | 'cancelled' | 'skipped' | null;
      html_url: string;
      created_at: string;
      updated_at: string;
      head_sha: string;
      head_branch: string | null;
    }

    // DTO 타입
    export interface GitHubSettingsDto {
      id: number;
      userId: number;
      username: string | null;
      avatarUrl: string | null;
      hasToken: boolean; // 토큰 유무만 노출, 값은 미노출
      tokenExpiresAt: Date | null;
      createdAt: Date;
      updatedAt: Date;
    }

    export interface CreateGitHubSettingsInput {
      accessToken: string;
    }
    ```

    Zod 검증 스키마 추가:
    - createGitHubSettingsSchema: accessToken 필수 (ghp_ 또는 github_pat_ 접두사 확인)
  </action>
  <verify>tsc --noEmit 에서 타입 에러 없음</verify>
  <done>GitHub 관련 타입과 Zod 스키마가 정의됨</done>
</task>

<task type="auto">
  <name>Task 3: GitHub Service Layer 구현 (Octokit)</name>
  <files>src/lib/github-service.ts</files>
  <action>
    octokit 패키지 설치: npm install octokit

    GitHub Service Layer 구현 (team-service.ts 패턴 준수):

    1. Octokit 인스턴스 생성 함수
       - getOctokitForUser(userId: number): 사용자의 토큰으로 Octokit 인스턴스 생성
       - 토큰이 없으면 에러 throw

    2. Settings CRUD
       - getGitHubSettings(userId: number): GitHubSettingsDto | null
       - createGitHubSettings(userId: number, input: CreateGitHubSettingsInput): GitHubSettingsDto
       - deleteGitHubSettings(userId: number): void
       - validateToken(token: string): Promise<{valid: boolean; username?: string; avatarUrl?: string}>

    3. Repository 관련
       - getRepositories(userId: number): Promise<GitHubRepo[]>
       - getRepository(userId: number, owner: string, repo: string): Promise<GitHubRepo>

    4. Commit 관련
       - getCommits(userId: number, owner: string, repo: string, options?: {per_page?: number}): Promise<GitHubCommit[]>

    5. Actions Workflow 관련
       - getWorkflows(userId: number, owner: string, repo: string): Promise<GitHubWorkflow[]>
       - getWorkflowRuns(userId: number, owner: string, repo: string, workflowId?: number): Promise<GitHubWorkflowRun[]>

    Rate Limiting 처리:
    - try/catch로 rate limit 에러 감지
    - 에러 시 적절한 메시지 포함 예외 throw

    보안:
    - accessToken은 절대 로그나 응답에 포함하지 않음
    - DTO 변환 시 hasToken: boolean만 노출
  </action>
  <verify>
    npm run build 성공
    src/lib/github-service.ts 파일에서 export된 함수들이 올바른 타입 반환
  </verify>
  <done>
    octokit 기반 GitHub Service Layer 완성
    - Settings CRUD 4개 함수
    - Repository 조회 2개 함수
    - Commit 조회 1개 함수
    - Workflow 조회 2개 함수
    총 9개 함수 구현
  </done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] prisma migrate status 정상
- [ ] npm run build 성공
- [ ] tsc --noEmit 타입 에러 없음
- [ ] src/lib/github-service.ts에서 9개 함수 export 확인
</verification>

<success_criteria>
- All tasks completed
- GitHubSettings 모델 마이그레이션 완료
- GitHub 타입 및 Zod 스키마 정의 완료
- github-service.ts에서 Octokit 기반 API 호출 가능
- 토큰이 로그나 응답에 노출되지 않음
</success_criteria>

<output>
After completion, create `.planning/phases/34-github-integration/34-01-SUMMARY.md`
</output>
