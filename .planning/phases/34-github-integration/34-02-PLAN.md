---
phase: 34-github-integration
plan: 02
type: execute
wave: 2
depends_on: ["34-01"]
files_modified:
  - src/app/api/github/route.ts
  - src/app/api/github/repos/route.ts
  - src/app/api/github/repos/[owner]/[repo]/route.ts
  - src/app/api/github/repos/[owner]/[repo]/commits/route.ts
  - src/app/api/github/repos/[owner]/[repo]/workflows/route.ts
  - src/app/api/github/repos/[owner]/[repo]/workflows/[workflowId]/runs/route.ts
autonomous: true

must_haves:
  truths:
    - "사용자가 GitHub 토큰을 등록/삭제할 수 있다"
    - "사용자가 자신의 레포지토리 목록을 조회할 수 있다"
    - "사용자가 특정 레포지토리의 커밋 히스토리를 볼 수 있다"
    - "사용자가 특정 레포지토리의 workflow 목록과 실행 상태를 볼 수 있다"
  artifacts:
    - path: "src/app/api/github/route.ts"
      provides: "GitHub 설정 CRUD API"
      exports: ["GET", "POST", "DELETE"]
    - path: "src/app/api/github/repos/route.ts"
      provides: "레포지토리 목록 API"
      exports: ["GET"]
    - path: "src/app/api/github/repos/[owner]/[repo]/commits/route.ts"
      provides: "커밋 히스토리 API"
      exports: ["GET"]
    - path: "src/app/api/github/repos/[owner]/[repo]/workflows/route.ts"
      provides: "Workflow 목록 API"
      exports: ["GET"]
  key_links:
    - from: "api/github/route.ts"
      to: "github-service"
      via: "createGitHubSettings, deleteGitHubSettings"
      pattern: "import.*github-service"
    - from: "api/github/repos/route.ts"
      to: "github-service"
      via: "getRepositories"
      pattern: "getRepositories"
---

<objective>
GitHub REST API 엔드포인트 구현 — 토큰 설정, 레포지토리/커밋/워크플로우 조회

Purpose: 프론트엔드에서 GitHub 데이터를 사용할 수 있도록 REST API 제공
Output: 6개 API 라우트 (설정 CRUD + 레포/커밋/워크플로우 조회)
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md

# Prior plan output
@.planning/phases/34-github-integration/34-01-SUMMARY.md

# Existing API patterns
@src/app/api/ports/route.ts (REST API 패턴)
@src/app/api/admin/users/route.ts (인증된 API 패턴)
@src/lib/error-handler.ts (에러 핸들링)
</context>

<tasks>

<task type="auto">
  <name>Task 1: GitHub Settings API (GET/POST/DELETE)</name>
  <files>src/app/api/github/route.ts</files>
  <action>
    GitHub 설정 CRUD API 구현:

    GET /api/github
    - 현재 로그인 사용자의 GitHub 설정 조회
    - 응답: { success: true, data: GitHubSettingsDto | null }
    - 토큰 값은 절대 응답에 포함하지 않음 (hasToken: boolean만)

    POST /api/github
    - 새 GitHub 토큰 등록 또는 업데이트
    - 요청: { accessToken: string }
    - Zod 검증: createGitHubSettingsSchema
    - 토큰 유효성 검사 (validateToken) 후 저장
    - 응답: { success: true, data: GitHubSettingsDto }

    DELETE /api/github
    - GitHub 연동 해제 (토큰 삭제)
    - 응답: { success: true }

    공통:
    - requireAuth 미들웨어로 인증 확인
    - try/catch + error-handler 사용
    - 로그에 토큰 미포함
  </action>
  <verify>
    curl -X GET /api/github (인증 필요)
    curl -X POST /api/github -d '{"accessToken":"ghp_xxx"}' (토큰 검증)
    curl -X DELETE /api/github (삭제)
  </verify>
  <done>GitHub 설정 CRUD API 완성</done>
</task>

<task type="auto">
  <name>Task 2: Repositories List API</name>
  <files>src/app/api/github/repos/route.ts</files>
  <action>
    GET /api/github/repos
    - 현재 사용자의 GitHub 레포지토리 목록 조회
    - Query params: per_page (기본 30), page (기본 1), type (all/owner/public/private)
    - github-service.getRepositories() 호출
    - 응답: { success: true, data: GitHubRepo[] }

    에러 처리:
    - 토큰 미설정: 401 Unauthorized
    - Rate limit: 429 Too Many Requests
    - GitHub API 에러: 502 Bad Gateway
  </action>
  <verify>curl -X GET /api/github/repos 레포지토리 목록 반환</verify>
  <done>레포지토리 목록 API 완성</done>
</task>

<task type="auto">
  <name>Task 3: Repository Detail & Commits API</name>
  <files>
    src/app/api/github/repos/[owner]/[repo]/route.ts
    src/app/api/github/repos/[owner]/[repo]/commits/route.ts
  </files>
  <action>
    GET /api/github/repos/[owner]/[repo]
    - 특정 레포지토리 상세 정보 조회
    - github-service.getRepository(userId, owner, repo)
    - 응답: { success: true, data: GitHubRepo }

    GET /api/github/repos/[owner]/[repo]/commits
    - 특정 레포지토리의 커밋 히스토리 조회
    - Query params: per_page (기본 30), sha (브랜치/커밋)
    - github-service.getCommits(userId, owner, repo, options)
    - 응답: { success: true, data: GitHubCommit[] }

    Next.js 15+ 동적 라우트 파라미터 처리:
    - params는 Promise이므로 await 사용
    - const { owner, repo } = await params;
  </action>
  <verify>
    curl /api/github/repos/owner/repo-name 레포 상세
    curl /api/github/repos/owner/repo-name/commits 커밋 목록
  </verify>
  <done>레포지토리 상세 및 커밋 API 완성</done>
</task>

<task type="auto">
  <name>Task 4: Workflows & Runs API</name>
  <files>
    src/app/api/github/repos/[owner]/[repo]/workflows/route.ts
    src/app/api/github/repos/[owner]/[repo]/workflows/[workflowId]/runs/route.ts
  </files>
  <action>
    GET /api/github/repos/[owner]/[repo]/workflows
    - 특정 레포지토리의 GitHub Actions workflow 목록 조회
    - github-service.getWorkflows(userId, owner, repo)
    - 응답: { success: true, data: GitHubWorkflow[] }

    GET /api/github/repos/[owner]/[repo]/workflows/[workflowId]/runs
    - 특정 workflow의 실행 기록 조회
    - Query params: per_page (기본 10), status (queued/in_progress/completed)
    - github-service.getWorkflowRuns(userId, owner, repo, workflowId)
    - 응답: { success: true, data: GitHubWorkflowRun[] }

    workflowId 없이 전체 runs 조회도 지원:
    GET /api/github/repos/[owner]/[repo]/runs (별도 라우트 또는 workflow 라우트에 통합)
  </action>
  <verify>
    curl /api/github/repos/owner/repo/workflows workflow 목록
    curl /api/github/repos/owner/repo/workflows/123/runs 실행 기록
  </verify>
  <done>Workflow 및 실행 기록 API 완성</done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] npm run build 성공
- [ ] tsc --noEmit 타입 에러 없음
- [ ] 모든 API 라우트가 올바른 HTTP 메서드 export
- [ ] 인증되지 않은 요청에 401 반환 확인
</verification>

<success_criteria>
- All tasks completed
- 6개 API 라우트 구현 완료
- 모든 API가 인증 미들웨어 사용
- 에러 응답이 표준 형식 준수
- 토큰이 응답에 노출되지 않음
</success_criteria>

<output>
After completion, create `.planning/phases/34-github-integration/34-02-SUMMARY.md`
</output>
