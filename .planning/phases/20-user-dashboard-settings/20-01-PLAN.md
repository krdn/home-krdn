---
phase: 20-user-dashboard-settings
plan: 01
type: execute
depends_on: []
files_modified: [src/lib/settings-service.ts, src/app/api/settings/route.ts]
---

<objective>
UserSettings 백엔드 서비스 및 API 라우트 구현

Purpose: 사용자별 대시보드 설정(테마, 알림, 레이아웃)을 서버에 저장하고 관리하는 기반 구축
Output: settings-service.ts 서비스 함수 + /api/settings API 엔드포인트
</objective>

<execution_context>
~/.claude/get-shit-done/workflows/execute-plan.md
./summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/19-rbac-access-control/19-02-SUMMARY.md

# 관련 소스 파일
@prisma/schema.prisma (UserSettings 모델 정의됨)
@src/lib/user-service.ts (기존 유저 서비스 패턴)
@src/lib/auth.ts (인증 함수)

**Tech stack available:**
- Prisma 7 + SQLite
- Zod 검증
- jose JWT

**Established patterns:**
- 서비스 레이어: src/lib/{name}-service.ts
- API 라우트: src/app/api/{name}/route.ts
- authenticateUserFromDB 미들웨어 패턴
</context>

<tasks>

<task type="auto">
  <name>Task 1: UserSettings 서비스 함수 구현</name>
  <files>src/lib/settings-service.ts</files>
  <action>
  새 파일 src/lib/settings-service.ts 생성.

  구현 함수들:
  1. `getUserSettings(userId: string)`: UserSettings 조회, 없으면 기본값으로 생성 후 반환
  2. `updateUserSettings(userId: string, data: UpdateSettingsInput)`: 설정 업데이트
  3. `getOrCreateUserSettings(userId: string)`: 내부 헬퍼 - 없으면 생성

  타입 정의:
  - `UserSettingsDto`: 클라이언트 반환용 타입 (id, dashboardLayout, theme, emailNotifications, pushNotifications)
  - `UpdateSettingsInput`: Zod 스키마 (theme: dark/light, emailNotifications: boolean, pushNotifications: boolean, dashboardLayout: optional string)

  기본값: theme="dark", emailNotifications=true, pushNotifications=false

  user-service.ts 패턴을 따르되 passwordHash 같은 민감 정보 없으므로 전체 반환 가능.
  주의: userId가 존재하지 않으면 Prisma 에러 발생 → 상위에서 처리
  </action>
  <verify>TypeScript 컴파일 오류 없음 (npx tsc --noEmit)</verify>
  <done>settings-service.ts에 getUserSettings, updateUserSettings 함수 구현됨, Zod 검증 스키마 포함</done>
</task>

<task type="auto">
  <name>Task 2: UserSettings API 라우트 구현 (GET/PUT)</name>
  <files>src/app/api/settings/route.ts</files>
  <action>
  새 파일 src/app/api/settings/route.ts 생성.

  GET /api/settings:
  - authenticateUserFromDB로 사용자 인증
  - getUserSettings(userId) 호출
  - 200: { success: true, data: UserSettingsDto }
  - 401: 미인증

  PUT /api/settings:
  - authenticateUserFromDB로 사용자 인증
  - request.json() 파싱
  - UpdateSettingsInputSchema.safeParse()로 검증
  - 검증 실패 시 400 반환
  - updateUserSettings(userId, data) 호출
  - 200: { success: true, data: UserSettingsDto }
  - 401: 미인증, 400: 검증 실패

  Edge Runtime 호환을 위해 prisma 직접 사용 가능 (better-sqlite3 어댑터 사용 중이므로 Node.js runtime 필요).
  route.ts 상단에 export const runtime = 'nodejs' 명시.
  </action>
  <verify>curl -X GET /api/settings (인증 포함), curl -X PUT /api/settings 테스트</verify>
  <done>GET/PUT /api/settings API 동작, 인증 필요, Zod 검증 적용</done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] `npm run build` 성공
- [ ] `npx tsc --noEmit` 타입 오류 없음
- [ ] /api/settings GET 요청 시 인증 필요 확인
- [ ] /api/settings PUT 요청으로 설정 변경 가능
</verification>

<success_criteria>

- settings-service.ts 서비스 함수 구현 완료
- /api/settings API 라우트 구현 완료
- 인증된 사용자만 자신의 설정 조회/수정 가능
- Zod 검증 적용
</success_criteria>

<output>
After completion, create `.planning/phases/20-user-dashboard-settings/20-01-SUMMARY.md`
</output>
