---
phase: 17-database-infrastructure
plan: 02
type: execute
depends_on: ["17-01"]
files_modified: [prisma/dev.db, src/lib/auth.ts, src/lib/user-service.ts, src/types/auth.ts]
---

<objective>
데이터베이스 마이그레이션 실행 및 기존 인증 시스템과의 호환 레이어 구현

Purpose: 스키마를 실제 DB에 적용하고, 기존 환경변수 기반 인증에서 DB 기반으로 전환할 수 있는 호환 레이어를 준비합니다.
Output: 마이그레이션된 DB 파일, 유저 서비스 레이어, 호환성 유지된 인증 시스템
</objective>

<execution_context>
~/.claude/get-shit-done/workflows/execute-plan.md
./summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/17-database-infrastructure/17-01-SUMMARY.md
@src/lib/auth.ts
@src/types/auth.ts

**Plan 01 결과물:**
- prisma/schema.prisma (User, Team, TeamMember, UserSettings)
- src/lib/prisma.ts (싱글톤 클라이언트)
- prisma.config.ts (설정)

**호환성 전략:**
- 기존 getAdminUser()는 환경변수 → DB 조회로 점진적 전환
- 기존 User 타입 유지하면서 PrismaUser와 매핑
- authenticateUser()는 DB 기반으로 확장 준비
</context>

<tasks>

<task type="auto">
  <name>Task 1: Prisma 마이그레이션 실행 및 초기 데이터</name>
  <files>prisma/migrations/*, prisma/dev.db, prisma/seed.ts</files>
  <action>
1. 초기 마이그레이션 생성 및 실행:
```bash
npx prisma migrate dev --name init
```
이 명령은:
- prisma/migrations/ 디렉토리에 마이그레이션 파일 생성
- prisma/dev.db SQLite 파일 생성
- @prisma/client 자동 재생성

2. prisma/seed.ts 시드 스크립트 생성:
```typescript
import { PrismaClient, Role } from '@prisma/client'
import bcrypt from 'bcryptjs'

const prisma = new PrismaClient()

async function main() {
  // 환경변수에서 관리자 정보 로드 (기존 호환)
  const adminUsername = process.env.ADMIN_USERNAME || 'admin'
  const adminPasswordHash = process.env.ADMIN_PASSWORD_HASH

  if (!adminPasswordHash) {
    console.warn('ADMIN_PASSWORD_HASH not set, generating default hash')
    // 개발용 기본값 (프로덕션에서는 환경변수 필수)
  }

  // 기존 관리자 계정을 DB로 마이그레이션
  const adminUser = await prisma.user.upsert({
    where: { username: adminUsername },
    update: {},
    create: {
      id: 'admin-001', // 기존 ID 유지
      email: `${adminUsername}@localhost`,
      username: adminUsername,
      passwordHash: adminPasswordHash || await bcrypt.hash('admin', 10),
      role: Role.ADMIN,
      displayName: 'Administrator',
    },
  })

  console.log('Seeded admin user:', adminUser.username)
}

main()
  .catch((e) => {
    console.error(e)
    process.exit(1)
  })
  .finally(async () => {
    await prisma.$disconnect()
  })
```

3. package.json에 seed 스크립트 추가:
```json
"prisma": {
  "seed": "tsx prisma/seed.ts"
}
```

4. 시드 실행:
```bash
npm install -D tsx  # TypeScript 실행기
npx prisma db seed
```
  </action>
  <verify>npx prisma studio 로 DB 확인 또는 ls -la prisma/dev.db 파일 존재 확인</verify>
  <done>마이그레이션 완료, dev.db 생성, 시드 데이터 적용</done>
</task>

<task type="auto">
  <name>Task 2: 유저 서비스 및 인증 호환 레이어 구현</name>
  <files>src/lib/user-service.ts, src/lib/auth.ts, src/types/auth.ts</files>
  <action>
1. src/lib/user-service.ts (새 파일) - DB 기반 유저 서비스:
```typescript
/**
 * User Service
 * Prisma 기반 사용자 데이터 액세스 레이어
 */

import prisma from '@/lib/prisma'
import type { User, Role } from '@prisma/client'

// Prisma User를 레거시 User 타입으로 변환
export function toUserDto(user: User): {
  id: string
  username: string
  role: 'admin' | 'user'
} {
  return {
    id: user.id,
    username: user.username,
    role: user.role === 'ADMIN' ? 'admin' : 'user',
  }
}

/**
 * 사용자명으로 사용자 조회
 */
export async function findUserByUsername(username: string): Promise<User | null> {
  return prisma.user.findUnique({
    where: { username },
  })
}

/**
 * 이메일로 사용자 조회
 */
export async function findUserByEmail(email: string): Promise<User | null> {
  return prisma.user.findUnique({
    where: { email },
  })
}

/**
 * ID로 사용자 조회
 */
export async function findUserById(id: string): Promise<User | null> {
  return prisma.user.findUnique({
    where: { id },
  })
}

/**
 * 로그인 시간 업데이트
 */
export async function updateLastLogin(userId: string): Promise<void> {
  await prisma.user.update({
    where: { id: userId },
    data: { lastLoginAt: new Date() },
  })
}
```

2. src/lib/auth.ts 확장 (기존 코드 유지하면서 DB 지원 추가):
```typescript
// 기존 import 유지
import { findUserByUsername, toUserDto, updateLastLogin } from './user-service'

/**
 * 데이터베이스 기반 사용자 인증 (v2.0)
 * 환경변수 기반 인증과 병행 가능
 */
export async function authenticateUserFromDB(
  username: string,
  password: string
): Promise<{ success: boolean; token?: string; error?: string }> {
  const user = await findUserByUsername(username)

  if (!user) {
    return { success: false, error: '잘못된 사용자명 또는 비밀번호' }
  }

  const isValid = await comparePassword(password, user.passwordHash)

  if (!isValid) {
    return { success: false, error: '잘못된 사용자명 또는 비밀번호' }
  }

  // 로그인 시간 업데이트
  await updateLastLogin(user.id)

  // JWT 토큰 생성 (기존 User 타입 호환)
  const token = await createToken(toUserDto(user))

  return { success: true, token }
}

// 기존 authenticateUser() 함수는 그대로 유지
// Phase 18에서 점진적으로 authenticateUserFromDB로 전환
```

3. src/types/auth.ts에 Prisma 타입 연결 추가:
```typescript
// 기존 타입 유지

// Prisma 타입 re-export (클라이언트 생성 후 사용 가능)
// export type { User as PrismaUser, Team, TeamMember, Role } from '@prisma/client'

// 호환성 타입
export interface UserWithTeams {
  id: string
  username: string
  email: string
  role: UserRole
  teams: {
    id: string
    name: string
    role: UserRole
  }[]
}
```
  </action>
  <verify>npm run build 로 타입 검사 통과 확인</verify>
  <done>유저 서비스 레이어 구현, 인증 함수 확장, 타입 호환성 유지</done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] `npx prisma migrate status` 마이그레이션 적용 확인
- [ ] `prisma/dev.db` 파일 존재
- [ ] `npx prisma db seed` 시드 데이터 적용
- [ ] `npm run build` 빌드 성공
- [ ] src/lib/user-service.ts 존재 및 export 확인
</verification>

<success_criteria>

- 마이그레이션 완료 (prisma/migrations/ 존재)
- SQLite DB 파일 생성 (prisma/dev.db)
- 시드 스크립트로 기존 관리자 계정 마이그레이션
- user-service.ts 유저 조회 함수 구현
- auth.ts에 DB 기반 인증 함수 추가
- 기존 인증 함수와 호환성 유지
- Phase 17 Database Infrastructure 완료
</success_criteria>

<output>
After completion, create `.planning/phases/17-database-infrastructure/17-02-SUMMARY.md`:

---
phase: 17-database-infrastructure
plan: 02
subsystem: database
requires: [17-01]
provides: [db-migration, user-service, auth-db-layer]
affects: [18-auth-system-extension]
tags: [database, migration, seed, user-service]
key-decisions:
  - 기존 admin-001 ID 유지로 JWT 호환성 확보
  - authenticateUserFromDB vs authenticateUser 병행 운영
  - tsx로 TypeScript 시드 스크립트 실행
key-files: [prisma/seed.ts, src/lib/user-service.ts, prisma/dev.db]
tech-stack:
  added: [tsx]
  patterns: [user-service-layer, db-auth]
patterns-established:
  - User service layer for DB access
  - Prisma seed script pattern
  - Legacy compatibility layer
---

# Phase 17 Plan 02: Migration & Integration Summary

**[작성 예정]**

## Accomplishments

- [ ] 마이그레이션 실행 및 DB 생성
- [ ] 시드 스크립트로 관리자 계정 마이그레이션
- [ ] 유저 서비스 레이어 구현
- [ ] DB 기반 인증 함수 추가

## Files Created/Modified

- `prisma/migrations/*` - 마이그레이션 히스토리
- `prisma/dev.db` - SQLite 데이터베이스
- `prisma/seed.ts` - 시드 스크립트
- `src/lib/user-service.ts` - 유저 서비스 레이어
- `src/lib/auth.ts` - DB 인증 함수 추가

## Next Phase

Phase 17 complete, ready for Phase 18 (Auth System Extension)
</output>
