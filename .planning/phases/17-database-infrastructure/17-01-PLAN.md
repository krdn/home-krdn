---
phase: 17-database-infrastructure
plan: 01
type: execute
depends_on: []
files_modified: [package.json, prisma/schema.prisma, prisma.config.ts, src/lib/prisma.ts, .env.example]
---

<objective>
Prisma 7 + SQLite 기반 데이터베이스 인프라 설치 및 User/Team 스키마 설계

Purpose: v2.0 멀티 유저 기능의 데이터 계층 기반을 마련합니다. 이 인프라 위에 Phase 18-21의 인증, RBAC, 대시보드, 팀 기능이 구축됩니다.
Output: Prisma 설정 파일, User/Team 스키마, 싱글톤 클라이언트, 환경변수 템플릿
</objective>

<execution_context>
~/.claude/get-shit-done/workflows/execute-plan.md
./summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@src/lib/auth.ts
@src/types/auth.ts

**기존 인증 시스템:**
- 환경변수 기반 단일 관리자 (ADMIN_USERNAME, ADMIN_PASSWORD_HASH)
- jose JWT + bcryptjs 해싱
- User 타입: { id, username, role }

**호환성 요구사항:**
- 기존 User 타입과 신규 Prisma User 모델 간 호환
- JWT payload는 그대로 유지 (userId, username, role)
- 단계적 마이그레이션 지원

**Prisma 7 특이사항 (검색 결과 기반):**
- prisma.config.ts 설정 파일 분리
- @prisma/adapter-better-sqlite3 드라이버 필요
- 싱글톤 패턴 필수 (Next.js hot reload 대응)
</context>

<tasks>

<task type="auto">
  <name>Task 1: Prisma 7 + SQLite 의존성 설치</name>
  <files>package.json</files>
  <action>
Prisma 7 및 SQLite 관련 패키지 설치:

```bash
npm install @prisma/client @prisma/adapter-better-sqlite3 better-sqlite3
npm install -D prisma @types/better-sqlite3
```

- @prisma/client: Prisma Client (런타임)
- @prisma/adapter-better-sqlite3: SQLite 드라이버 어댑터
- better-sqlite3: 네이티브 SQLite 바인딩
- prisma: CLI 및 개발 도구
- @types/better-sqlite3: TypeScript 타입

package.json scripts에 추가:
- "db:migrate": "prisma migrate dev"
- "db:generate": "prisma generate"
- "db:studio": "prisma studio"
- "db:push": "prisma db push"
  </action>
  <verify>npm ls @prisma/client && npm ls prisma 로 설치 확인</verify>
  <done>Prisma 패키지 설치 완료, npm scripts 추가됨</done>
</task>

<task type="auto">
  <name>Task 2: Prisma 설정 및 싱글톤 클라이언트 구성</name>
  <files>prisma.config.ts, prisma/schema.prisma, src/lib/prisma.ts, .env.example</files>
  <action>
1. prisma.config.ts (프로젝트 루트):
```typescript
import 'dotenv/config'
import { defineConfig } from 'prisma/config'

export default defineConfig({
  schema: 'prisma/schema.prisma',
  datasource: {
    url: process.env.DATABASE_URL || 'file:./dev.db',
  },
})
```

2. prisma/schema.prisma 초기 구조:
```prisma
generator client {
  provider        = "prisma-client-js"
  previewFeatures = ["driverAdapters"]
}

datasource db {
  provider = "sqlite"
  url      = env("DATABASE_URL")
}

// 스키마는 Task 3에서 추가
```

3. src/lib/prisma.ts (싱글톤 패턴):
```typescript
import { PrismaClient } from '@prisma/client'
import { PrismaLibSQL } from '@prisma/adapter-libsql'

const globalForPrisma = globalThis as unknown as {
  prisma: PrismaClient | undefined
}

export const prisma = globalForPrisma.prisma ?? new PrismaClient()

if (process.env.NODE_ENV !== 'production') {
  globalForPrisma.prisma = prisma
}

export default prisma
```
주의: better-sqlite3 어댑터 사용 시 어댑터 설정 필요할 수 있음. 기본 SQLite provider로 시작하고 필요시 어댑터 추가.

4. .env.example 업데이트:
```
DATABASE_URL="file:./prisma/dev.db"
```
  </action>
  <verify>npx prisma validate 로 스키마 문법 검증</verify>
  <done>Prisma 설정 파일 생성, 싱글톤 클라이언트 구현, 환경변수 템플릿 업데이트</done>
</task>

<task type="auto">
  <name>Task 3: User 및 Team 스키마 설계</name>
  <files>prisma/schema.prisma, src/types/auth.ts</files>
  <action>
prisma/schema.prisma에 모델 추가:

```prisma
// 사용자 역할
enum Role {
  ADMIN
  USER
  VIEWER
}

// 사용자
model User {
  id            String   @id @default(cuid())
  email         String   @unique
  username      String   @unique
  passwordHash  String
  role          Role     @default(USER)

  // 프로필
  displayName   String?
  avatarUrl     String?

  // 타임스탬프
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt
  lastLoginAt   DateTime?

  // 관계
  ownedTeams    Team[]   @relation("TeamOwner")
  teamMemberships TeamMember[]

  // 설정 (Phase 20)
  settings      UserSettings?
}

// 팀
model Team {
  id          String   @id @default(cuid())
  name        String
  slug        String   @unique
  description String?

  // 소유자
  ownerId     String
  owner       User     @relation("TeamOwner", fields: [ownerId], references: [id])

  // 타임스탬프
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  // 관계
  members     TeamMember[]
}

// 팀 멤버십 (다대다 관계)
model TeamMember {
  id        String   @id @default(cuid())
  role      Role     @default(USER)

  // 외래키
  userId    String
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  teamId    String
  team      Team     @relation(fields: [teamId], references: [id], onDelete: Cascade)

  // 타임스탬프
  joinedAt  DateTime @default(now())

  // 유니크 제약 (한 사용자가 한 팀에 한 번만 가입)
  @@unique([userId, teamId])
}

// 사용자 설정 (Phase 20 준비)
model UserSettings {
  id              String   @id @default(cuid())

  // 사용자 연결
  userId          String   @unique
  user            User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  // 대시보드 설정 (JSON)
  dashboardLayout String?  // JSON string
  theme           String   @default("dark")

  // 알림 설정
  emailNotifications Boolean @default(true)
  pushNotifications  Boolean @default(false)

  // 타임스탬프
  updatedAt       DateTime @updatedAt
}
```

기존 타입과의 호환을 위해 src/types/auth.ts에 Prisma 타입 re-export 준비:
- Prisma 생성 후 `import { User as PrismaUser } from '@prisma/client'` 가능
- 기존 User 인터페이스는 UserLegacy로 유지하거나 점진적 교체
  </action>
  <verify>npx prisma validate && npx prisma format</verify>
  <done>User, Team, TeamMember, UserSettings 모델 정의 완료, 관계 설정 완료</done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] `npm ls @prisma/client` 설치 확인
- [ ] `npx prisma validate` 스키마 검증 통과
- [ ] `npx prisma format` 포맷팅 완료
- [ ] src/lib/prisma.ts 싱글톤 클라이언트 존재
- [ ] .env.example에 DATABASE_URL 추가됨
</verification>

<success_criteria>

- Prisma 7 패키지 설치 완료
- prisma.config.ts 설정 파일 생성
- prisma/schema.prisma에 User, Team, TeamMember, UserSettings 모델 정의
- src/lib/prisma.ts 싱글톤 클라이언트 구현
- 스키마 검증 통과
</success_criteria>

<output>
After completion, create `.planning/phases/17-database-infrastructure/17-01-SUMMARY.md`:

---
phase: 17-database-infrastructure
plan: 01
subsystem: database
requires: []
provides: [prisma-client, user-schema, team-schema]
affects: [18-auth-system-extension, 19-rbac-access-control, 20-user-dashboard-settings, 21-team-features]
tags: [database, prisma, sqlite, schema]
key-decisions:
  - SQLite 파일 DB로 시작 (마이그레이션 용이)
  - Role enum으로 ADMIN/USER/VIEWER 구분
  - UserSettings 분리 (1:1 관계)
key-files: [prisma/schema.prisma, src/lib/prisma.ts, prisma.config.ts]
tech-stack:
  added: [prisma, @prisma/client, better-sqlite3]
  patterns: [singleton-prisma-client]
patterns-established:
  - Prisma 싱글톤 패턴 for Next.js hot reload
  - User-Team-TeamMember 관계 모델
---

# Phase 17 Plan 01: Prisma Setup & Schema Summary

**[작성 예정]**

## Accomplishments

- [ ] Prisma 7 설치 및 구성
- [ ] User/Team 스키마 설계
- [ ] 싱글톤 클라이언트 구현

## Files Created/Modified

- `prisma/schema.prisma` - DB 스키마 정의
- `prisma.config.ts` - Prisma 설정
- `src/lib/prisma.ts` - 싱글톤 클라이언트
- `.env.example` - 환경변수 템플릿

## Next Step

Ready for 17-02-PLAN.md (마이그레이션 및 통합)
</output>
