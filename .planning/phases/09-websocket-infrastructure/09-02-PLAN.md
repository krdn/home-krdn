---
phase: 09-websocket-infrastructure
plan: 02
type: execute
depends_on: ["09-01"]
files_modified: [src/hooks/useWebSocket.ts, src/lib/websocket-client.ts, src/config/constants.ts]
---

<objective>
WebSocket 클라이언트 훅 구현 - 자동 재연결, heartbeat, 타입 안전한 메시지 처리를 갖춘 React 훅을 구축합니다.

Purpose: 서버에서 푸시되는 실시간 데이터를 React 컴포넌트에서 쉽게 사용할 수 있는 인터페이스 제공
Output: useWebSocket 훅 및 클라이언트 유틸리티, 연결 상태 관리
</objective>

<execution_context>
~/.claude/get-shit-done/workflows/execute-plan.md
./summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/09-websocket-infrastructure/DISCOVERY.md
@.planning/phases/09-websocket-infrastructure/09-01-SUMMARY.md
@src/types/websocket.ts
@src/lib/websocket-server.ts
@src/hooks/useSystemMetrics.ts
@src/config/constants.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: WebSocket 상수 및 클라이언트 유틸리티 구현</name>
  <files>src/config/constants.ts, src/lib/websocket-client.ts</files>
  <action>
**src/config/constants.ts 추가:**
```typescript
export const WEBSOCKET_CONFIG = {
  RECONNECT_INTERVAL: 3000,     // 재연결 시도 간격 (ms)
  MAX_RECONNECT_ATTEMPTS: 10,   // 최대 재연결 시도 횟수
  HEARTBEAT_INTERVAL: 30000,    // heartbeat 간격 (ms)
  HEARTBEAT_TIMEOUT: 5000,      // heartbeat 응답 타임아웃 (ms)
} as const;
```

**src/lib/websocket-client.ts:**
클라이언트 측 WebSocket 유틸리티:
- `getWebSocketUrl()` - 현재 호스트 기반 ws:// 또는 wss:// URL 생성
- `createMessage<T>(type, payload)` - 타입 안전한 메시지 생성
- `parseMessage(data)` - 수신 메시지 파싱 및 Zod 검증

HTTPS 환경에서 wss:// 사용, HTTP에서 ws:// 사용 자동 감지
  </action>
  <verify>
- `npx tsc --noEmit` TypeScript 오류 없음
- constants.ts에 WEBSOCKET_CONFIG export 확인
  </verify>
  <done>WebSocket 상수 및 클라이언트 유틸리티 구현 완료</done>
</task>

<task type="auto">
  <name>Task 2: useWebSocket 훅 구현 (재연결 + heartbeat)</name>
  <files>src/hooks/useWebSocket.ts</files>
  <action>
React 훅 구현:

```typescript
export function useWebSocket<T = unknown>(options?: UseWebSocketOptions) {
  // 반환값:
  // - connectionStatus: 'connecting' | 'connected' | 'disconnected' | 'error'
  // - lastMessage: WSServerMessage<T> | null
  // - sendMessage: (msg: WSClientMessage) => void
  // - reconnect: () => void
}
```

**핵심 기능:**
1. **자동 재연결**: 연결 끊김 시 exponential backoff로 재연결
   - 첫 시도: 3초 후
   - 이후: 3초 × 2^(시도횟수), 최대 30초
   - MAX_RECONNECT_ATTEMPTS 초과 시 중단

2. **Heartbeat 메커니즘**:
   - HEARTBEAT_INTERVAL마다 ping 전송
   - HEARTBEAT_TIMEOUT 내 pong 미수신 시 연결 재시도

3. **메시지 핸들링**:
   - onMessage 콜백으로 타입별 메시지 처리
   - 메시지 히스토리 유지 (최근 N개)

4. **정리(Cleanup)**:
   - 컴포넌트 언마운트 시 연결 종료
   - 타이머 정리

useEffect 의존성 배열 주의 - WebSocket 인스턴스를 ref로 관리
  </action>
  <verify>
- `npm run dev` 후 브라우저에서 훅 테스트
- 연결/재연결 동작 콘솔 로그 확인
- 네트워크 끊김 시뮬레이션 후 재연결 확인
  </verify>
  <done>useWebSocket 훅 구현, 재연결 및 heartbeat 동작 확인</done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>WebSocket 클라이언트 인프라 (useWebSocket 훅, 재연결 로직, heartbeat)</what-built>
  <how-to-verify>
1. Run: `npm run dev`
2. 브라우저 개발자 도구 콘솔에서 테스트:
   ```javascript
   // WebSocket 연결 테스트
   const ws = new WebSocket('ws://localhost:3000/api/ws');
   ws.onopen = () => console.log('Connected!');
   ws.onmessage = (e) => console.log('Message:', e.data);
   ws.onerror = (e) => console.log('Error:', e);
   ```
3. 서버 터미널에서 "[WS] Client connected" 로그 확인
4. 브라우저에서 "Connected!" 메시지 확인
5. 연결 유지 30초 후 heartbeat 메시지 교환 확인
  </how-to-verify>
  <resume-signal>Type "approved" or describe issues to fix</resume-signal>
</task>

</tasks>

<verification>
Phase 9 전체 완료 전 확인:
- [ ] `npm run build` 성공
- [ ] WebSocket 연결 수립 성공
- [ ] 재연결 로직 동작 (네트워크 끊김 시뮬레이션)
- [ ] heartbeat ping/pong 동작
- [ ] TypeScript 오류 없음
</verification>

<success_criteria>

- useWebSocket 훅 구현 완료
- 자동 재연결 (exponential backoff) 동작
- heartbeat 메커니즘 동작
- 타입 안전한 메시지 송수신
- 빌드 성공
- Phase 9 complete
</success_criteria>

<output>
완료 후 `.planning/phases/09-websocket-infrastructure/09-02-SUMMARY.md` 생성:

# Phase 9 Plan 02: WebSocket Client Hook Summary

**[요약 한 줄]**

## Accomplishments
## Files Created/Modified
## Decisions Made
## Issues Encountered
## Next Phase Readiness
Phase 10 (Real-time Metrics) 준비 완료 - useWebSocket 훅으로 메트릭 스트리밍 구현 가능
</output>
