---
phase: 09-websocket-infrastructure
plan: 01
type: execute
depends_on: []
files_modified: [package.json, src/lib/websocket-server.ts, src/app/api/ws/route.ts, src/types/websocket.ts]
---

<objective>
WebSocket 서버 인프라 구축 - ws 라이브러리와 next-ws를 사용해 Next.js App Router에서 WebSocket 연결을 처리할 수 있는 기반을 구축합니다.

Purpose: 기존 폴링 기반 실시간 업데이트를 WebSocket으로 대체하기 위한 서버측 인프라 마련
Output: 작동하는 WebSocket 서버 엔드포인트 및 연결 관리 로직
</objective>

<execution_context>
~/.claude/get-shit-done/workflows/execute-plan.md
./summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/09-websocket-infrastructure/DISCOVERY.md
@src/hooks/useSystemMetrics.ts
@src/lib/docker.ts
@src/app/api/system/route.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: ws 및 next-ws 패키지 설치 및 패치 설정</name>
  <files>package.json</files>
  <action>
1. ws와 next-ws 패키지 설치: `npm install ws next-ws`
2. @types/ws 타입 설치: `npm install -D @types/ws`
3. package.json scripts에 prepare 스크립트 추가:
   ```json
   "prepare": "next-ws patch"
   ```
4. `npm run prepare` 실행하여 Next.js 패치 적용

주의: next-ws는 Next.js 설치를 패치해야 UPGRADE 핸들러를 인식합니다.
  </action>
  <verify>
- `npm ls ws next-ws` 패키지 설치 확인
- `npm run prepare` 성공 메시지 확인
- package.json에 prepare 스크립트 존재 확인
  </verify>
  <done>ws, next-ws, @types/ws 설치 완료, prepare 스크립트 설정됨</done>
</task>

<task type="auto">
  <name>Task 2: WebSocket 타입 정의 및 서버 핵심 로직 구현</name>
  <files>src/types/websocket.ts, src/lib/websocket-server.ts</files>
  <action>
**src/types/websocket.ts:**
WebSocket 메시지 타입 정의:
- `WSMessageType` union: 'metrics', 'containers', 'container-action', 'heartbeat', 'error'
- `WSMessage<T>` 제네릭 타입: { type, payload, timestamp }
- `WSClientMessage`: 클라이언트 → 서버 (subscribe, unsubscribe, action)
- `WSServerMessage`: 서버 → 클라이언트 (data push, ack, error)

**src/lib/websocket-server.ts:**
WebSocket 서버 유틸리티:
- `connectedClients: Set<WebSocket>` - 연결된 클라이언트 추적
- `addClient(ws)` / `removeClient(ws)` - 연결 관리
- `broadcast(message)` - 모든 클라이언트에 메시지 전송
- `sendToClient(ws, message)` - 특정 클라이언트에 메시지 전송
- `handleMessage(ws, data)` - 수신 메시지 파싱 및 라우팅

Zod로 메시지 런타임 검증 (기존 패턴 활용)
  </action>
  <verify>
- `npx tsc --noEmit` TypeScript 컴파일 오류 없음
- 타입 파일 존재 및 export 확인
  </verify>
  <done>WebSocket 타입 및 서버 유틸리티 구현 완료, Zod 검증 포함</done>
</task>

<task type="auto">
  <name>Task 3: WebSocket UPGRADE 라우트 핸들러 생성</name>
  <files>src/app/api/ws/route.ts</files>
  <action>
next-ws 패턴에 따라 UPGRADE 핸들러 작성:

```typescript
export function UPGRADE(
  client: import('ws').WebSocket,
  server: import('ws').WebSocketServer
) {
  // 1. 연결 시 클라이언트 등록
  addClient(client);
  console.log('[WS] Client connected');

  // 2. 메시지 수신 핸들러
  client.on('message', (data) => {
    handleMessage(client, data);
  });

  // 3. 연결 종료 시 정리
  client.on('close', () => {
    removeClient(client);
    console.log('[WS] Client disconnected');
  });

  // 4. 에러 핸들링
  client.on('error', (err) => {
    console.error('[WS] Error:', err);
    removeClient(client);
  });

  // 5. 연결 확인 메시지 전송
  sendToClient(client, { type: 'connected', timestamp: Date.now() });
}
```

기존 인증 미들웨어와 통합 준비 (Phase 1에서 구현된 JWT 검증)
  </action>
  <verify>
- `npm run dev` 실행 후 ws://localhost:3000/api/ws 연결 테스트
- 브라우저 콘솔에서 `new WebSocket('ws://localhost:3000/api/ws')` 연결 확인
- 서버 로그에 "[WS] Client connected" 출력 확인
  </verify>
  <done>WebSocket 라우트 핸들러 작동, 연결/해제 로깅 확인</done>
</task>

</tasks>

<verification>
Phase 완료 전 확인:
- [ ] `npm run build` 성공 (WebSocket 코드 포함)
- [ ] `npm run dev` 실행 후 WebSocket 연결 테스트 성공
- [ ] TypeScript 오류 없음
- [ ] 연결/해제 시 서버 로그 출력
</verification>

<success_criteria>

- ws, next-ws 패키지 설치 및 패치 완료
- WebSocket 타입 시스템 구축
- 서버 연결 관리 로직 구현
- UPGRADE 라우트 핸들러 작동
- 빌드 성공
</success_criteria>

<output>
완료 후 `.planning/phases/09-websocket-infrastructure/09-01-SUMMARY.md` 생성:

# Phase 9 Plan 01: WebSocket Server Infrastructure Summary

**[요약 한 줄]**

## Accomplishments
## Files Created/Modified
## Decisions Made
## Issues Encountered
## Next Step
Ready for 09-02-PLAN.md (클라이언트 훅 구현)
</output>
