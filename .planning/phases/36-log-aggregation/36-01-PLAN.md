---
phase: 36-log-aggregation
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/types/log.ts
  - prisma/schema.prisma
  - src/lib/log-storage.ts
autonomous: true

must_haves:
  truths:
    - "LogEntry 타입이 정의되어 다른 모듈에서 import 가능"
    - "Prisma LogEntry 모델이 DB에 생성됨"
    - "LogStorage 서비스로 로그 저장/조회/삭제 가능"
  artifacts:
    - path: "src/types/log.ts"
      provides: "로그 엔트리 Zod 스키마 및 타입"
      exports: ["LogEntrySchema", "LogEntry", "LogLevel", "LogSource"]
    - path: "prisma/schema.prisma"
      provides: "LogEntry 데이터베이스 모델"
      contains: "model LogEntry"
    - path: "src/lib/log-storage.ts"
      provides: "로그 저장소 서비스"
      exports: ["LogStorage", "logStorage"]
  key_links:
    - from: "src/lib/log-storage.ts"
      to: "prisma.logEntry"
      via: "Prisma CRUD 메서드"
      pattern: "prisma\\.logEntry\\.(create|findMany|deleteMany)"
---

<objective>
로그 수집 시스템의 기반 인프라 구축 — 타입 정의, 데이터베이스 모델, 저장소 서비스

Purpose: Phase 36-37의 로그 수집/뷰어 기능을 위한 데이터 계층 준비
Output: 로그 타입, Prisma 모델, LogStorage 서비스
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/36-log-aggregation/36-RESEARCH.md

@src/types/websocket.ts
@prisma/schema.prisma
@src/lib/docker.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: 로그 타입 정의 (Zod 스키마)</name>
  <files>src/types/log.ts</files>
  <action>
    로그 엔트리를 위한 Zod 스키마 및 TypeScript 타입 정의:

    1. LogLevel enum: 'trace' | 'debug' | 'info' | 'warn' | 'error' | 'fatal'
    2. LogSource enum: 'docker' | 'journal' | 'app'
    3. LogEntrySchema:
       - id: string (UUID)
       - source: LogSource
       - sourceId: string (container id, unit name, file path)
       - level: LogLevel
       - message: string
       - timestamp: Date
       - metadata: Record<string, unknown> (optional)
    4. LogQuerySchema (조회 파라미터):
       - sources: LogSource[] (optional)
       - levels: LogLevel[] (optional)
       - sourceId: string (optional)
       - search: string (optional)
       - startTime: Date (optional)
       - endTime: Date (optional)
       - limit: number (default 100)
       - offset: number (default 0)

    기존 websocket.ts의 Zod 패턴 따르기.
    모든 타입 export.
  </action>
  <verify>npx tsc --noEmit 성공</verify>
  <done>LogEntrySchema, LogQuerySchema 등 모든 타입이 정의되고 export됨</done>
</task>

<task type="auto">
  <name>Task 2: Prisma LogEntry 모델 추가</name>
  <files>prisma/schema.prisma</files>
  <action>
    기존 schema.prisma에 LogEntry 모델 추가:

    ```prisma
    model LogEntry {
      id        String   @id @default(uuid())
      source    String   // docker, journal, app
      sourceId  String   // container id, unit name, file path
      level     String   // trace, debug, info, warn, error, fatal
      message   String
      timestamp DateTime @default(now())
      metadata  String?  // JSON string (optional)
      createdAt DateTime @default(now())

      @@index([source, timestamp])
      @@index([level, timestamp])
      @@index([timestamp])
      @@index([sourceId])
    }
    ```

    인덱스 설명:
    - [source, timestamp]: 소스별 시간순 조회
    - [level, timestamp]: 레벨별 시간순 조회
    - [timestamp]: 전체 시간순 조회
    - [sourceId]: 특정 소스(컨테이너 등) 조회

    마이그레이션 실행: npx prisma migrate dev --name add-log-entry
  </action>
  <verify>npx prisma migrate dev --name add-log-entry 성공, npx prisma generate 성공</verify>
  <done>LogEntry 모델이 DB에 생성되고 Prisma Client 타입 업데이트됨</done>
</task>

<task type="auto">
  <name>Task 3: LogStorage 서비스 구현</name>
  <files>src/lib/log-storage.ts</files>
  <action>
    로그 저장소 서비스 클래스 구현:

    1. LogStorage 클래스:
       ```typescript
       class LogStorage {
         constructor(private prisma: PrismaClient) {}

         // 단일 로그 저장
         async write(entry: Omit<LogEntry, 'id' | 'createdAt'>): Promise<void>

         // 배치 로그 저장 (성능 최적화)
         async writeBatch(entries: Omit<LogEntry, 'id' | 'createdAt'>[]): Promise<void>

         // 로그 조회 (필터링, 페이지네이션)
         async query(params: LogQuery): Promise<{ logs: LogEntry[]; total: number }>

         // 보존 기간 지난 로그 정리 (default 7일)
         async cleanup(retentionDays?: number): Promise<number>

         // 통계 조회 (소스별 카운트)
         async getStats(): Promise<{ source: string; count: number }[]>
       }
       ```

    2. 싱글톤 인스턴스 export: `export const logStorage = new LogStorage(prisma)`

    3. metadata 필드는 JSON.stringify/parse로 처리

    기존 서비스 패턴(github-service.ts 등) 참고.
    에러 핸들링은 기존 AppError 패턴 사용.
  </action>
  <verify>
    테스트 코드 작성 또는 수동 테스트:
    - write() 호출 후 DB에 레코드 확인
    - query() 호출 시 필터링 동작 확인
    - cleanup() 호출 시 오래된 레코드 삭제 확인
  </verify>
  <done>LogStorage 서비스가 모든 CRUD 및 retention 기능 제공</done>
</task>

</tasks>

<verification>
Plan 완료 전 확인:
- [ ] `npx tsc --noEmit` 성공 (타입 에러 없음)
- [ ] `npx prisma migrate dev` 성공 (DB 마이그레이션)
- [ ] LogStorage 서비스 import 가능
- [ ] 기본 write/query 동작 테스트
</verification>

<success_criteria>
- 모든 태스크 완료
- LogEntry 타입이 다른 모듈에서 사용 가능
- Prisma LogEntry 모델 DB에 생성됨
- LogStorage 서비스로 로그 저장/조회/삭제 가능
- 기존 코드에 영향 없음
</success_criteria>

<output>
완료 후 `.planning/phases/36-log-aggregation/36-01-SUMMARY.md` 생성
</output>
