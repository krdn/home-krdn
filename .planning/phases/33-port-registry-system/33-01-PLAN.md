---
phase: 33-port-registry-system
plan: 01
type: execute
depends_on: []
files_modified: [prisma/schema.prisma, src/lib/port-service.ts, src/types/port.ts]
---

<objective>
Port Registry 데이터베이스 모델 및 서비스 레이어 구현

Purpose: 포트 등록 정보를 저장할 DB 모델과 비즈니스 로직을 제공하는 서비스 레이어를 구축합니다.
Output: Prisma PortRegistry 모델, port-service.ts, 타입 정의
</objective>

<execution_context>
~/.claude/get-shit-done/workflows/execute-plan.md
./summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@prisma/schema.prisma
@src/lib/team-service.ts

**Tech stack available:** Prisma 7, SQLite, Zod, TypeScript
**Established patterns:** Service Layer (DTO 변환, Zod 검증), Prisma 모델 (cuid, timestamps)
</context>

<tasks>

<task type="auto">
  <name>Task 1: Prisma PortRegistry 모델 추가</name>
  <files>prisma/schema.prisma</files>
  <action>
스키마 파일 끝에 PortRegistry 모델 추가:

```prisma
// Port Registry 모델 (Phase 33)
model PortRegistry {
  id          String  @id @default(cuid())

  // 포트 정보
  port        Int     @unique
  protocol    String  @default("tcp")  // tcp, udp

  // 프로젝트 정보
  projectId   String?                   // 연결된 프로젝트 ID (nullable - 수동 등록 시)
  projectName String                    // 프로젝트/서비스 이름
  description String?                   // 포트 용도 설명

  // 환경 및 상태
  environment String  @default("development")  // development, staging, production
  status      String  @default("active")       // active, reserved, deprecated

  // URL 정보
  internalUrl String?                   // 내부 접근 URL (예: http://localhost:3000)
  externalUrl String?                   // 외부 접근 URL (예: https://app.example.com)

  // 메타데이터
  category    String?                   // ai, web, n8n, system 등
  tags        String?                   // JSON 배열 문자열로 저장

  // 타임스탬프
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  // 등록자 (선택)
  createdById String?
  createdBy   User?    @relation(fields: [createdById], references: [id], onDelete: SetNull)

  // 인덱스
  @@index([projectId])
  @@index([category])
  @@index([status])
}
```

User 모델에 관계 추가 (기존 User 모델 내):
```prisma
// 관계: 포트 레지스트리 (Phase 33)
portRegistries PortRegistry[]
```

주의: SQLite는 native enum을 지원하지 않으므로 String으로 protocol, environment, status를 저장합니다.
  </action>
  <verify>npx prisma validate && npx prisma generate</verify>
  <done>Prisma 스키마 검증 통과, 타입 생성 완료</done>
</task>

<task type="auto">
  <name>Task 2: 타입 정의 및 Zod 스키마 생성</name>
  <files>src/types/port.ts</files>
  <action>
포트 레지스트리 관련 타입과 검증 스키마를 정의합니다:

1. **PortRegistryDto** - 클라이언트 반환용 DTO
2. **CreatePortInput/UpdatePortInput** - 입력 타입
3. **Zod 검증 스키마** - 입력 검증

프로토콜: tcp, udp
환경: development, staging, production
상태: active, reserved, deprecated

포트 범위 검증: 1-65535 (well-known 포트 1-1023 경고만)
  </action>
  <verify>TypeScript 컴파일 에러 없음 (npx tsc --noEmit)</verify>
  <done>타입 정의 파일 생성, Zod 스키마 export</done>
</task>

<task type="auto">
  <name>Task 3: Port Service Layer 구현</name>
  <files>src/lib/port-service.ts</files>
  <action>
team-service.ts 패턴을 따라 포트 레지스트리 서비스 구현:

1. **CRUD 함수**:
   - createPort(input, userId?) → PortRegistryDto
   - getPortById(id) → PortRegistryDto | null
   - getPortByNumber(port) → PortRegistryDto | null
   - updatePort(id, input) → PortRegistryDto
   - deletePort(id) → void
   - getAllPorts(filters?) → PortRegistryDto[]

2. **충돌 감지**:
   - checkPortConflict(port) → boolean
   - findAvailablePort(start, end) → number | null

3. **범위 조회**:
   - getPortsByCategory(category) → PortRegistryDto[]
   - getPortsByEnvironment(env) → PortRegistryDto[]
   - getPortsByProject(projectId) → PortRegistryDto[]

4. **벌크 작업**:
   - importPorts(ports[]) → { created: number, conflicts: string[] }

DTO 변환 함수 toPortRegistryDto() 필수 구현.
에러 처리: 포트 중복 시 명확한 에러 메시지.
  </action>
  <verify>서비스 함수 import 후 타입 체크 통과</verify>
  <done>port-service.ts 완성, 모든 함수 export</done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] `npx prisma validate` 성공
- [ ] `npx prisma generate` 성공
- [ ] `npx prisma db push` 마이그레이션 성공
- [ ] `npx tsc --noEmit` 타입 에러 없음
- [ ] port-service.ts 모든 함수 정상 export
</verification>

<success_criteria>

- Prisma 스키마에 PortRegistry 모델 추가됨
- DB 마이그레이션 완료 (SQLite)
- src/types/port.ts 타입 정의 완료
- src/lib/port-service.ts 서비스 레이어 구현 완료
- 포트 충돌 감지 로직 포함
</success_criteria>

<output>
After completion, create `.planning/phases/33-port-registry-system/33-01-SUMMARY.md`
</output>
