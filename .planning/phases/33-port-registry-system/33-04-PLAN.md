---
phase: 33-port-registry-system
plan: 04
subsystem: port-reservation
tags: [port-management, recommendation, reservation, api, ui, navigation]

# Dependency graph
requires:
  - phase: 33-03
    provides: [Port Registry Management UI, usePorts hooks, PortList/PortForm components]
provides:
  - 카테고리별 포트 범위 상수 (PORT_CATEGORY_RANGES, PORT_ENVIRONMENT_OFFSET)
  - 포트 추천 API (/api/ports/recommend)
  - 포트 추천 훅 (usePortRecommendation)
  - 빠른 예약 컴포넌트 (PortQuickReserve)
  - 공개 Ports 페이지 (/ports)
  - Services 포트 자동 동기화
affects: [port-management, navigation, services-integration]

# Tech tracking
tech-stack:
  added: []
  patterns: [Category-based port allocation, Environment offset system, Smart port recommendation]
---

# Phase 33-04: Port Reservation & Recommendation System

## Goal

신규 프로젝트 개발 시작 시 미사용 포트를 쉽게 예약하고, 카테고리/환경에 맞는 포트를 자동 추천하는 기능 구현

## Context

### 문제점
- 신규 프로젝트 시작 시 수동으로 포트 충돌 여부를 확인해야 함
- 카테고리별 권장 포트 범위가 명확하지 않음
- 개발/스테이징/프로덕션 환경 구분이 어려움

### 해결책
- 카테고리별 표준 포트 범위 정의
- 환경별 오프셋 시스템으로 자동 구분
- 빠른 예약 UI로 즉시 포트 확보

## Tasks

### Task 1: 카테고리별 포트 범위 상수 정의
**Goal:** 표준화된 포트 할당 정책 구현

**Files:**
- `src/types/port.ts` - PORT_CATEGORY_RANGES, PORT_ENVIRONMENT_OFFSET 상수 추가

**Details:**
```typescript
// 카테고리별 기본 범위
PORT_CATEGORY_RANGES = {
  ai: { start: 8000, end: 8099 },
  web: { start: 3000, end: 3099 },
  n8n: { start: 5600, end: 5699 },
  system: { start: 9000, end: 9099 },
  database: { start: 5400, end: 5499 },
  monitoring: { start: 9100, end: 9199 },
  other: { start: 10000, end: 10099 },
}

// 환경별 오프셋
PORT_ENVIRONMENT_OFFSET = {
  development: 0,
  staging: 100,
  production: 200,
}
```

**Commit:** `feat(33): 카테고리별 포트 범위 상수 정의`

---

### Task 2: 포트 추천 서비스 함수 구현
**Goal:** 카테고리/환경 기반 사용 가능한 포트 추천 로직

**Files:**
- `src/lib/port-service.ts` - recommendPort, getPortUsageByCategory 함수 추가

**Details:**
- `recommendPort(category, environment)`: 해당 범위에서 사용 가능한 첫 번째 포트 + 대안 3개 반환
- `getPortUsageByCategory()`: 전체 카테고리별 사용 현황 조회

**Commit:** `feat(33): 포트 추천 서비스 함수 구현`

---

### Task 3: 포트 추천 API 엔드포인트
**Goal:** REST API로 포트 추천 기능 노출

**Files:**
- `src/app/api/ports/recommend/route.ts` - GET /api/ports/recommend

**Details:**
- Query params: `category`, `environment`
- 카테고리 없으면 전체 사용 현황 반환
- 카테고리 있으면 추천 포트 + 대안 포트 반환

**Commit:** `feat(33): 포트 추천 API 엔드포인트 추가`

---

### Task 4: 포트 추천 React Query 훅
**Goal:** 클라이언트에서 포트 추천 API 사용

**Files:**
- `src/hooks/usePorts.ts` - usePortRecommendation 훅 추가

**Details:**
- `usePortRecommendation(category?, environment?)` 훅
- 10초 staleTime으로 캐싱
- recommendation, usage, ranges 반환

**Commit:** `feat(33): 포트 추천 훅 구현`

---

### Task 5: 빠른 예약 컴포넌트
**Goal:** 신규 프로젝트를 위한 빠른 포트 예약 UI

**Files:**
- `src/components/ports/PortQuickReserve.tsx` - 빠른 예약 컴포넌트

**Details:**
- 카테고리/환경 선택 → 추천 포트 표시
- 포트 선택 → 프로젝트 이름 입력 → 예약
- 카테고리별 사용 현황 대시보드
- 포트 번호 복사 기능

**Commit:** `feat(33): 빠른 포트 예약 컴포넌트 구현`

---

### Task 6: 공개 Ports 페이지 및 탭 UI
**Goal:** 포트 목록과 빠른 예약을 탭으로 통합

**Files:**
- `src/app/ports/page.tsx` - 페이지 수정
- `src/app/ports/PortsContent.tsx` - 탭 기반 클라이언트 컴포넌트

**Details:**
- "포트 목록" 탭: 기존 PortList (readOnly)
- "빠른 예약" 탭: PortQuickReserve 컴포넌트

**Commit:** `feat(33): Ports 페이지 탭 UI 통합`

---

### Task 7: 네비게이션 메뉴 추가
**Goal:** Header/Sidebar에 Ports 메뉴 추가

**Files:**
- `src/components/layout/Header.tsx` - Ports 메뉴 추가
- `src/components/layout/Sidebar.tsx` - Admin Sidebar에 Ports 추가

**Details:**
- 메인 네비게이션: /ports (공개)
- Admin 사이드바: /admin/ports (관리자)

**Commit:** `feat(33): 네비게이션에 Ports 메뉴 추가`

---

### Task 8: Services 포트 자동 동기화
**Goal:** Services 생성/동기화 시 Port Registry 자동 등록

**Files:**
- `src/lib/port-service.ts` - syncServicePort, syncAllServicesPorts 함수
- `src/lib/services.ts` - createService에 자동 등록 로직 추가
- `src/app/api/ports/sync/route.ts` - 동기화 API

**Details:**
- 서비스 생성 시 포트가 있으면 자동 등록
- POST /api/ports/sync로 전체 동기화

**Commit:** `feat(33): Services 포트 자동 동기화 기능`

---

### Task 9: 공개 API 접근 허용
**Goal:** Ports 목록 조회를 인증 없이 허용

**Files:**
- `src/app/api/ports/route.ts` - GET 요청 인증 제거
- `src/components/ports/PortList.tsx` - readOnly prop 추가

**Details:**
- GET /api/ports는 공개 (누구나 조회 가능)
- POST/PATCH/DELETE는 ADMIN 권한 필요
- PortList에 readOnly 모드 추가

**Commit:** `feat(33): 포트 목록 공개 조회 허용`

---

## Verification

- [ ] `/ports` 페이지 접속 확인
- [ ] 카테고리 선택 시 추천 포트 표시 확인
- [ ] 포트 예약 후 목록에 표시 확인
- [ ] Header/Sidebar에 Ports 메뉴 표시 확인
- [ ] Services 생성 시 포트 자동 등록 확인
- [ ] 빌드 성공 확인

## Dependencies

- Phase 33-03: Port Registry Management UI 완료 필요

## Risks

- 포트 범위 충돌: 기존에 등록된 포트와 새 범위 정책 충돌 가능
  - Mitigation: 범위 외 기존 포트는 유지, 신규만 범위 내 추천
