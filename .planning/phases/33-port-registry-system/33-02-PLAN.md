---
phase: 33-port-registry-system
plan: 02
type: execute
depends_on: ["33-01"]
files_modified: [src/app/api/ports/route.ts, src/app/api/ports/[id]/route.ts, src/app/api/ports/check/route.ts]
---

<objective>
Port Registry REST API 엔드포인트 구현

Purpose: 포트 레지스트리 CRUD 및 충돌 검사를 위한 API 라우트를 제공합니다.
Output: /api/ports 엔드포인트, 충돌 검사 API
</objective>

<execution_context>
~/.claude/get-shit-done/workflows/execute-plan.md
./summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/33-port-registry-system/33-01-SUMMARY.md
@src/lib/port-service.ts
@src/lib/auth.ts
@src/lib/rbac.ts

**Tech stack available:** Next.js 16 App Router, Zod, RBAC
**Established patterns:** API Route (NextResponse, try-catch, 에러 핸들링), RBAC 미들웨어
</context>

<tasks>

<task type="auto">
  <name>Task 1: 포트 목록/생성 API 구현</name>
  <files>src/app/api/ports/route.ts</files>
  <action>
/api/ports 엔드포인트 구현:

**GET /api/ports**
- 쿼리 파라미터: category, environment, status, projectId
- 인증 필요 (VIEWER 이상)
- 응답: { success: true, ports: PortRegistryDto[] }

**POST /api/ports**
- Body: CreatePortInput (Zod 검증)
- 인증 필요 (ADMIN만)
- 포트 중복 검사 후 생성
- 응답: { success: true, port: PortRegistryDto }
- 에러: 409 Conflict (포트 중복)

기존 에러 핸들링 패턴 사용 (handleApiError from @/lib/errors).
RBAC 권한 검사: requireRole() 미들웨어 사용.
  </action>
  <verify>curl -X GET localhost:3000/api/ports (인증 필요 응답 확인)</verify>
  <done>GET/POST /api/ports 엔드포인트 동작</done>
</task>

<task type="auto">
  <name>Task 2: 포트 상세/수정/삭제 API 구현</name>
  <files>src/app/api/ports/[id]/route.ts</files>
  <action>
/api/ports/[id] 동적 라우트 구현:

**GET /api/ports/[id]**
- 인증 필요 (VIEWER 이상)
- 응답: { success: true, port: PortRegistryDto }
- 에러: 404 Not Found

**PATCH /api/ports/[id]**
- Body: UpdatePortInput (Zod 검증)
- 인증 필요 (ADMIN만)
- 포트 번호 변경 시 중복 검사
- 응답: { success: true, port: PortRegistryDto }

**DELETE /api/ports/[id]**
- 인증 필요 (ADMIN만)
- 응답: { success: true, message: "포트가 삭제되었습니다" }

params는 Next.js 16 방식으로 비동기 처리: const { id } = await params
  </action>
  <verify>각 HTTP 메서드 엔드포인트 호출 가능</verify>
  <done>GET/PATCH/DELETE /api/ports/[id] 엔드포인트 동작</done>
</task>

<task type="auto">
  <name>Task 3: 포트 충돌 검사 API 구현</name>
  <files>src/app/api/ports/check/route.ts</files>
  <action>
/api/ports/check 유틸리티 엔드포인트:

**GET /api/ports/check?port=3000**
- 쿼리: port (필수), excludeId (선택 - 수정 시 자기 자신 제외)
- 인증 필요 (USER 이상)
- 응답: { available: boolean, conflict?: PortRegistryDto }

**POST /api/ports/check/range**
- Body: { start: number, end: number }
- 인증 필요 (USER 이상)
- 범위 내 사용 가능한 포트 찾기
- 응답: { availablePort: number | null }

이 API는 UI에서 실시간 충돌 검사에 사용됩니다.
  </action>
  <verify>GET /api/ports/check?port=3000 응답 확인</verify>
  <done>포트 충돌 검사 API 동작, 실시간 검증 가능</done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] GET /api/ports 필터링 동작
- [ ] POST /api/ports 포트 생성 동작
- [ ] GET/PATCH/DELETE /api/ports/[id] 동작
- [ ] GET /api/ports/check 충돌 검사 동작
- [ ] RBAC 권한 검사 정상 동작
- [ ] 에러 응답 형식 일관성 (success, error)
</verification>

<success_criteria>

- /api/ports CRUD 엔드포인트 완성
- /api/ports/check 충돌 검사 API 완성
- RBAC 권한 검사 적용 (ADMIN: 생성/수정/삭제, VIEWER: 조회)
- Zod 입력 검증 적용
- 적절한 HTTP 상태 코드 반환
</success_criteria>

<output>
After completion, create `.planning/phases/33-port-registry-system/33-02-SUMMARY.md`
</output>
