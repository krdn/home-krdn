# Phase 39-01: Kubernetes Prisma 모델 + Service Layer

## 목표

Kubernetes API 연동을 위한 데이터베이스 모델과 서비스 레이어 구현

## 작업 항목

### 1. Prisma 모델 추가

**prisma/schema.prisma**에 `KubernetesCluster` 모델 추가:

```prisma
// Kubernetes 클러스터 설정 모델 (Phase 39)
model KubernetesCluster {
  id   String @id @default(cuid())
  name String // 클러스터 표시 이름

  // 사용자 연결 (N:1 - 한 사용자가 여러 클러스터 가능)
  userId String
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  // 클러스터 연결 정보
  server        String  // API 서버 URL (https://...)
  caData        String? // Base64 인코딩된 CA 인증서
  skipTLSVerify Boolean @default(false)

  // 인증 정보 (토큰 또는 인증서)
  authType          String  @default("token") // token, certificate
  token             String? // Bearer 토큰 (암호화 저장)
  clientCertificate String? // 클라이언트 인증서
  clientKey         String? // 클라이언트 키

  // 기본 namespace
  defaultNamespace String @default("default")

  // 상태
  isActive Boolean @default(true)

  // 타임스탬프
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // 인덱스
  @@index([userId])
  @@unique([userId, name]) // 사용자별 클러스터 이름 유일
}
```

**User 모델에 관계 추가**:
```prisma
// 관계: Kubernetes 클러스터 (Phase 39)
kubernetesClusters KubernetesCluster[]
```

### 2. 마이그레이션 실행

```bash
npx prisma db push
```

### 3. Zod 타입 정의

**src/types/kubernetes.ts** 생성:

```typescript
import { z } from 'zod';

// Auth Type enum
export const AuthTypeSchema = z.enum(['token', 'certificate']);
export type AuthType = z.infer<typeof AuthTypeSchema>;

// Kubernetes Cluster 입력 스키마
export const CreateKubernetesClusterInputSchema = z.object({
  name: z.string().min(1).max(100),
  server: z.string().url(),
  caData: z.string().optional(),
  skipTLSVerify: z.boolean().optional().default(false),
  authType: AuthTypeSchema.optional().default('token'),
  token: z.string().optional(),
  clientCertificate: z.string().optional(),
  clientKey: z.string().optional(),
  defaultNamespace: z.string().optional().default('default'),
});

// DTO 스키마 (토큰 값 미노출)
export const KubernetesClusterDtoSchema = z.object({
  id: z.string(),
  name: z.string(),
  server: z.string(),
  skipTLSVerify: z.boolean(),
  authType: AuthTypeSchema,
  hasToken: z.boolean(),
  hasCertificate: z.boolean(),
  defaultNamespace: z.string(),
  isActive: z.boolean(),
  createdAt: z.date(),
  updatedAt: z.date(),
});

// Kubernetes 리소스 스키마
export const K8sNamespaceSchema = z.object({
  name: z.string(),
  status: z.string(),
  createdAt: z.string().optional(),
  labels: z.record(z.string()).optional(),
});

export const K8sPodSchema = z.object({
  name: z.string(),
  namespace: z.string(),
  status: z.string(),
  phase: z.string(),
  nodeName: z.string().optional(),
  podIP: z.string().optional(),
  containers: z.array(z.object({
    name: z.string(),
    image: z.string(),
    ready: z.boolean(),
    restartCount: z.number(),
  })),
  createdAt: z.string().optional(),
});

export const K8sServiceSchema = z.object({
  name: z.string(),
  namespace: z.string(),
  type: z.string(),
  clusterIP: z.string().optional(),
  externalIP: z.string().optional(),
  ports: z.array(z.object({
    name: z.string().optional(),
    port: z.number(),
    targetPort: z.union([z.number(), z.string()]),
    protocol: z.string(),
  })),
  createdAt: z.string().optional(),
});

export const K8sDeploymentSchema = z.object({
  name: z.string(),
  namespace: z.string(),
  replicas: z.number(),
  readyReplicas: z.number(),
  availableReplicas: z.number(),
  updatedReplicas: z.number(),
  strategy: z.string(),
  createdAt: z.string().optional(),
});

// 타입 추출
export type CreateKubernetesClusterInput = z.infer<typeof CreateKubernetesClusterInputSchema>;
export type KubernetesClusterDto = z.infer<typeof KubernetesClusterDtoSchema>;
export type K8sNamespace = z.infer<typeof K8sNamespaceSchema>;
export type K8sPod = z.infer<typeof K8sPodSchema>;
export type K8sService = z.infer<typeof K8sServiceSchema>;
export type K8sDeployment = z.infer<typeof K8sDeploymentSchema>;
```

### 4. Service Layer 구현

**src/lib/kubernetes-service.ts** 생성:

```typescript
/**
 * Kubernetes Service
 * @kubernetes/client-node 기반 Kubernetes API 클라이언트
 *
 * Phase 39: Kubernetes Discovery
 */

import * as k8s from '@kubernetes/client-node';
import prisma from '@/lib/prisma';
// ... 구현
```

주요 함수:
- `getKubeConfigForCluster(clusterId)`: KubeConfig 인스턴스 생성
- `getClusters(userId)`: 사용자의 클러스터 목록
- `createCluster(userId, input)`: 클러스터 추가
- `updateCluster(clusterId, input)`: 클러스터 수정
- `deleteCluster(clusterId)`: 클러스터 삭제
- `validateClusterConnection(clusterId)`: 연결 테스트
- `getNamespaces(clusterId)`: 네임스페이스 목록
- `getPods(clusterId, namespace)`: Pod 목록
- `getServices(clusterId, namespace)`: Service 목록
- `getDeployments(clusterId, namespace)`: Deployment 목록

## 완료 조건

- [ ] Prisma 모델 추가 및 마이그레이션
- [ ] Zod 타입 정의 완료
- [ ] kubernetes-service.ts 구현
- [ ] 빌드 에러 없음

## 의존성

```bash
npm install @kubernetes/client-node
```
