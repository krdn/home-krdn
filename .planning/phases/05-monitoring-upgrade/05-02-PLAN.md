# Plan 05-02: 히스토리 저장 및 조회 기능

## Objective

시스템 메트릭 히스토리를 메모리에 저장하고 시간대별 조회 기능을 제공하여 시스템 상태 추이를 파악할 수 있게 합니다.

## Execution Context

**Codebase context:**
- `src/lib/system.ts` - 시스템 메트릭 수집
- `src/app/api/system/route.ts` - 시스템 API
- `src/hooks/useSystemMetrics.ts` - 클라이언트 훅

**Dependencies:**
- 05-01 완료 (확장된 메트릭 수집)

**Architecture decision:**
- **In-memory storage**: 서버 재시작 시 초기화 (단순성 우선)
- 향후 SQLite/Redis 마이그레이션 고려 (Phase 6+)

## Context

Phase 5: Monitoring Upgrade의 두 번째 계획입니다.

**현재 상태:**
- 실시간 메트릭만 제공
- 과거 데이터 없음
- 추이 파악 불가

**추가 기능:**
- 메트릭 히스토리 저장 (최근 1시간, 1분 간격)
- 시간 범위 조회 API
- 히스토리 데이터 훅

## Tasks

### Task 1: 메트릭 히스토리 스토어 생성

**File:** `src/lib/metricsHistory.ts` (신규)

**Changes:**
1. `MetricsSnapshot` 타입 정의 (timestamp + 주요 메트릭)
2. `MetricsHistoryStore` 클래스 구현
   - 싱글톤 패턴
   - 최대 60개 스냅샷 (1시간, 1분 간격)
   - 순환 버퍼 방식
3. `addSnapshot()`, `getHistory()`, `getLatest()` 메서드

**Implementation:**
```typescript
export interface MetricsSnapshot {
  timestamp: number;
  cpu: number;
  memory: number;
  disk: number;
  networkRx: number;
  networkTx: number;
}

class MetricsHistoryStore {
  private snapshots: MetricsSnapshot[] = [];
  private readonly maxSize = 60;

  addSnapshot(snapshot: MetricsSnapshot): void { /* ... */ }
  getHistory(minutes?: number): MetricsSnapshot[] { /* ... */ }
  getLatest(): MetricsSnapshot | null { /* ... */ }
}

export const metricsHistory = new MetricsHistoryStore();
```

**Commit:** `feat(05-02): 메트릭 히스토리 스토어 생성`

### Task 2: 히스토리 수집 스케줄러 구현

**File:** `src/lib/metricsScheduler.ts` (신규)

**Changes:**
1. 1분 간격 메트릭 수집 스케줄러
2. `startMetricsCollection()`, `stopMetricsCollection()` 함수
3. 서버 시작 시 자동 실행 (API route에서 초기화)

**Implementation:**
```typescript
let intervalId: NodeJS.Timeout | null = null;

export function startMetricsCollection(): void {
  if (intervalId) return;

  // 즉시 첫 수집
  collectAndStore();

  // 1분마다 수집
  intervalId = setInterval(collectAndStore, 60000);
}
```

**Commit:** `feat(05-02): 메트릭 수집 스케줄러 구현`

### Task 3: 히스토리 API 엔드포인트 추가

**File:** `src/app/api/system/history/route.ts` (신규)

**Changes:**
1. GET `/api/system/history` 엔드포인트
2. 쿼리 파라미터: `?minutes=30` (기본값: 60)
3. 응답: 시간순 정렬된 메트릭 배열

**Implementation:**
```typescript
export async function GET(request: Request) {
  const { searchParams } = new URL(request.url);
  const minutes = parseInt(searchParams.get('minutes') || '60');

  const history = metricsHistory.getHistory(minutes);

  return NextResponse.json({
    success: true,
    data: history,
    meta: { count: history.length, minutes }
  });
}
```

**Commit:** `feat(05-02): 메트릭 히스토리 API 엔드포인트 추가`

### Task 4: 히스토리 훅 생성

**File:** `src/hooks/useMetricsHistory.ts` (신규)

**Changes:**
1. `useMetricsHistory(minutes?: number)` 훅
2. 30초마다 히스토리 데이터 갱신
3. 차트 렌더링용 데이터 포맷

**Implementation:**
```typescript
export function useMetricsHistory(minutes: number = 60) {
  const [data, setData] = useState<MetricsSnapshot[]>([]);
  const [loading, setLoading] = useState(true);

  // 30초마다 히스토리 갱신
  useEffect(() => {
    fetchHistory();
    const interval = setInterval(fetchHistory, 30000);
    return () => clearInterval(interval);
  }, [minutes]);

  return { data, loading };
}
```

**Commit:** `feat(05-02): 메트릭 히스토리 훅 생성`

### Task 5: 히스토리 스토어 테스트 작성

**File:** `src/lib/metricsHistory.test.ts` (신규)

**Changes:**
1. 스냅샷 추가/조회 테스트
2. 최대 크기 제한 테스트 (60개 초과 시 오래된 것 제거)
3. 시간 범위 필터링 테스트

**Commit:** `test(05-02): 메트릭 히스토리 스토어 테스트 추가`

## Verification

```bash
# 빌드 확인
npm run build

# 테스트 실행
npm run test

# API 동작 확인 (서버 실행 후 1분 대기)
curl -s http://localhost:3000/api/system/history?minutes=5 | jq '.data | length'
```

## Success Criteria

- [ ] 메트릭 히스토리가 1분 간격으로 자동 수집됨
- [ ] `/api/system/history` API가 시간 범위별 데이터 반환
- [ ] 히스토리 훅이 차트 렌더링용 데이터 제공
- [ ] 순환 버퍼가 60개 스냅샷으로 제한됨
- [ ] 테스트 및 빌드 성공

## Output

**New files:**
- `src/lib/metricsHistory.ts`
- `src/lib/metricsScheduler.ts`
- `src/app/api/system/history/route.ts`
- `src/hooks/useMetricsHistory.ts`
- `src/lib/metricsHistory.test.ts`

**Commits:** 5 commits (per task)

---
*Created: 2026-01-14*
