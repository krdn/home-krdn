---
phase: 21-team-features
plan: 01
type: execute
depends_on: []
files_modified: [src/lib/team-service.ts, src/app/api/teams/route.ts, src/app/api/teams/[teamId]/route.ts, src/app/api/teams/[teamId]/members/route.ts]
domain: next-js
---

<objective>
팀 서비스 레이어와 REST API 엔드포인트를 구현하여 팀 CRUD 및 멤버 관리 기반을 구축합니다.

Purpose: Phase 17에서 정의된 Team/TeamMember 모델을 활용한 서비스 레이어와 API 구현
Output: team-service.ts 서비스 파일 + /api/teams/* REST API 라우트
</objective>

<execution_context>
~/.claude/get-shit-done/workflows/execute-plan.md
./summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md

# 기존 서비스 패턴 참고
@src/lib/user-service.ts
@src/lib/settings-service.ts

# Prisma 스키마 (Team, TeamMember 모델)
@prisma/schema.prisma

# RBAC 권한 시스템
@src/lib/rbac.ts

# 기존 Phase 20 Summary
@.planning/phases/20-user-dashboard-settings/20-03-SUMMARY.md

**Tech stack available:** Prisma 7, Zod, jose JWT
**Established patterns:** Service layer (DTO 변환), REST API (Next.js App Router), Zod validation
**Constraining decisions:**
- Phase 17: Team/TeamMember Prisma 모델 정의됨
- Phase 19: RBAC 권한 매트릭스 구현됨 (hasPermission, canAccessRoute)
</context>

<tasks>

<task type="auto">
  <name>Task 1: Team Service Layer 구현</name>
  <files>src/lib/team-service.ts</files>
  <action>
Team/TeamMember 데이터 액세스 레이어 구현:

1. 타입 정의:
   - TeamDto: id, name, slug, description, ownerId, ownerUsername, memberCount, createdAt
   - TeamMemberDto: id, userId, username, displayName, role, joinedAt
   - CreateTeamInput, UpdateTeamInput (Zod 스키마)

2. 팀 CRUD 함수:
   - createTeam(ownerId, input): 팀 생성 + owner를 ADMIN 멤버로 자동 추가
   - getTeamById(teamId): 팀 조회 (멤버 수 포함)
   - getTeamBySlug(slug): slug로 팀 조회
   - updateTeam(teamId, input): 팀 정보 업데이트
   - deleteTeam(teamId): 팀 삭제 (Cascade로 멤버도 삭제)
   - getUserTeams(userId): 사용자가 속한 모든 팀 목록

3. 멤버 관리 함수:
   - addTeamMember(teamId, userId, role): 멤버 추가
   - removeTeamMember(teamId, userId): 멤버 제거
   - updateMemberRole(teamId, userId, role): 멤버 역할 변경
   - getTeamMembers(teamId): 팀 멤버 목록
   - isTeamMember(teamId, userId): 멤버 여부 확인
   - isTeamOwner(teamId, userId): 소유자 여부 확인

4. 헬퍼 함수:
   - generateTeamSlug(name): 이름에서 slug 생성 (kebab-case + 중복 시 숫자 suffix)
   - toTeamDto(team): Prisma Team → TeamDto 변환
   - toTeamMemberDto(member): Prisma TeamMember → TeamMemberDto 변환

user-service.ts 패턴 준수: Zod 스키마 내보내기, DTO 변환 함수 분리, 에러 메시지 한국어
  </action>
  <verify>npx tsc --noEmit 타입 검사 통과</verify>
  <done>team-service.ts 생성, 모든 CRUD + 멤버 관리 함수 구현, 타입 검사 통과</done>
</task>

<task type="auto">
  <name>Task 2: Team REST API 엔드포인트 구현</name>
  <files>src/app/api/teams/route.ts, src/app/api/teams/[teamId]/route.ts, src/app/api/teams/[teamId]/members/route.ts</files>
  <action>
Team REST API 구현 (Next.js App Router):

1. /api/teams (route.ts):
   - GET: 현재 사용자의 팀 목록 조회 (authenticateUserFromDB 사용)
   - POST: 새 팀 생성 (CreateTeamInput 검증)

2. /api/teams/[teamId] (route.ts):
   - GET: 팀 상세 조회 (멤버만 접근 가능)
   - PATCH: 팀 정보 수정 (owner 또는 ADMIN 멤버만)
   - DELETE: 팀 삭제 (owner만 가능)

3. /api/teams/[teamId]/members (route.ts):
   - GET: 팀 멤버 목록 조회 (멤버만 접근 가능)
   - POST: 멤버 추가 (owner 또는 ADMIN만)
   - DELETE: 멤버 제거 (owner 또는 ADMIN만, 자기 자신 제거 가능)

권한 검사 패턴:
- 모든 엔드포인트: authenticateUserFromDB로 인증 확인
- 팀 접근: isTeamMember 확인
- 관리 작업: isTeamOwner 또는 멤버 role === 'ADMIN' 확인

응답 형식: { success: true, data: ... } 또는 { success: false, error: "..." }
에러 응답: 401 (미인증), 403 (권한 없음), 404 (팀 없음), 400 (검증 실패)
  </action>
  <verify>curl 또는 Postman으로 GET /api/teams 호출 시 200 응답 (인증된 상태)</verify>
  <done>3개 API 라우트 파일 생성, 모든 HTTP 메서드 구현, 권한 검사 적용</done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] `npx tsc --noEmit` 타입 검사 통과
- [ ] `npm run build` 빌드 성공
- [ ] team-service.ts 모든 함수 구현
- [ ] API 라우트 파일 3개 생성
</verification>

<success_criteria>

- team-service.ts 서비스 레이어 완성
- /api/teams, /api/teams/[teamId], /api/teams/[teamId]/members API 구현
- 인증 + 권한 검사 적용
- 타입 안전성 확보 (TypeScript 오류 없음)
</success_criteria>

<output>
After completion, create `.planning/phases/21-team-features/21-01-SUMMARY.md`:

# Phase 21-01: Team Service & API Summary

**[한 줄 요약]**

## Accomplishments
- [생성/수정 파일 및 구현 내용]

## Files Created/Modified
- `src/lib/team-service.ts` - 팀 CRUD 서비스 레이어
- `src/app/api/teams/route.ts` - 팀 목록/생성 API
- `src/app/api/teams/[teamId]/route.ts` - 팀 상세/수정/삭제 API
- `src/app/api/teams/[teamId]/members/route.ts` - 멤버 관리 API

## Decisions Made
[키 결정 및 근거]

## Issues Encountered
[문제점 및 해결책]

## Next Step
Ready for 21-02-PLAN.md (Team Invite System)
</output>
