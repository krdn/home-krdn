---
phase: 21-team-features
plan: 02
type: execute
depends_on: ["21-01"]
files_modified: [prisma/schema.prisma, src/lib/team-service.ts, src/app/api/teams/[teamId]/invites/route.ts, src/app/api/invites/[token]/route.ts]
domain: next-js
---

<objective>
팀 초대 시스템을 구현하여 이메일 기반 팀 멤버 초대 및 수락 기능을 제공합니다.

Purpose: 팀 관리자가 초대 링크를 생성하고, 초대받은 사용자가 수락할 수 있는 워크플로우 구현
Output: TeamInvite 모델 추가 + 초대 생성/수락 API + 이메일 발송 연동
</objective>

<execution_context>
~/.claude/get-shit-done/workflows/execute-plan.md
./summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md

# 이전 플랜 참고
@.planning/phases/21-team-features/21-01-SUMMARY.md

# 기존 토큰 패턴 참고 (PasswordResetToken)
@prisma/schema.prisma
@src/lib/user-service.ts

# 이메일 발송 패턴 (Phase 12)
@src/app/api/notifications/email/route.ts

**Tech stack available:** Prisma 7, crypto (토큰 생성), Resend API (이메일)
**Established patterns:** 토큰 기반 인증 (PasswordResetToken 패턴), 이메일 발송 (Resend)
**Constraining decisions:**
- Phase 21-01: team-service.ts 구현 완료
- Phase 12: Resend API 이메일 발송 패턴 구축됨
</context>

<tasks>

<task type="auto">
  <name>Task 1: TeamInvite 모델 추가 및 마이그레이션</name>
  <files>prisma/schema.prisma</files>
  <action>
TeamInvite 모델을 Prisma 스키마에 추가:

```prisma
// 팀 초대 모델
model TeamInvite {
  id        String    @id @default(cuid())
  token     String    @unique
  email     String    // 초대받는 이메일 주소
  role      Role      @default(USER) // 초대 시 부여될 역할

  // 팀 외래키
  teamId    String
  team      Team      @relation(fields: [teamId], references: [id], onDelete: Cascade)

  // 초대한 사용자
  invitedById String
  invitedBy   User    @relation("TeamInviter", fields: [invitedById], references: [id])

  // 타임스탬프
  expiresAt DateTime
  usedAt    DateTime?
  createdAt DateTime  @default(now())

  // 인덱스
  @@index([token])
  @@index([teamId])
  @@index([email])
}
```

Team 모델에 invites 관계 추가:
```prisma
model Team {
  // ... 기존 필드
  invites TeamInvite[]
}
```

User 모델에 teamInvites 관계 추가:
```prisma
model User {
  // ... 기존 필드
  teamInvites TeamInvite[] @relation("TeamInviter")
}
```

마이그레이션 실행: `npx prisma migrate dev --name add_team_invite`
  </action>
  <verify>npx prisma validate 통과, npx prisma generate 성공</verify>
  <done>TeamInvite 모델 추가, 관계 설정, 마이그레이션 완료</done>
</task>

<task type="auto">
  <name>Task 2: 초대 서비스 함수 및 API 구현</name>
  <files>src/lib/team-service.ts, src/app/api/teams/[teamId]/invites/route.ts, src/app/api/invites/[token]/route.ts</files>
  <action>
1. team-service.ts에 초대 관련 함수 추가:

타입 정의:
- TeamInviteDto: id, email, role, teamId, teamName, invitedByUsername, expiresAt, createdAt
- CreateInviteInput (Zod): email, role (optional)

함수 구현:
- createTeamInvite(teamId, invitedById, input): 초대 토큰 생성 (crypto.randomBytes, 7일 만료)
- getTeamInvites(teamId): 팀의 활성 초대 목록
- getPendingInvitesByEmail(email): 이메일로 받은 대기 중 초대 목록
- findValidInvite(token): 유효한 초대 조회 (만료/사용 체크)
- acceptInvite(token, userId): 초대 수락 (멤버 추가 + usedAt 업데이트)
- cancelInvite(inviteId): 초대 취소 (삭제)
- deleteExpiredInvites(): 만료된 초대 정리 (배치용)

2. /api/teams/[teamId]/invites (route.ts):
- GET: 팀의 초대 목록 조회 (ADMIN 이상)
- POST: 새 초대 생성 (ADMIN 이상) + 이메일 발송 (Resend API 호출)
- DELETE: 초대 취소 (query param: inviteId)

3. /api/invites/[token] (route.ts):
- GET: 초대 정보 조회 (토큰 유효성 + 팀 이름 반환)
- POST: 초대 수락 (현재 로그인 사용자를 팀에 추가)

이메일 발송:
- 초대 생성 시 Resend API로 초대 이메일 발송
- 이메일 내용: 팀 이름, 초대자, 수락 링크 (/teams/invite/[token])
- RESEND_API_KEY 환경 변수 필요 (없으면 이메일 발송 스킵, 로그만 출력)
  </action>
  <verify>npx tsc --noEmit 통과, npm run build 성공</verify>
  <done>초대 서비스 함수 구현, 2개 API 라우트 생성, 이메일 발송 연동</done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] `npx prisma validate` 스키마 검증 통과
- [ ] `npx tsc --noEmit` 타입 검사 통과
- [ ] `npm run build` 빌드 성공
- [ ] TeamInvite 모델 마이그레이션 완료
- [ ] 초대 생성/수락 API 동작
</verification>

<success_criteria>

- TeamInvite Prisma 모델 추가 및 마이그레이션 완료
- 초대 CRUD 서비스 함수 구현
- /api/teams/[teamId]/invites, /api/invites/[token] API 구현
- 이메일 발송 연동 (선택적 - 환경 변수 없으면 스킵)
</success_criteria>

<output>
After completion, create `.planning/phases/21-team-features/21-02-SUMMARY.md`:

# Phase 21-02: Team Invite System Summary

**[한 줄 요약]**

## Accomplishments
- [구현 내용]

## Files Created/Modified
- `prisma/schema.prisma` - TeamInvite 모델 추가
- `src/lib/team-service.ts` - 초대 관련 함수 추가
- `src/app/api/teams/[teamId]/invites/route.ts` - 초대 목록/생성/취소 API
- `src/app/api/invites/[token]/route.ts` - 초대 조회/수락 API

## Decisions Made
[키 결정 및 근거]

## Issues Encountered
[문제점 및 해결책]

## Next Step
Ready for 21-03-PLAN.md (Team Management UI)
</output>
