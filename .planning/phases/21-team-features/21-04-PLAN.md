---
phase: 21-team-features
plan: 04
type: execute
depends_on: ["21-03"]
files_modified: [prisma/schema.prisma, src/lib/team-service.ts, src/lib/alertEngine.ts, src/app/api/teams/[teamId]/settings/route.ts, src/components/teams/TeamSettingsPanel.tsx]
domain: next-js
---

<objective>
팀 알림 채널을 구현하여 팀 멤버들에게 통합 알림을 전송할 수 있는 기능을 제공합니다.

Purpose: 팀 단위 알림 설정 및 발송 인프라 구축 (이메일/Slack 채널 활용)
Output: TeamSettings 모델 + 팀 알림 설정 API + 알림 엔진 팀 채널 확장
</objective>

<execution_context>
~/.claude/get-shit-done/workflows/execute-plan.md
./summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md

# 이전 플랜 참고
@.planning/phases/21-team-features/21-03-SUMMARY.md

# 기존 알림 시스템 (Phase 7, 12, 13)
@src/lib/alertEngine.ts
@src/app/api/notifications/email/route.ts
@src/app/api/notifications/slack/route.ts
@src/stores/alertStore.ts

**Tech stack available:** Prisma 7, Resend API, Slack Webhook
**Established patterns:** alertEngine 규칙 기반 알림, email/slack 알림 채널
**Constraining decisions:**
- Phase 7: alertEngine 구현됨
- Phase 12: Resend 이메일 알림 채널
- Phase 13: Slack Block Kit 알림 채널
- Phase 21-03: 팀 UI 구현 완료
</context>

<tasks>

<task type="auto">
  <name>Task 1: TeamSettings 모델 추가 및 팀 알림 설정 API</name>
  <files>prisma/schema.prisma, src/lib/team-service.ts, src/app/api/teams/[teamId]/settings/route.ts</files>
  <action>
1. TeamSettings 모델 추가 (prisma/schema.prisma):
```prisma
model TeamSettings {
  id String @id @default(cuid())

  // 팀 연결 (1:1)
  teamId String @unique
  team   Team   @relation(fields: [teamId], references: [id], onDelete: Cascade)

  // 알림 채널 설정
  emailNotifications Boolean @default(true)
  slackWebhookUrl    String? // 팀 전용 Slack 웹훅

  // 알림 대상 설정
  notifyOnAlert      Boolean @default(true)  // 시스템 경고 알림
  notifyOnMemberJoin Boolean @default(true)  // 멤버 가입 알림
  notifyOnMemberLeave Boolean @default(false) // 멤버 탈퇴 알림

  updatedAt DateTime @updatedAt
}
```

Team 모델에 settings 관계 추가:
```prisma
model Team {
  // ... 기존 필드
  settings TeamSettings?
}
```

마이그레이션: `npx prisma migrate dev --name add_team_settings`

2. team-service.ts에 설정 함수 추가:
   - getTeamSettings(teamId): 팀 설정 조회 (없으면 기본값 생성)
   - updateTeamSettings(teamId, input): 팀 설정 업데이트
   - TeamSettingsDto, UpdateTeamSettingsInput (Zod) 타입

3. /api/teams/[teamId]/settings (route.ts):
   - GET: 팀 설정 조회 (멤버만)
   - PATCH: 팀 설정 업데이트 (ADMIN만)

settings-service.ts 패턴 참고 (upsert 패턴)
  </action>
  <verify>npx prisma validate, npx tsc --noEmit 통과</verify>
  <done>TeamSettings 모델 추가, 설정 서비스 함수 구현, 설정 API 구현</done>
</task>

<task type="auto">
  <name>Task 2: 팀 알림 채널 확장 및 설정 UI</name>
  <files>src/lib/alertEngine.ts, src/components/teams/TeamSettingsPanel.tsx, src/app/teams/[teamId]/page.tsx</files>
  <action>
1. alertEngine.ts 팀 알림 채널 확장:
   - sendTeamNotification(teamId, message, type) 함수 추가
   - 팀 설정에서 활성화된 채널로 알림 발송:
     - emailNotifications: true → 모든 팀 멤버 이메일로 발송
     - slackWebhookUrl: 있으면 → Slack Block Kit 메시지 발송
   - 알림 타입: 'alert' | 'member_join' | 'member_leave'
   - 팀 설정의 notifyOn* 플래그 확인 후 발송 여부 결정

2. TeamSettingsPanel.tsx 컴포넌트:
   - 팀 알림 설정 폼 (설정 패널/모달)
   - 이메일 알림 토글
   - Slack 웹훅 URL 입력
   - 알림 대상 체크박스 (시스템 경고, 멤버 가입, 멤버 탈퇴)
   - 저장 버튼 (PATCH /api/teams/[teamId]/settings)

3. 팀 상세 페이지 (/teams/[teamId]/page.tsx) 수정:
   - ADMIN 이상에게 "팀 설정" 버튼 표시
   - 클릭 시 TeamSettingsPanel 모달 열기

4. team-service.ts 멤버 이벤트 알림 연동:
   - addTeamMember에서 notifyOnMemberJoin 확인 후 알림 발송
   - removeTeamMember에서 notifyOnMemberLeave 확인 후 알림 발송

기존 alertStore 패턴 참고하지만, 팀 알림은 별도로 직접 API 호출
  </action>
  <verify>npm run build 성공, 팀 설정 저장/로드 동작 확인</verify>
  <done>팀 알림 채널 구현, TeamSettingsPanel UI 구현, 멤버 이벤트 알림 연동</done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] `npx prisma validate` 스키마 검증 통과
- [ ] `npx tsc --noEmit` 타입 검사 통과
- [ ] `npm run build` 빌드 성공
- [ ] TeamSettings 모델 마이그레이션 완료
- [ ] 팀 설정 API 동작
- [ ] 팀 알림 발송 로직 구현
</verification>

<success_criteria>

- TeamSettings Prisma 모델 추가 및 마이그레이션
- 팀 설정 API (/api/teams/[teamId]/settings) 구현
- alertEngine 팀 알림 채널 확장
- TeamSettingsPanel UI 컴포넌트 구현
- 멤버 이벤트 알림 연동
- Phase 21 Team Features 완료
</success_criteria>

<output>
After completion, create `.planning/phases/21-team-features/21-04-SUMMARY.md`:

# Phase 21-04: Team Notification Channel Summary

**[한 줄 요약]**

## Accomplishments
- [구현 내용]

## Files Created/Modified
- `prisma/schema.prisma` - TeamSettings 모델 추가
- `src/lib/team-service.ts` - 팀 설정 함수 추가
- `src/lib/alertEngine.ts` - 팀 알림 채널 확장
- `src/app/api/teams/[teamId]/settings/route.ts` - 팀 설정 API
- `src/components/teams/TeamSettingsPanel.tsx` - 팀 설정 UI
- `src/app/teams/[teamId]/page.tsx` - 설정 버튼 추가

## Decisions Made
[키 결정 및 근거]

## Issues Encountered
[문제점 및 해결책]

## Phase Complete
Phase 21 Team Features 완료. 다음: Phase 22 PWA Foundation
</output>
