# Plan 07-03: 알림 전송 채널 구현

---
phase: 07-alert-system
plan: 03
type: execute
depends_on: ["07-01"]
files_modified:
  - src/components/providers/ToastProvider.tsx
  - src/hooks/useAlertNotifications.ts
  - src/components/admin/AlertToast.tsx
  - src/app/providers.tsx
---

## Objective

알림을 사용자에게 전달하는 채널을 구현합니다. Radix Toast를 활용한 인앱 알림과 브라우저 Notification API를 통합합니다.

Purpose: 실시간 알림 표시 및 브라우저 푸시 알림
Output: Toast 프로바이더, 알림 훅, 브라우저 알림 통합

## Execution Context

@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md

## Context

@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/07-alert-system/07-01-SUMMARY.md

**Tech stack available:**
- @radix-ui/react-toast 1.2.15
- React Query (onSuccess 콜백 가능)
- Zustand alertStore

**Established patterns:**
- Providers 패턴: src/app/providers.tsx
- React Query 훅: src/hooks/useSystemMetrics.ts

**Key files:**
@src/stores/alertStore.ts
@src/lib/alertEngine.ts
@src/hooks/useSystemMetrics.ts

## Tasks

<task type="auto">
  <name>Task 1: Toast Provider 설정</name>
  <files>src/components/providers/ToastProvider.tsx, src/app/providers.tsx</files>
  <action>
Radix Toast Provider를 설정합니다:

```typescript
// src/components/providers/ToastProvider.tsx
'use client';

import * as Toast from '@radix-ui/react-toast';
import { ReactNode, createContext, useContext, useState, useCallback } from 'react';
import type { AlertSeverity } from '@/types/alert';

interface ToastData {
  id: string;
  title: string;
  description?: string;
  severity: AlertSeverity;
  duration?: number;
}

interface ToastContextValue {
  showToast: (toast: Omit<ToastData, 'id'>) => void;
}

const ToastContext = createContext<ToastContextValue | null>(null);

export function useToast() {
  const context = useContext(ToastContext);
  if (!context) throw new Error('useToast must be used within ToastProvider');
  return context;
}

export function ToastProvider({ children }: { children: ReactNode }) {
  const [toasts, setToasts] = useState<ToastData[]>([]);

  const showToast = useCallback((toast: Omit<ToastData, 'id'>) => {
    const id = crypto.randomUUID();
    setToasts((prev) => [...prev, { ...toast, id }]);
  }, []);

  const removeToast = useCallback((id: string) => {
    setToasts((prev) => prev.filter((t) => t.id !== id));
  }, []);

  return (
    <ToastContext.Provider value={{ showToast }}>
      <Toast.Provider swipeDirection="right">
        {children}
        {toasts.map((toast) => (
          <AlertToast
            key={toast.id}
            {...toast}
            onClose={() => removeToast(toast.id)}
          />
        ))}
        <Toast.Viewport className="fixed bottom-0 right-0 flex flex-col gap-2 p-4 w-96 max-w-full z-50" />
      </Toast.Provider>
    </ToastContext.Provider>
  );
}
```

providers.tsx에 ToastProvider 추가:
```typescript
export function Providers({ children }: { children: React.ReactNode }) {
  return (
    <QueryClientProvider client={getQueryClient()}>
      <ToastProvider>
        {children}
      </ToastProvider>
      <ReactQueryDevtools />
    </QueryClientProvider>
  );
}
```
  </action>
  <verify>npx tsc --noEmit</verify>
  <done>ToastProvider가 앱에 통합되고 useToast 훅 사용 가능</done>
</task>

<task type="auto">
  <name>Task 2: 알림 Toast 컴포넌트</name>
  <files>src/components/admin/AlertToast.tsx</files>
  <action>
심각도별 스타일이 적용된 Toast 컴포넌트:

```typescript
'use client';

import * as Toast from '@radix-ui/react-toast';
import { AlertTriangle, Info, XCircle, X } from 'lucide-react';
import { cn } from '@/lib/utils';
import type { AlertSeverity } from '@/types/alert';

interface AlertToastProps {
  id: string;
  title: string;
  description?: string;
  severity: AlertSeverity;
  duration?: number;
  onClose: () => void;
}

const severityConfig: Record<AlertSeverity, {
  icon: typeof Info;
  bg: string;
  border: string;
  text: string;
}> = {
  info: {
    icon: Info,
    bg: 'bg-blue-50',
    border: 'border-blue-200',
    text: 'text-blue-800',
  },
  warning: {
    icon: AlertTriangle,
    bg: 'bg-yellow-50',
    border: 'border-yellow-200',
    text: 'text-yellow-800',
  },
  critical: {
    icon: XCircle,
    bg: 'bg-red-50',
    border: 'border-red-200',
    text: 'text-red-800',
  },
};

export function AlertToast({
  title,
  description,
  severity,
  duration = 5000,
  onClose,
}: AlertToastProps) {
  const config = severityConfig[severity];
  const Icon = config.icon;

  return (
    <Toast.Root
      className={cn(
        'rounded-lg border p-4 shadow-lg',
        config.bg,
        config.border
      )}
      duration={duration}
      onOpenChange={(open) => !open && onClose()}
    >
      <div className="flex items-start gap-3">
        <Icon className={cn('h-5 w-5 mt-0.5', config.text)} />
        <div className="flex-1">
          <Toast.Title className={cn('font-semibold', config.text)}>
            {title}
          </Toast.Title>
          {description && (
            <Toast.Description className="mt-1 text-sm text-gray-600">
              {description}
            </Toast.Description>
          )}
        </div>
        <Toast.Close className="text-gray-400 hover:text-gray-600">
          <X className="h-4 w-4" />
        </Toast.Close>
      </div>
    </Toast.Root>
  );
}
```
  </action>
  <verify>npx tsc --noEmit</verify>
  <done>심각도별 스타일이 적용된 Toast 컴포넌트</done>
</task>

<task type="auto">
  <name>Task 3: 알림 통합 훅</name>
  <files>src/hooks/useAlertNotifications.ts</files>
  <action>
메트릭 변화를 감지하고 알림을 발생시키는 통합 훅:

```typescript
'use client';

import { useEffect, useRef } from 'react';
import { useSystemMetrics } from './useSystemMetrics';
import { useAlertStore } from '@/stores/alertStore';
import { useToast } from '@/components/providers/ToastProvider';
import { evaluateMetrics } from '@/lib/alertEngine';
import type { Alert, AlertSeverity } from '@/types/alert';

// 브라우저 알림 권한 요청
async function requestNotificationPermission(): Promise<boolean> {
  if (!('Notification' in window)) return false;
  if (Notification.permission === 'granted') return true;
  if (Notification.permission === 'denied') return false;

  const permission = await Notification.requestPermission();
  return permission === 'granted';
}

// 브라우저 알림 표시
function showBrowserNotification(alert: Omit<Alert, 'id' | 'createdAt'>) {
  if (Notification.permission !== 'granted') return;

  new Notification(alert.ruleName, {
    body: alert.message,
    icon: '/favicon.ico',
    tag: alert.ruleId, // 같은 규칙의 알림은 대체
  });
}

export function useAlertNotifications() {
  const { data: metrics } = useSystemMetrics();
  const { rules, addAlert } = useAlertStore();
  const { showToast } = useToast();
  const permissionRequested = useRef(false);

  // 권한 요청 (최초 1회)
  useEffect(() => {
    if (!permissionRequested.current) {
      permissionRequested.current = true;
      requestNotificationPermission();
    }
  }, []);

  // 메트릭 변화 감지 및 알림 발생
  useEffect(() => {
    if (!metrics) return;

    const newAlerts = evaluateMetrics(metrics, rules);

    for (const alertData of newAlerts) {
      // 스토어에 추가
      addAlert(alertData);

      // Toast 표시
      showToast({
        title: alertData.ruleName,
        description: alertData.message,
        severity: alertData.severity,
        duration: alertData.severity === 'critical' ? 10000 : 5000,
      });

      // 브라우저 알림 (critical만)
      if (alertData.severity === 'critical') {
        showBrowserNotification(alertData);
      }
    }
  }, [metrics, rules, addAlert, showToast]);
}
```

AdminLayout 또는 DashboardStats에서 이 훅 호출:
```typescript
// 대시보드에서 알림 시스템 활성화
useAlertNotifications();
```
  </action>
  <verify>npm run build</verify>
  <done>메트릭 기반 알림 발생 및 다채널 표시 동작</done>
</task>

## Verification

```bash
# 타입 체크
npx tsc --noEmit

# 빌드 확인
npm run build

# 테스트 실행
npm run test

# 개발 서버에서 확인
# 1. npm run dev
# 2. CPU/Memory 사용량이 임계값 초과 시 Toast 표시 확인
# 3. 브라우저 알림 권한 요청 확인
```

## Success Criteria

- [ ] Toast가 알림 발생 시 표시됨
- [ ] 심각도별 다른 스타일 적용됨
- [ ] 브라우저 알림 권한 요청 동작
- [ ] Critical 알림 시 브라우저 알림 표시
- [ ] 빌드 성공

## Output

After completion, create `.planning/phases/07-alert-system/07-03-SUMMARY.md`

---
*Created: 2026-01-14*
