---
phase: 03-testing-infrastructure
plan: 03
type: execute
depends_on: ["03-01"]
files_modified: [src/app/api/system/route.test.ts, src/app/api/auth/session/route.test.ts]
---

<objective>
주요 API 엔드포인트에 대한 통합 테스트를 작성합니다.

Purpose: API 레이어는 클라이언트와 서버 간 계약이므로, 응답 형식과 에러 처리가 올바른지 검증해야 합니다.
Output: system API와 auth session API에 대한 통합 테스트
</objective>

<execution_context>
~/.claude/get-shit-done/workflows/execute-plan.md
./summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/03-testing-infrastructure/03-01-SUMMARY.md

**테스트 대상 API:**
- `GET /api/system` - 시스템 메트릭 반환
- `GET /api/auth/session` - 세션 정보 반환

**API 응답 형식:**
```typescript
// 성공
{ success: true, data: {...} }

// 실패
{ success: false, error: "message" }
```

**테스트 전략:**
- Next.js App Router의 route handler를 직접 호출
- 외부 의존성(Docker socket, /proc/stat)은 mocking
- 인증이 필요한 엔드포인트는 토큰 mocking
</context>

<tasks>

<task type="auto">
  <name>Task 1: System API 테스트 작성</name>
  <files>src/app/api/system/route.test.ts</files>
  <action>
1. 테스트 파일 생성 (`src/app/api/system/route.test.ts`)

2. GET 핸들러 테스트:
   ```typescript
   import { describe, it, expect, vi, beforeEach } from 'vitest';
   import { GET } from './route';

   // system.ts 모듈 mocking
   vi.mock('@/lib/system', () => ({
     getSystemMetrics: vi.fn(),
   }));
   ```

3. 테스트 케이스:
   - 성공 시 `{ success: true, data: {...} }` 반환
   - data에 cpu, memory, uptime 등 필수 필드 포함
   - 시스템 에러 시 `{ success: false, error: "..." }` 반환

4. Mocking 전략:
   - `getSystemMetrics`를 vi.mock으로 대체
   - 성공 케이스: 예상 메트릭 객체 반환
   - 실패 케이스: Error throw

**주의:**
- NextRequest 생성 필요: `new NextRequest('http://localhost/api/system')`
- 응답은 `response.json()`으로 파싱
- 인증 미들웨어가 있으면 bypass 방법 고려
  </action>
  <verify>`npm run test:run src/app/api/system/route.test.ts` 통과</verify>
  <done>System API 테스트 작성 완료</done>
</task>

<task type="auto">
  <name>Task 2: Auth Session API 테스트 작성</name>
  <files>src/app/api/auth/session/route.test.ts</files>
  <action>
1. 테스트 파일 생성 (`src/app/api/auth/session/route.test.ts`)

2. GET 핸들러 테스트:
   ```typescript
   import { describe, it, expect, vi } from 'vitest';
   import { GET } from './route';
   import { NextRequest } from 'next/server';
   ```

3. 테스트 케이스:
   - 유효한 토큰: `{ success: true, user: {...} }` 반환
   - 토큰 없음: `{ success: false, error: "..." }` 또는 적절한 응답
   - 만료된 토큰: 에러 응답

4. 토큰 Mocking:
   - 쿠키에서 토큰 읽기 mocking
   - JWT 검증 로직 mocking (jose 라이브러리)

**주의:**
- NextRequest의 cookies 설정 방법 확인
- `request.cookies.get('auth-token')` 형식
- 실제 JWT 생성 대신 mock 토큰 사용
  </action>
  <verify>`npm run test:run src/app/api/auth/session/route.test.ts` 통과</verify>
  <done>Auth Session API 테스트 작성 완료</done>
</task>

</tasks>

<verification>
Before declaring phase complete:
- [ ] `npm run test:run` 모든 테스트 통과
- [ ] System API 테스트 커버리지 확보
- [ ] Auth Session API 테스트 커버리지 확보
- [ ] Mocking이 올바르게 동작
- [ ] `npm run build` 성공
</verification>

<success_criteria>

- System API GET 테스트 완료
- Auth Session API GET 테스트 완료
- 성공/실패 케이스 모두 커버
- 모든 테스트 통과
- Phase 3 완료
</success_criteria>

<output>
After completion, create `.planning/phases/03-testing-infrastructure/03-03-SUMMARY.md`
</output>
