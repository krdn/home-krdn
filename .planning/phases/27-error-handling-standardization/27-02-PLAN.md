# Plan 27-02: API Route Migration & Client Integration

## Overview

27-01에서 구현한 에러 시스템을 기존 API 라우트에 적용하고, 클라이언트 측 에러 처리를 표준화합니다.

## Goals

1. 핵심 API 라우트에 새 에러 시스템 적용
2. 클라이언트용 에러 유틸리티 구현
3. React Query 에러 핸들링 표준화
4. 에러 바운더리 개선

## Tasks

### Task 1: Auth Routes Migration

기존 인증 관련 API 라우트를 새 에러 시스템으로 마이그레이션합니다.

**Files to modify**:
- `src/app/api/auth/login/route.ts`
- `src/app/api/auth/register/route.ts`
- `src/app/api/auth/logout/route.ts`
- `src/app/api/auth/session/route.ts`

**Pattern**:
```typescript
import { createErrorResponse, withErrorHandler } from '@/lib/api-error-handler';
import { AuthError, ValidationError } from '@/lib/errors';
import { logError, extractRequestContext } from '@/lib/error-logger';

export async function POST(request: Request) {
  try {
    const body = await request.json();

    // 검증
    if (!body.username || !body.password) {
      throw new ValidationError('사용자명과 비밀번호를 입력해주세요');
    }

    // 비즈니스 로직
    const result = await authenticateUser(body.username, body.password);

    if (!result.success) {
      throw new AuthError('잘못된 인증 정보입니다', 'INVALID_CREDENTIALS');
    }

    return NextResponse.json({ success: true, data: result });
  } catch (error) {
    logError(error, extractRequestContext(request));
    return createErrorResponse(error);
  }
}
```

**Verification**:
- 로그인 성공/실패 시나리오 테스트
- 에러 응답 포맷 확인

### Task 2: Admin Routes Migration

관리자 API 라우트에 에러 시스템 적용합니다.

**Files to modify**:
- `src/app/api/admin/users/route.ts`
- `src/app/api/admin/users/[id]/route.ts`
- `src/app/api/admin/users/[id]/role/route.ts`

**New errors to use**:
- `NotFoundError` for missing users
- `AuthError` with `FORBIDDEN` for role restrictions
- `ConflictError` for last admin protection

**Pattern**:
```typescript
// 마지막 관리자 보호
if (targetUser.role === 'ADMIN' && newRole !== 'ADMIN') {
  const adminCount = await countUsersByRole('ADMIN');
  if (adminCount <= 1) {
    throw new ConflictError('마지막 관리자는 강등할 수 없습니다', 'role');
  }
}
```

**Verification**:
- 권한 에러 시 403 응답 확인
- 마지막 관리자 보호 로직 테스트

### Task 3: Team Routes Migration

팀 관련 API 라우트에 에러 시스템 적용합니다.

**Files to modify**:
- `src/app/api/teams/route.ts`
- `src/app/api/teams/[teamId]/route.ts`
- `src/app/api/teams/[teamId]/members/route.ts`
- `src/app/api/teams/[teamId]/invite/route.ts`

**New errors to use**:
- `NotFoundError` for missing teams
- `ConflictError` for duplicate team names
- `AuthError` for team access control

**Verification**:
- 팀 CRUD 에러 시나리오 테스트

### Task 4: Client Error Utilities

클라이언트용 에러 유틸리티를 구현합니다.

**File**: `src/lib/client-errors.ts`

```typescript
import type { ErrorCode } from './error-codes';

export interface ApiErrorResponse {
  success: false;
  error: string;
  code: ErrorCode;
  details?: Record<string, unknown>;
}

/**
 * API 응답이 에러인지 확인
 */
export function isApiError(response: unknown): response is ApiErrorResponse {
  return (
    typeof response === 'object' &&
    response !== null &&
    'success' in response &&
    response.success === false &&
    'error' in response
  );
}

/**
 * 에러 코드에 따른 사용자 친화적 메시지 반환
 */
export function getErrorMessage(error: unknown): string {
  if (isApiError(error)) {
    return error.error;
  }

  if (error instanceof Error) {
    return error.message;
  }

  return '알 수 없는 오류가 발생했습니다';
}

/**
 * 에러 코드에 따른 토스트 심각도 결정
 */
export function getErrorSeverity(
  code: ErrorCode | undefined
): 'error' | 'warning' {
  if (!code) return 'error';

  // 사용자 입력 오류는 warning
  const warningCodes: ErrorCode[] = [
    'VALIDATION_ERROR',
    'INVALID_INPUT',
    'MISSING_FIELD',
    'INVALID_FORMAT',
    'CONFLICT',
    'ALREADY_EXISTS',
  ];

  return warningCodes.includes(code) ? 'warning' : 'error';
}

/**
 * fetch 응답을 파싱하고 에러 처리
 */
export async function parseApiResponse<T>(
  response: Response
): Promise<T> {
  const data = await response.json();

  if (!response.ok || isApiError(data)) {
    const error = new Error(data.error || 'API 요청 실패');
    (error as any).code = data.code;
    (error as any).details = data.details;
    throw error;
  }

  return data;
}
```

**Verification**:
- 타입 체크 통과
- 각 유틸리티 함수 단위 테스트

### Task 5: React Query Error Integration

React Query 에러 핸들링을 표준화합니다.

**File**: `src/lib/query-client.ts` 수정

```typescript
import { QueryClient } from '@tanstack/react-query';
import { getErrorMessage, getErrorSeverity, isApiError } from './client-errors';

export function createQueryClient() {
  return new QueryClient({
    defaultOptions: {
      queries: {
        staleTime: 5 * 60 * 1000,
        retry: (failureCount, error) => {
          // 인증 에러는 재시도 안함
          if (isApiError(error) &&
              ['UNAUTHORIZED', 'FORBIDDEN', 'TOKEN_EXPIRED'].includes(error.code)) {
            return false;
          }
          return failureCount < 3;
        },
      },
      mutations: {
        onError: (error) => {
          // 전역 mutation 에러 로깅
          console.error('[Mutation Error]', getErrorMessage(error));
        },
      },
    },
  });
}
```

**Verification**:
- 인증 에러 시 재시도 안함 확인
- mutation 에러 로깅 확인

### Task 6: Error Boundary Enhancement

에러 바운더리를 개선합니다.

**File**: `src/components/ErrorBoundary.tsx` (신규 또는 수정)

```typescript
'use client';

import { Component, ReactNode } from 'react';
import { Button } from '@/components/ui/Button';

interface Props {
  children: ReactNode;
  fallback?: ReactNode;
}

interface State {
  hasError: boolean;
  error?: Error;
}

export class ErrorBoundary extends Component<Props, State> {
  state: State = { hasError: false };

  static getDerivedStateFromError(error: Error): State {
    return { hasError: true, error };
  }

  componentDidCatch(error: Error, errorInfo: React.ErrorInfo) {
    // 에러 로깅 (클라이언트 측)
    console.error('[ErrorBoundary]', {
      error: error.message,
      stack: error.stack,
      componentStack: errorInfo.componentStack,
    });
  }

  handleReset = () => {
    this.setState({ hasError: false, error: undefined });
  };

  render() {
    if (this.state.hasError) {
      if (this.props.fallback) {
        return this.props.fallback;
      }

      return (
        <div className="flex flex-col items-center justify-center min-h-[200px] p-8">
          <h2 className="text-xl font-semibold text-gray-900 dark:text-gray-100 mb-2">
            문제가 발생했습니다
          </h2>
          <p className="text-gray-600 dark:text-gray-400 mb-4">
            페이지를 새로고침하거나 다시 시도해주세요
          </p>
          <Button onClick={this.handleReset}>
            다시 시도
          </Button>
        </div>
      );
    }

    return this.props.children;
  }
}
```

**Verification**:
- 에러 발생 시 fallback UI 표시
- 리셋 버튼 동작 확인

### Task 7: Integration Tests

통합 테스트를 작성합니다.

**File**: `src/lib/__tests__/client-errors.test.ts`

```typescript
import { describe, it, expect } from 'vitest';
import {
  isApiError,
  getErrorMessage,
  getErrorSeverity,
  parseApiResponse,
} from '../client-errors';

describe('Client Error Utilities', () => {
  describe('isApiError', () => {
    it('should identify API error responses', () => {
      const error = { success: false, error: 'Test', code: 'INTERNAL_ERROR' };
      expect(isApiError(error)).toBe(true);
    });

    it('should reject success responses', () => {
      const success = { success: true, data: {} };
      expect(isApiError(success)).toBe(false);
    });
  });

  describe('getErrorSeverity', () => {
    it('should return warning for validation errors', () => {
      expect(getErrorSeverity('VALIDATION_ERROR')).toBe('warning');
      expect(getErrorSeverity('INVALID_INPUT')).toBe('warning');
    });

    it('should return error for system errors', () => {
      expect(getErrorSeverity('INTERNAL_ERROR')).toBe('error');
      expect(getErrorSeverity('UNAUTHORIZED')).toBe('error');
    });
  });
});
```

**Verification**:
- `npm run test -- src/lib/__tests__/client-errors.test.ts` 통과

## Dependencies

- 27-01 완료 (에러 클래스 및 핸들러)

## Verification Checklist

- [ ] Task 1: Auth 라우트 마이그레이션
- [ ] Task 2: Admin 라우트 마이그레이션
- [ ] Task 3: Team 라우트 마이그레이션
- [ ] Task 4: 클라이언트 에러 유틸리티 구현
- [ ] Task 5: React Query 에러 통합
- [ ] Task 6: ErrorBoundary 개선
- [ ] Task 7: 통합 테스트 작성
- [ ] `npm run typecheck` 통과
- [ ] `npm run build` 성공
- [ ] 기존 테스트 통과

## Commit Convention

각 Task 완료 시:
```
feat(27-02): Auth 라우트 에러 시스템 마이그레이션
feat(27-02): 클라이언트 에러 유틸리티 구현
feat(27-02): ErrorBoundary 개선
```
