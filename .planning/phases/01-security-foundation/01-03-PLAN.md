---
phase: 01-security-foundation
plan: 03
type: execute
depends_on: ["01-02"]
files_modified: [src/middleware.ts]
---

<objective>
Next.js 미들웨어를 생성하여 API 라우트를 보호합니다.

Purpose: 인증되지 않은 사용자가 민감한 API 엔드포인트에 접근하지 못하도록 차단합니다.
Output: 보호된 API 라우트, 미인증 접근 시 401 반환
</objective>

<execution_context>
~/.claude/get-shit-done/workflows/execute-plan.md
~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/01-security-foundation/01-01-SUMMARY.md
@.planning/phases/01-security-foundation/01-02-SUMMARY.md

**Tech available:**
- jose (JWT verification)
- Next.js middleware

**Established patterns:**
- JWT 토큰은 `auth-token` 쿠키에 저장
- verifyToken() 함수로 검증

**Key files:**
@src/lib/auth.ts
@src/app/api/system/route.ts
@src/app/api/docker/containers/route.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Next.js 미들웨어 생성</name>
  <files>src/middleware.ts</files>
  <action>
  `src/middleware.ts` 파일 생성:

  **보호할 경로:**
  - `/api/system/*` - 시스템 메트릭
  - `/api/docker/*` - Docker 관리
  - `/admin/*` - 관리자 페이지

  **공개 경로 (보호하지 않음):**
  - `/api/auth/*` - 인증 API
  - `/` - 홈페이지
  - `/_next/*` - Next.js 정적 파일
  - `/favicon.ico` - 파비콘

  **미들웨어 로직:**
  1. 요청 경로 확인
  2. 공개 경로면 통과 (NextResponse.next())
  3. 보호된 경로면:
     a. 쿠키에서 `auth-token` 추출
     b. verifyToken()으로 검증
     c. 유효하면 통과
     d. 무효하면:
        - API 요청: 401 JSON 응답
        - 페이지 요청: /login으로 리다이렉트

  **matcher 설정:**
  ```typescript
  export const config = {
    matcher: [
      '/api/system/:path*',
      '/api/docker/:path*',
      '/admin/:path*',
    ],
  };
  ```

  **주의:** 미들웨어에서 `src/lib/auth.ts`의 verifyToken을 직접 import하면 Edge Runtime에서 문제가 될 수 있으므로, jose를 직접 사용하거나 Edge 호환 함수를 만듭니다.
  </action>
  <verify>npm run build 후, 인증 없이 curl http://localhost:3000/api/system 시 401 반환 확인</verify>
  <done>보호된 API 경로에 인증 없이 접근 시 401 반환, 인증 후 정상 접근</done>
</task>

<task type="auto">
  <name>Task 2: 미들웨어 Edge Runtime 호환성 확인</name>
  <files>src/middleware.ts</files>
  <action>
  미들웨어가 Edge Runtime에서 정상 동작하는지 확인:

  **확인 사항:**
  1. `jose` 라이브러리는 Edge Runtime 호환
  2. `bcryptjs`는 미들웨어에서 사용하지 않음 (Node.js 전용)
  3. 환경 변수 `JWT_SECRET` 접근 가능

  **테스트 시나리오:**
  1. 인증 없이 `/api/system` 접근 → 401
  2. 잘못된 토큰으로 접근 → 401
  3. 유효한 토큰으로 접근 → 200 + 데이터
  4. 인증 없이 `/admin` 접근 → /login 리다이렉트
  5. `/api/auth/login` 접근 → 인증 없이도 통과

  **빌드 테스트:**
  `npm run build`가 성공해야 함 (Edge Runtime 호환성 확인)
  </action>
  <verify>npm run build 성공, 개발 서버에서 보호된 라우트 테스트</verify>
  <done>빌드 성공, 모든 테스트 시나리오 통과</done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] `npm run build` 성공
- [ ] `/api/system` 인증 없이 접근 시 401
- [ ] `/api/docker/containers` 인증 없이 접근 시 401
- [ ] `/api/auth/login` 인증 없이 접근 가능
- [ ] 유효한 토큰으로 보호된 API 접근 가능
- [ ] Phase 1 완료
</verification>

<success_criteria>
- 모든 tasks 완료
- 보호된 라우트가 인증 없이 접근 불가
- 기존 기능이 인증 후 정상 동작
- Phase 1: Security Foundation 완료
</success_criteria>

<output>
After completion, create `.planning/phases/01-security-foundation/01-03-SUMMARY.md`

This is the final plan of Phase 1. Mark phase as complete in ROADMAP.md.
</output>
