# 38-02 Plan: 로그 알림 API + 실시간 통합

## Overview

로그 알림 규칙 REST API와 실시간 로그 수집기 통합을 구현합니다.

## Context

**Depends on**: 38-01 완료 (LogAlertRule 타입, log-alert-engine)

## Tasks

### Task 1: 로그 알림 규칙 REST API

**Files**: `src/app/api/log-alerts/route.ts`, `src/app/api/log-alerts/[id]/route.ts` (NEW)

```typescript
// GET /api/log-alerts - 규칙 목록 조회
// POST /api/log-alerts - 규칙 생성

// GET /api/log-alerts/[id] - 규칙 상세 조회
// PUT /api/log-alerts/[id] - 규칙 수정
// DELETE /api/log-alerts/[id] - 규칙 삭제
```

**인증/권한:**
- 조회: 로그인 사용자 (본인 규칙 + 전역 규칙)
- 생성: 로그인 사용자 (본인 규칙) / Admin (전역 규칙)
- 수정/삭제: 본인 규칙 소유자 또는 Admin

### Task 2: 로그 알림 규칙 활성화 토글 API

**File**: `src/app/api/log-alerts/[id]/toggle/route.ts` (NEW)

```typescript
// POST /api/log-alerts/[id]/toggle
// 규칙 enabled 상태 토글
```

### Task 3: LogCollectorManager 알림 엔진 통합

**File**: `src/lib/log-collector/index.ts` (MODIFY)

수집기에서 로그 수신 시 알림 엔진 평가:

```typescript
import { evaluateLog } from '@/lib/log-alert-engine'
import { getActiveLogAlertRules } from '@/lib/log-alert-service'

// onLog 콜백에서 알림 평가 추가
private async evaluateLogAlert(log: LogEntry): Promise<void> {
  const rules = await getActiveLogAlertRules()
  const alerts = evaluateLog(log, rules)

  if (alerts.length > 0) {
    // 알림 발생 시 처리
    await this.handleLogAlerts(alerts)
  }
}

// 알림 처리 (기존 채널 활용)
private async handleLogAlerts(alerts: NewAlert[]): Promise<void> {
  // 1. 알림 저장 (AlertHistory)
  // 2. WebSocket 브로드캐스트
  // 3. 외부 채널 (email/slack/push) - 심각도에 따라
}
```

### Task 4: 로그 알림 WebSocket 이벤트

**File**: `src/lib/ws/handlers/subscribe-logs.ts` (MODIFY)

새로운 이벤트 타입 추가:

```typescript
// 기존 log:entry 외에 log:alert 이벤트 추가
socket.emit('log:alert', {
  alert: NewAlert,
  log: LogEntry,  // 원인 로그
  rule: LogAlertRule,  // 트리거한 규칙
})
```

### Task 5: useLogAlerts 훅

**File**: `src/hooks/useLogAlerts.ts` (NEW)

TanStack Query 기반 로그 알림 규칙 관리 훅:

```typescript
// 규칙 목록 조회
export function useLogAlertRules(options?: { enabled?: boolean })

// 규칙 생성
export function useCreateLogAlertRule()

// 규칙 수정
export function useUpdateLogAlertRule()

// 규칙 삭제
export function useDeleteLogAlertRule()

// 규칙 토글
export function useToggleLogAlertRule()

// 실시간 알림 수신 (WebSocket)
export function useLogAlertStream(onAlert: (alert: LogAlertEvent) => void)
```

## Dependencies

- 38-01 (LogAlertRule 타입, log-alert-engine, log-alert-service)
- 기존 WebSocket 인프라 (Phase 9)
- 기존 알림 채널 (Phase 12-13)

## Verification

```bash
# API 테스트
curl -X GET http://localhost:3000/api/log-alerts -H "Cookie: auth=..."
curl -X POST http://localhost:3000/api/log-alerts -H "Content-Type: application/json" -d '...'

# 빌드 확인
npm run build
```

## Notes

- 알림 평가는 비동기로 수행 (로그 저장 성능에 영향 없도록)
- 규칙 캐싱 고려 (매 로그마다 DB 조회 방지)
