# 38-01 Plan: 로그 알림 타입 및 규칙 엔진

## Overview

로그 패턴 기반 알림 규칙 시스템의 기반을 구축합니다.

## Context

**Phase 38 Goal**: 로그 패턴 기반 알림 규칙 — 에러 키워드 감지, 빈도 기반 알림, 기존 alertEngine 확장

### 기존 시스템 분석
- `src/lib/alertEngine.ts`: 메트릭 기반 알림 (CPU/Memory/Disk/Network)
- `src/types/alert.ts`: AlertRule, AlertCategory 타입
- `src/lib/log-storage.ts`: 로그 저장/조회 서비스
- `src/types/log.ts`: LogEntry, LogLevel, LogSource 타입

## Tasks

### Task 1: LogAlertRule 타입 정의

**File**: `src/types/log-alert.ts` (NEW)

로그 알림 규칙 타입 및 Zod 스키마 정의:

```typescript
// 로그 알림 조건 타입
export type LogAlertConditionType =
  | 'keyword'     // 키워드 매칭
  | 'pattern'     // 정규식 패턴
  | 'frequency'   // 빈도 기반 (에러 N회 발생 시)

// 로그 알림 조건
export interface LogAlertCondition {
  type: LogAlertConditionType

  // keyword/pattern 조건
  keywords?: string[]        // 매칭할 키워드 목록
  pattern?: string           // 정규식 패턴
  caseSensitive?: boolean    // 대소문자 구분 (기본: false)

  // frequency 조건
  threshold?: number         // 발생 횟수 임계값
  windowMinutes?: number     // 시간 윈도우 (분)
  level?: LogLevel           // 타겟 로그 레벨 (예: error)
}

// 로그 알림 규칙
export interface LogAlertRule {
  id: string
  name: string
  description?: string
  condition: LogAlertCondition
  sources?: LogSource[]      // 타겟 소스 (비어있으면 모든 소스)
  sourceIds?: string[]       // 특정 컨테이너/서비스 ID
  severity: AlertSeverity    // 알림 심각도
  enabled: boolean
  cooldown: number           // 재알림 대기 시간 (초)
  createdAt: Date
  updatedAt: Date
}
```

Zod 스키마도 함께 정의하여 런타임 검증 지원.

### Task 2: Prisma LogAlertRule 모델

**File**: `prisma/schema.prisma` (MODIFY)

```prisma
model LogAlertRule {
  id          String   @id @default(uuid())
  name        String
  description String?

  // JSON으로 조건 저장 (flexibility)
  condition   String   // JSON: LogAlertCondition

  // 필터 조건
  sources     String?  // JSON: LogSource[]
  sourceIds   String?  // JSON: string[]

  severity    String   @default("warning")
  enabled     Boolean  @default(true)
  cooldown    Int      @default(300) // 5분

  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  // 사용자 연결 (선택적 - 개인 규칙 vs 전역 규칙)
  userId      String?
  user        User?    @relation(fields: [userId], references: [id], onDelete: SetNull)
}
```

마이그레이션 실행.

### Task 3: log-alert-service 서비스 레이어

**File**: `src/lib/log-alert-service.ts` (NEW)

LogAlertRule CRUD 서비스:

```typescript
// 전역 규칙 조회
export async function getGlobalLogAlertRules(): Promise<LogAlertRule[]>

// 사용자 규칙 조회
export async function getUserLogAlertRules(userId: string): Promise<LogAlertRule[]>

// 활성 규칙 조회 (전역 + 사용자)
export async function getActiveLogAlertRules(userId?: string): Promise<LogAlertRule[]>

// 규칙 생성/수정/삭제
export async function createLogAlertRule(data: NewLogAlertRule, userId?: string): Promise<LogAlertRule>
export async function updateLogAlertRule(id: string, data: Partial<LogAlertRule>): Promise<LogAlertRule>
export async function deleteLogAlertRule(id: string): Promise<void>
```

### Task 4: 로그 알림 엔진 (evaluateLogs)

**File**: `src/lib/log-alert-engine.ts` (NEW)

로그 기반 알림 평가 엔진:

```typescript
// 빈도 추적 (시간 윈도우 기반)
class FrequencyTracker {
  private events: Map<string, number[]> = new Map()

  // 이벤트 추가 및 윈도우 내 카운트 반환
  addEvent(ruleId: string, timestamp: number, windowMinutes: number): number

  // 오래된 이벤트 정리
  cleanup(): void
}

// 단일 로그 평가
export function evaluateLog(
  log: LogEntry,
  rules: LogAlertRule[]
): NewAlert[]

// 키워드 매칭
function matchKeywords(message: string, keywords: string[], caseSensitive: boolean): boolean

// 패턴 매칭
function matchPattern(message: string, pattern: string, caseSensitive: boolean): boolean

// 빈도 조건 평가
function checkFrequency(
  ruleId: string,
  threshold: number,
  windowMinutes: number
): boolean
```

**주요 로직:**
1. 규칙의 sources/sourceIds 필터 확인
2. 조건 타입별 평가 (keyword/pattern/frequency)
3. 쿨다운 확인
4. NewAlert 생성 (기존 alert.ts 타입 재사용)

### Task 5: AlertCategory 확장

**File**: `src/types/alert.ts` (MODIFY)

```typescript
// 'log' 카테고리 추가
export type AlertCategory = 'cpu' | 'memory' | 'disk' | 'container' | 'network' | 'log';
```

**File**: `src/lib/alertEngine.ts` (MODIFY)

`formatAlertMessage`에 log 카테고리 추가:
```typescript
const categoryNames: Record<AlertCategory, string> = {
  // ... 기존 ...
  log: '로그',
};
```

## Dependencies

- Phase 36 (LogStorage, LogEntry 타입)
- 기존 alert.ts 타입 시스템

## Verification

```bash
# 마이그레이션 확인
npx prisma migrate dev --name add_log_alert_rule

# 타입 체크
npx tsc --noEmit

# 테스트 빌드
npm run build
```

## Notes

- 빈도 추적은 메모리 기반 (서버 재시작 시 초기화)
- 추후 Redis 등 영구 저장소로 확장 가능
- frequency 조건은 실시간 로그 스트림에서 평가
