---
phase: 18-auth-system-extension
plan: 03
type: execute
depends_on: []
files_modified: [src/app/api/admin/users/[id]/role/route.ts, src/middleware.ts, src/lib/user-service.ts]
---

<objective>
Role Management - 관리자 전용 역할 관리 API 구현

Purpose: 관리자가 사용자 역할을 변경할 수 있는 API 제공, Phase 19 RBAC 준비
Output: 역할 변경 API + 미들웨어 역할 검사 강화
</objective>

<execution_context>
~/.claude/get-shit-done/workflows/execute-plan.md
./summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/17-database-infrastructure/17-01-SUMMARY.md

# Key files:
@src/middleware.ts
@src/lib/user-service.ts
@src/types/auth.ts
@prisma/schema.prisma

**Tech stack available:** prisma@7.2.0, jose (JWT)
**Established patterns:**
- Edge Runtime 미들웨어 (jose 사용)
- Role enum: ADMIN, USER, VIEWER
- JWT payload: { userId, username, role }

**Constraining decisions:**
- Phase 17: Role enum으로 ADMIN/USER/VIEWER 구분

**Issues being addressed:** None
</context>

<tasks>

<task type="auto">
  <name>Task 1: 역할 변경 서비스 함수 구현</name>
  <files>src/lib/user-service.ts</files>
  <action>
user-service.ts에 역할 관리 함수들을 추가합니다:

1. `updateUserRole(userId: string, role: Role)`: 역할 변경
   - Prisma update 호출
   - 변경된 User 반환 (passwordHash 제외)

2. `getAllUsers(options?: { skip?, take?, role? })`: 사용자 목록 조회
   - 페이지네이션 지원
   - 역할 필터링 지원
   - passwordHash 제외하여 반환

3. Zod 스키마 정의 (`UpdateRoleInput`):
   - role: "ADMIN" | "USER" | "VIEWER" (Prisma enum)

검증 규칙:
- 자기 자신의 역할은 변경 불가 (관리자 락아웃 방지)
- 마지막 ADMIN은 강등 불가
  </action>
  <verify>TypeScript 컴파일 성공, 함수 export 확인</verify>
  <done>updateUserRole, getAllUsers, UpdateRoleInput 구현 완료</done>
</task>

<task type="auto">
  <name>Task 2: 역할 변경 API 엔드포인트 구현</name>
  <files>src/app/api/admin/users/[id]/role/route.ts</files>
  <action>
PATCH /api/admin/users/[id]/role 엔드포인트를 구현합니다.

요청 Body:
```json
{
  "role": "USER"  // "ADMIN" | "USER" | "VIEWER"
}
```

처리 흐름:
1. JWT에서 요청자 정보 추출 (미들웨어 통과 후 쿠키에서)
2. 요청자 역할 검사 (ADMIN만 허용)
3. 대상 사용자 존재 확인 (findUserById)
4. 자기 자신 변경 시도 → 403 거부
5. 마지막 ADMIN 강등 시도 → 403 거부
6. 역할 변경 (updateUserRole)
7. 성공 응답: { success: true, user: { id, username, role } }

응답:
- 200: 성공
- 400: 유효하지 않은 역할
- 403: 권한 부족 / 자기 변경 / 마지막 관리자
- 404: 사용자 없음
- 500: 서버 오류

JWT에서 역할 추출:
```typescript
import { jwtVerify } from "jose";
const token = request.cookies.get("auth-token")?.value;
const { payload } = await jwtVerify(token, secret);
const requestorRole = payload.role;
```
  </action>
  <verify>
1. admin 계정으로 로그인
2. 다른 사용자 역할 변경 API 호출 → 200 성공
3. 자기 자신 역할 변경 시도 → 403 거부
  </verify>
  <done>역할 변경 API 동작, 권한 검사 작동, 자기 변경 방지</done>
</task>

<task type="auto">
  <name>Task 3: 미들웨어 역할 검사 강화</name>
  <files>src/middleware.ts</files>
  <action>
미들웨어에 관리자 전용 라우트 보호를 추가합니다.

변경 사항:
1. JWT payload에서 role 정보 추출
2. /api/admin/* 경로에 대해 ADMIN 역할 필수 검사
3. 권한 부족 시 403 응답 반환

기존 코드 확장:
```typescript
// verifyTokenEdge 함수 수정하여 payload 반환
async function verifyTokenEdge(token: string): Promise<{ valid: boolean; role?: string }> {
  try {
    const { payload } = await jwtVerify(token, secret);
    return {
      valid: true,
      role: payload.role as string
    };
  } catch {
    return { valid: false };
  }
}

// middleware 함수 내
const result = await verifyTokenEdge(token);
if (!result.valid) { /* 401 */ }

// Admin 라우트 추가 검사
if (pathname.startsWith("/api/admin/") && result.role !== "admin") {
  return NextResponse.json(
    { error: "관리자 권한이 필요합니다", code: "FORBIDDEN" },
    { status: 403 }
  );
}
```

주의: 기존 matcher에 /api/admin/* 경로가 이미 포함되어 있지 않다면 추가
  </action>
  <verify>
1. USER 역할로 로그인
2. /api/admin/* 경로 접근 시도 → 403 응답
3. ADMIN 역할로 로그인
4. /api/admin/* 경로 접근 → 200 성공
  </verify>
  <done>미들웨어 역할 검사 추가, 관리자 전용 라우트 보호</done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] `npm run build` 성공
- [ ] ADMIN 계정으로 타 사용자 역할 변경 성공
- [ ] USER 계정으로 역할 변경 시도 → 403 거부
- [ ] 자기 자신 역할 변경 시도 → 403 거부
- [ ] /api/admin/* 라우트 비관리자 접근 → 403 거부
</verification>

<success_criteria>

- 역할 변경 API 동작
- 관리자만 역할 변경 가능
- 자기 자신 역할 변경 방지
- 미들웨어 역할 검사 작동
- Phase 19 RBAC 준비 완료
</success_criteria>

<output>
After completion, create `.planning/phases/18-auth-system-extension/18-03-SUMMARY.md`:

# Phase 18 Plan 03: Role Management Summary

**[한 줄 요약]**

## Accomplishments

- [x] 역할 변경 서비스 함수 구현
- [x] 역할 변경 API 엔드포인트 구현
- [x] 미들웨어 역할 검사 강화

## Files Created/Modified

- `src/lib/user-service.ts` - updateUserRole, getAllUsers 추가
- `src/app/api/admin/users/[id]/role/route.ts` - 신규
- `src/middleware.ts` - 역할 검사 로직 추가

## Decisions Made

[결정 사항 또는 "None"]

## Issues Encountered

[문제점 및 해결 또는 "None"]

## Next Phase Readiness

Phase 18 complete. Ready for Phase 19 (RBAC Access Control)

**Phase 19 준비 상태:**
- 역할 검사 미들웨어 기반 구축됨
- 사용자 역할 변경 인프라 완료
- JWT payload에 role 정보 포함됨
</output>
