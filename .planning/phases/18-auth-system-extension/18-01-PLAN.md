---
phase: 18-auth-system-extension
plan: 01
type: execute
depends_on: []
files_modified: [src/app/api/auth/login/route.ts, src/app/api/auth/register/route.ts, src/lib/user-service.ts, src/lib/auth.ts]
---

<objective>
Core Auth Flow - 로그인 DB 전환 및 회원가입 API 구현

Purpose: Phase 17에서 구축한 DB 인프라를 활용하여 멀티 유저 인증 기반 마련
Output: DB 기반 로그인 API + 회원가입 API
</objective>

<execution_context>
~/.claude/get-shit-done/workflows/execute-plan.md
./summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/17-database-infrastructure/17-01-SUMMARY.md
@.planning/phases/17-database-infrastructure/17-02-SUMMARY.md

# Key files:
@src/lib/auth.ts
@src/lib/user-service.ts
@src/app/api/auth/login/route.ts
@prisma/schema.prisma

**Tech stack available:** prisma@7.2.0, jose, bcryptjs
**Established patterns:**
- Prisma 싱글톤 패턴
- authenticateUserFromDB() 함수 이미 구현됨
- UserDto 변환 패턴 (toUserDto)

**Constraining decisions:**
- Phase 17: 기존 admin-001 ID 유지로 JWT 호환성 확보
- Phase 17: authenticateUserFromDB vs authenticateUser 병행 운영

**Issues being addressed:** None
</context>

<tasks>

<task type="auto">
  <name>Task 1: 로그인 API DB 전환</name>
  <files>src/app/api/auth/login/route.ts</files>
  <action>
현재 `authenticateUser()` (레거시 환경변수 기반)를 `authenticateUserFromDB()` (DB 기반)로 전환합니다.

변경 사항:
1. import 변경: `authenticateUser, getAdminUser` → `authenticateUserFromDB`
2. 인증 호출 변경: `authenticateUser()` → `authenticateUserFromDB()`
3. 응답 구조 개선: DB에서 조회한 실제 사용자 정보 반환 (username, role)
4. findUserByUsername() 추가로 사용자 정보 조회

주의: 기존 JWT 토큰 구조 (userId, username, role)는 유지해야 합니다.
authenticateUserFromDB()가 이미 toUserDto()를 통해 호환성을 보장합니다.
  </action>
  <verify>
curl -X POST http://localhost:3000/api/auth/login \
  -H "Content-Type: application/json" \
  -d '{"username":"admin","password":"테스트비밀번호"}' \
  → 200 OK + Set-Cookie 헤더
  </verify>
  <done>DB 기반 로그인 동작, 기존 JWT 구조 유지, 레거시 함수 미사용</done>
</task>

<task type="auto">
  <name>Task 2: 회원가입 서비스 함수 구현</name>
  <files>src/lib/user-service.ts</files>
  <action>
user-service.ts에 회원가입을 위한 함수들을 추가합니다:

1. `createUser()` 함수 구현:
   - 파라미터: { email, username, password, displayName? }
   - 비밀번호 해싱: bcryptjs 사용 (hashPassword from auth.ts)
   - Prisma create 호출
   - 반환: 생성된 User (passwordHash 제외)

2. `isEmailTaken()`, `isUsernameTaken()` 중복 검사 함수 추가:
   - 존재 여부만 boolean 반환 (효율적 쿼리)

3. Zod 스키마 정의 (`RegisterInput`):
   - email: email 형식 검증
   - username: 3-20자, alphanumeric + underscore
   - password: 최소 8자
   - displayName: optional, 최대 50자

주의: Role은 기본값 USER로 설정 (관리자만 역할 변경 가능 - Plan 03)
  </action>
  <verify>TypeScript 컴파일 성공, 함수 export 확인</verify>
  <done>createUser, isEmailTaken, isUsernameTaken, RegisterInput 스키마 구현 완료</done>
</task>

<task type="auto">
  <name>Task 3: 회원가입 API 엔드포인트 구현</name>
  <files>src/app/api/auth/register/route.ts</files>
  <action>
POST /api/auth/register 엔드포인트를 구현합니다.

요청 Body:
```json
{
  "email": "user@example.com",
  "username": "newuser",
  "password": "securepassword",
  "displayName": "New User"  // optional
}
```

처리 흐름:
1. Zod 스키마로 입력 검증 (RegisterInput)
2. 이메일/사용자명 중복 검사 (isEmailTaken, isUsernameTaken)
3. createUser() 호출로 사용자 생성
4. 자동 로그인 처리 (JWT 토큰 발급 + httpOnly 쿠키 설정)
5. 성공 응답 반환

응답:
- 201: { success: true, user: { id, username, email, role } }
- 400: { success: false, error: "validation error details" }
- 409: { success: false, error: "Email/Username already exists" }
- 500: { success: false, error: "Internal server error" }

주의:
- passwordHash는 응답에 절대 포함하지 않음
- 비밀번호 해싱은 createUser 내부에서 처리
- Edge Runtime 호환성 주의 (bcryptjs는 Node.js 전용이므로 API Route에서만 사용)
  </action>
  <verify>
curl -X POST http://localhost:3000/api/auth/register \
  -H "Content-Type: application/json" \
  -d '{"email":"test@test.com","username":"testuser","password":"password123"}' \
  → 201 Created + Set-Cookie 헤더
  </verify>
  <done>회원가입 API 동작, 중복 검사 작동, 자동 로그인 처리</done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] `npm run build` 성공
- [ ] 기존 로그인 테스트 통과 (admin 계정)
- [ ] 신규 회원가입 → 로그인 플로우 동작
- [ ] 중복 이메일/사용자명 거부 확인
- [ ] JWT 토큰 구조 기존과 동일 (userId, username, role)
</verification>

<success_criteria>

- 로그인 API가 DB 기반으로 전환됨
- 회원가입 API가 동작함
- 중복 검사 로직 작동
- 기존 JWT 구조 호환성 유지
- TypeScript 에러 없음
</success_criteria>

<output>
After completion, create `.planning/phases/18-auth-system-extension/18-01-SUMMARY.md`:

# Phase 18 Plan 01: Core Auth Flow Summary

**[한 줄 요약]**

## Accomplishments

- [x] 로그인 API DB 전환
- [x] 회원가입 서비스 함수 구현
- [x] 회원가입 API 엔드포인트 구현

## Files Created/Modified

- `src/app/api/auth/login/route.ts` - DB 기반 인증으로 전환
- `src/lib/user-service.ts` - createUser, 중복 검사 함수 추가
- `src/app/api/auth/register/route.ts` - 회원가입 API 신규

## Decisions Made

[결정 사항 또는 "None"]

## Issues Encountered

[문제점 및 해결 또는 "None"]

## Next Step

Ready for 18-02-PLAN.md (Password Reset)
</output>
