---
phase: 18-auth-system-extension
plan: 02
type: execute
depends_on: []
files_modified: [prisma/schema.prisma, src/lib/user-service.ts, src/app/api/auth/forgot-password/route.ts, src/app/api/auth/reset-password/route.ts]
---

<objective>
Password Reset - 비밀번호 재설정 기능 구현

Purpose: 사용자가 비밀번호를 잊었을 때 이메일을 통해 재설정할 수 있는 기능 제공
Output: 비밀번호 재설정 요청 API + 완료 API + 토큰 모델
</objective>

<execution_context>
~/.claude/get-shit-done/workflows/execute-plan.md
./summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/17-database-infrastructure/17-02-SUMMARY.md

# Key files:
@src/lib/user-service.ts
@src/lib/auth.ts
@prisma/schema.prisma
@src/app/api/notifications/channels/email/route.ts

**Tech stack available:** prisma@7.2.0, Resend API (Phase 12에서 구현됨)
**Established patterns:**
- Prisma 싱글톤 패턴
- 이메일 발송: Resend API 사용 (sendEmail 함수)
- 토큰 검증: jose JWT 패턴

**Constraining decisions:**
- Phase 12: Resend API로 이메일 발송 구현됨

**Issues being addressed:** None
</context>

<tasks>

<task type="auto">
  <name>Task 1: PasswordResetToken 모델 추가</name>
  <files>prisma/schema.prisma, prisma migration</files>
  <action>
Prisma 스키마에 비밀번호 재설정 토큰 모델을 추가합니다.

```prisma
model PasswordResetToken {
  id        String   @id @default(cuid())
  token     String   @unique
  userId    String
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  expiresAt DateTime
  usedAt    DateTime?
  createdAt DateTime @default(now())
}
```

User 모델에 관계 추가:
```prisma
// User 모델 내
passwordResetTokens PasswordResetToken[]
```

마이그레이션 실행:
```bash
npx prisma migrate dev --name add_password_reset_token
```

토큰 특성:
- token: crypto.randomUUID() 또는 crypto.randomBytes(32).toString('hex')
- expiresAt: 생성 시점 + 1시간
- usedAt: 사용 시 기록 (재사용 방지)
  </action>
  <verify>npx prisma validate 성공, 마이그레이션 적용 확인</verify>
  <done>PasswordResetToken 모델 생성, User 관계 설정, 마이그레이션 완료</done>
</task>

<task type="auto">
  <name>Task 2: 비밀번호 재설정 토큰 서비스 구현</name>
  <files>src/lib/user-service.ts</files>
  <action>
user-service.ts에 비밀번호 재설정 관련 함수들을 추가합니다:

1. `createPasswordResetToken(userId: string)`: 토큰 생성
   - crypto.randomBytes(32).toString('hex')로 안전한 토큰 생성
   - 기존 미사용 토큰 삭제 (중복 방지)
   - 만료 시간: 1시간 후
   - 반환: { token, expiresAt }

2. `findValidPasswordResetToken(token: string)`: 토큰 검증
   - 토큰 조회 + 만료 시간 검사 + 사용 여부 확인
   - 반환: token 객체 (user 포함) 또는 null

3. `markTokenAsUsed(tokenId: string)`: 토큰 사용 처리
   - usedAt 필드 업데이트

4. `deleteExpiredTokens()`: 만료된 토큰 정리 (선택적)
   - 배치 작업용

주의: Node.js crypto 모듈 사용 (Edge Runtime 아님)
  </action>
  <verify>TypeScript 컴파일 성공, 함수 export 확인</verify>
  <done>토큰 생성/검증/사용 처리 함수 구현 완료</done>
</task>

<task type="auto">
  <name>Task 3: 비밀번호 재설정 요청 API 구현</name>
  <files>src/app/api/auth/forgot-password/route.ts</files>
  <action>
POST /api/auth/forgot-password 엔드포인트를 구현합니다.

요청 Body:
```json
{
  "email": "user@example.com"
}
```

처리 흐름:
1. 이메일 형식 검증 (Zod)
2. 사용자 조회 (findUserByEmail)
3. 사용자 존재 여부와 관계없이 동일한 응답 (타이밍 공격 방지)
4. 사용자 존재 시: 토큰 생성 + 이메일 발송
5. 성공 응답: { success: true, message: "이메일을 확인해주세요" }

이메일 내용:
- 제목: "[Home-KRDN] 비밀번호 재설정 요청"
- 본문: 재설정 링크 포함 (예: ${BASE_URL}/reset-password?token=${token})
- Resend API 사용 (기존 sendEmail 함수 활용 또는 직접 호출)

보안:
- 사용자 존재 여부 노출 금지 (항상 동일 응답)
- Rate limiting은 Phase 19 이후 고려
  </action>
  <verify>
curl -X POST http://localhost:3000/api/auth/forgot-password \
  -H "Content-Type: application/json" \
  -d '{"email":"admin@example.com"}' \
  → 200 OK
  </verify>
  <done>비밀번호 재설정 요청 API 동작, 이메일 발송 확인</done>
</task>

<task type="auto">
  <name>Task 4: 비밀번호 재설정 완료 API 구현</name>
  <files>src/app/api/auth/reset-password/route.ts</files>
  <action>
POST /api/auth/reset-password 엔드포인트를 구현합니다.

요청 Body:
```json
{
  "token": "reset-token-string",
  "password": "newSecurePassword123"
}
```

처리 흐름:
1. 입력 검증 (token 필수, password 8자 이상)
2. 토큰 검증 (findValidPasswordResetToken)
3. 토큰 무효 → 400 에러 (만료/사용됨/존재안함)
4. 비밀번호 해싱 (hashPassword)
5. 비밀번호 업데이트 (updatePasswordHash)
6. 토큰 사용 처리 (markTokenAsUsed)
7. 성공 응답: { success: true, message: "비밀번호가 변경되었습니다" }

보안:
- 토큰 1회 사용 후 무효화
- 에러 메시지에 상세 정보 노출 금지
  </action>
  <verify>
1. 비밀번호 재설정 요청으로 토큰 획득
2. 해당 토큰으로 비밀번호 변경 API 호출
3. 새 비밀번호로 로그인 성공 확인
  </verify>
  <done>비밀번호 재설정 완료 API 동작, 토큰 무효화 처리</done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] `npm run build` 성공
- [ ] `npx prisma validate` 성공
- [ ] 비밀번호 재설정 요청 → 이메일 발송 확인
- [ ] 유효한 토큰으로 비밀번호 변경 성공
- [ ] 만료/사용된 토큰 거부 확인
- [ ] 새 비밀번호로 로그인 성공
</verification>

<success_criteria>

- PasswordResetToken 모델 생성됨
- 비밀번호 재설정 요청 API 동작
- 이메일 발송 기능 연동
- 비밀번호 재설정 완료 API 동작
- 토큰 보안 (1회 사용, 만료 검사) 구현
</success_criteria>

<output>
After completion, create `.planning/phases/18-auth-system-extension/18-02-SUMMARY.md`:

# Phase 18 Plan 02: Password Reset Summary

**[한 줄 요약]**

## Accomplishments

- [x] PasswordResetToken 모델 추가
- [x] 토큰 서비스 함수 구현
- [x] 비밀번호 재설정 요청 API 구현
- [x] 비밀번호 재설정 완료 API 구현

## Files Created/Modified

- `prisma/schema.prisma` - PasswordResetToken 모델 추가
- `src/lib/user-service.ts` - 토큰 관련 함수 추가
- `src/app/api/auth/forgot-password/route.ts` - 신규
- `src/app/api/auth/reset-password/route.ts` - 신규

## Decisions Made

[결정 사항 또는 "None"]

## Issues Encountered

[문제점 및 해결 또는 "None"]

## Next Step

Ready for 18-03-PLAN.md (Role Management)
</output>
