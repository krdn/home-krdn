---
phase: 10-realtime-metrics
plan: 01
type: execute
depends_on: []
files_modified: [src/lib/websocket-server.ts, src/app/api/ws/route.ts, src/hooks/useRealtimeMetrics.ts, src/types/websocket.ts]
---

<objective>
시스템 메트릭(CPU, 메모리, 디스크)을 WebSocket으로 실시간 스트리밍

Purpose: 폴링 기반 메트릭 조회를 WebSocket 푸시로 전환하여 즉각적인 시스템 모니터링 제공
Output: 서버 브로드캐스트 로직 + useRealtimeMetrics 훅 + 타입 확장
</objective>

<execution_context>
~/.claude/get-shit-done/workflows/execute-plan.md
./summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md

# Phase 9 의존성 (WebSocket 인프라):
@.planning/phases/09-websocket-infrastructure/09-01-SUMMARY.md
@.planning/phases/09-websocket-infrastructure/09-02-SUMMARY.md

# 소스 파일 (수정 대상):
@src/lib/websocket-server.ts
@src/app/api/ws/route.ts
@src/hooks/useWebSocket.ts
@src/types/websocket.ts
@src/lib/system.ts

**Tech stack available:**
- ws@8.19.0 + next-ws@2.1.13
- Zod discriminatedUnion 메시지 타입
- useWebSocket 훅 (재연결, heartbeat)

**Established patterns:**
- 채널 기반 구독 (metrics, containers)
- broadcastToChannel() 유틸리티
- WSServerMessage discriminatedUnion

**Constraining decisions:**
- [09-01]: Zod discriminatedUnion으로 메시지 타입 분기
- [09-01]: Map 기반 클라이언트/구독 관리
- [09-02]: exponential backoff 재연결

**Issues being addressed:** None
</context>

<tasks>

<task type="auto">
  <name>Task 1: WebSocket 메트릭 타입 확장 및 서버 브로드캐스트 로직</name>
  <files>src/types/websocket.ts, src/lib/websocket-server.ts</files>
  <action>
1. **타입 확장** (src/types/websocket.ts):
   - WSMetricsMessageSchema.data를 src/lib/system.ts의 SystemMetrics 구조와 일치시킴
   - 현재 간략한 형태(cpu, memory, disk, uptime 숫자)를 확장:
     ```typescript
     data: z.object({
       cpu: z.object({
         usage: z.number(),
         cores: z.number(),
         loadAvg: z.array(z.number()),
       }),
       memory: z.object({
         total: z.number(),
         used: z.number(),
         free: z.number(),
         usage: z.number(),
       }),
       disk: z.object({
         total: z.number(),
         used: z.number(),
         free: z.number(),
         usage: z.number(),
         path: z.string(),
       }),
       uptime: z.number(),
       hostname: z.string(),
     })
     ```
   - 기존 간략 형태와 호환성 유지 위해 WSMetricsDataSimple (기존) / WSMetricsDataFull (확장) 구분 OR 확장 형태로 통일

2. **브로드캐스트 로직** (src/lib/websocket-server.ts):
   - `startMetricsBroadcast(intervalMs: number)` 함수 추가
     - setInterval로 주기적으로 getSystemMetrics() 호출
     - broadcastToChannel('metrics', message) 전송
     - 반환값: 정리용 cleanup 함수 (clearInterval)
   - `stopMetricsBroadcast()` 함수 추가
   - 모듈 레벨 변수로 브로드캐스트 인터벌 ID 관리

3. **구독 시 초기 데이터 전송**:
   - handleSubscribe()에서 channel === 'metrics'일 때 즉시 현재 메트릭 전송
   - 클라이언트가 구독 직후 데이터를 받을 수 있도록 함
  </action>
  <verify>
- npx tsc --noEmit: 타입 오류 없음
- src/lib/websocket-server.ts에 startMetricsBroadcast, stopMetricsBroadcast export 확인
  </verify>
  <done>
- WSMetricsMessageSchema.data가 확장된 메트릭 구조 포함
- startMetricsBroadcast() 함수가 주기적으로 메트릭 브로드캐스트
- metrics 채널 구독 시 즉시 현재 메트릭 전송
  </done>
</task>

<task type="auto">
  <name>Task 2: WebSocket 라우트에 메트릭 브로드캐스트 활성화</name>
  <files>src/app/api/ws/route.ts, src/config/constants.ts</files>
  <action>
1. **상수 추가** (src/config/constants.ts):
   - WEBSOCKET_CONFIG에 METRICS_BROADCAST_INTERVAL 추가 (기본값: 5000ms)
   - 기존 POLLING_INTERVALS.SYSTEM_METRICS와 동일하게 설정

2. **브로드캐스트 시작** (src/app/api/ws/route.ts):
   - 첫 번째 metrics 구독자가 등록될 때 브로드캐스트 시작
   - 마지막 metrics 구독자가 해제될 때 브로드캐스트 중지 (리소스 절약)
   - 방법: handleSubscribe/handleUnsubscribe에서 구독자 수 체크 후 start/stop 호출

3. **대안적 구현** (더 단순):
   - 서버 시작 시 무조건 브로드캐스트 시작 (구독자 없으면 broadcastToChannel이 0명에게 전송)
   - 이 방식이 더 단순하고 안전함 (경쟁 조건 없음)
   - 선택: 단순 구현 우선 (서버 시작 시 시작, 서버 종료 시 정리)

Note: next-ws는 모듈 로드 시점에 서버가 시작되므로, 파일 최상단에서 startMetricsBroadcast() 호출
  </action>
  <verify>
- npm run build: 빌드 성공
- 개발 서버 시작 후 /api/ws GET 요청 시 connectedClients 정보 반환
- 콘솔에 "[WS] Metrics broadcast started" 로그 확인
  </verify>
  <done>
- WEBSOCKET_CONFIG.METRICS_BROADCAST_INTERVAL 상수 추가
- 서버 시작 시 메트릭 브로드캐스트 자동 시작
- 정리 로직 존재 (서버 종료 시)
  </done>
</task>

<task type="auto">
  <name>Task 3: useRealtimeMetrics 훅 구현</name>
  <files>src/hooks/useRealtimeMetrics.ts</files>
  <action>
1. **새 훅 생성** (src/hooks/useRealtimeMetrics.ts):
   - useWebSocket 훅을 래핑하여 metrics 채널 전용 훅 제공
   - 기존 useSystemMetrics와 동일한 반환 형태 유지 (backward compatibility)

2. **구현 세부사항**:
   ```typescript
   export function useRealtimeMetrics(options?: UseRealtimeMetricsOptions) {
     const [metrics, setMetrics] = useState<SystemMetricsData | null>(null);
     const [error, setError] = useState<string | null>(null);

     const { connectionStatus, sendMessage } = useWebSocket({
       onConnected: () => {
         // 연결 시 metrics 채널 구독
         sendMessage(createSubscribeMessage('metrics'));
       },
       onMessage: (msg) => {
         if (isMetricsMessage(msg)) {
           // WSMetricsMessage.data를 SystemMetricsData 형태로 변환
           setMetrics(transformMetricsData(msg.data));
         } else if (isErrorMessage(msg)) {
           setError(msg.message);
         }
       },
     });

     return {
       data: metrics,
       loading: connectionStatus === 'connecting',
       error,
       connectionStatus,
       // fallback to polling 옵션 제공
     };
   }
   ```

3. **폴링 Fallback 옵션**:
   - `enableFallback?: boolean` 옵션 추가
   - WebSocket 연결 실패 또는 error 상태 시 기존 useSystemMetrics로 자동 전환
   - 기본값: true (안정성 보장)

4. **export 추가**:
   - src/hooks/index.ts에 useRealtimeMetrics export 추가 (있다면)
  </action>
  <verify>
- npx tsc --noEmit: 타입 오류 없음
- useRealtimeMetrics 훅이 data, loading, error, connectionStatus 반환
  </verify>
  <done>
- useRealtimeMetrics 훅이 WebSocket 기반 실시간 메트릭 제공
- 기존 useSystemMetrics와 호환되는 반환 형태
- 폴링 fallback 옵션 존재
  </done>
</task>

</tasks>

<verification>
Before declaring phase complete:
- [ ] `npm run build` 성공
- [ ] `npx tsc --noEmit` 타입 오류 없음 (기존 테스트 파일 제외)
- [ ] WebSocket 서버가 5초마다 메트릭 브로드캐스트
- [ ] useRealtimeMetrics 훅이 기존 API 형태와 호환
</verification>

<success_criteria>
- All tasks completed
- All verification checks pass
- 메트릭 브로드캐스트 로직이 구독자에게 실시간 데이터 전송
- useRealtimeMetrics가 useSystemMetrics와 동일한 인터페이스 제공
- Phase 10 complete
</success_criteria>

<output>
After completion, create `.planning/phases/10-realtime-metrics/10-01-SUMMARY.md`:

# Phase 10 Plan 01: Real-time Metrics Summary

**[Substantive one-liner]**

## Accomplishments
- [Key outcome 1]
- [Key outcome 2]

## Files Created/Modified
- `path/to/file.ts` - Description

## Decisions Made
[Key decisions and rationale]

## Issues Encountered
[Problems and resolutions, or "None"]

## Next Step
Ready for Phase 11 (Real-time Containers)
</output>
