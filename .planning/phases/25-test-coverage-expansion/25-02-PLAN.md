---
phase: 25-test-coverage-expansion
plan: 02
type: execute
depends_on: []
files_modified: [src/lib/rbac.test.ts, src/lib/auth.test.ts]
---

<objective>
RBAC 권한 시스템과 인증 로직의 단위 테스트로 보안 핵심 영역 검증

Purpose: 권한 검사 및 인증 로직은 보안의 핵심이므로 철저한 테스트로 신뢰성 확보
Output: rbac.test.ts, auth.test.ts 생성 (각 15+ 테스트 케이스)
</objective>

<execution_context>
~/.claude/get-shit-done/workflows/execute-plan.md
~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@src/lib/rbac.ts
@src/lib/auth.ts
@src/types/auth.ts

**기존 테스트 패턴:**
@src/lib/utils.test.ts
@src/app/api/auth/session/route.test.ts

**Phase 19 RBAC 결정:**
- 역할: admin, member, guest
- 권한 매트릭스: ROLE_PERMISSIONS 객체
- checkPermission, hasRole 함수

**Phase 18 Auth 결정:**
- JWT 인증 (jose 라이브러리)
- verifyToken, createToken 함수
- bcryptjs 비밀번호 해싱
</context>

<tasks>

<task type="auto">
  <name>Task 1: rbac.ts 단위 테스트 작성</name>
  <files>src/lib/rbac.test.ts</files>
  <action>
    RBAC 핵심 함수들의 단위 테스트 작성:

    1. hasRole 테스트:
       - admin 역할 확인
       - member 역할 확인
       - guest 역할 확인
       - 잘못된 역할 처리

    2. checkPermission 테스트:
       - admin의 모든 권한 허용
       - member의 제한된 권한
       - guest의 읽기 전용 권한
       - 존재하지 않는 권한 처리

    3. ROLE_PERMISSIONS 상수 테스트:
       - 각 역할별 권한 목록 검증
       - 권한 계층 확인 (admin > member > guest)

    4. 엣지 케이스:
       - null/undefined 역할
       - 빈 문자열 역할
       - 대소문자 처리

    테스트 구조:
    ```typescript
    import { describe, it, expect } from 'vitest';
    import { hasRole, checkPermission, ROLE_PERMISSIONS } from './rbac';

    describe('rbac', () => {
      describe('hasRole', () => {
        it('should return true for valid admin role', () => {...});
      });
      describe('checkPermission', () => {
        it('should allow admin to manage users', () => {...});
      });
    });
    ```

    AVOID: 실제 DB 호출 (순수 로직 테스트만)
    WHY: 단위 테스트는 외부 의존성 없이 빠르게 실행되어야 함
  </action>
  <verify>npm run test:run -- src/lib/rbac.test.ts 모든 테스트 PASS</verify>
  <done>rbac.test.ts 생성, 15개 이상 테스트 케이스, 모든 테스트 통과</done>
</task>

<task type="auto">
  <name>Task 2: auth.ts 단위 테스트 작성</name>
  <files>src/lib/auth.test.ts</files>
  <action>
    인증 핵심 함수들의 단위 테스트 작성:

    1. createToken 테스트:
       - 유효한 payload로 토큰 생성
       - 토큰 만료 시간 설정
       - 필수 클레임 포함 확인

    2. verifyToken 테스트:
       - 유효한 토큰 검증 성공
       - 만료된 토큰 검증 실패
       - 잘못된 서명 토큰 검증 실패
       - 형식이 잘못된 토큰 처리

    3. hashPassword / comparePassword 테스트 (있다면):
       - 비밀번호 해싱
       - 해시 비교 성공/실패

    4. 엣지 케이스:
       - 빈 payload
       - 특수 문자가 포함된 데이터
       - JWT_SECRET 없을 때 처리

    환경 변수 mocking:
    ```typescript
    import { vi, beforeEach, afterEach } from 'vitest';

    beforeEach(() => {
      vi.stubEnv('JWT_SECRET', 'test-secret-key-for-testing');
    });

    afterEach(() => {
      vi.unstubAllEnvs();
    });
    ```

    AVOID: 실제 JWT_SECRET 사용
    WHY: 테스트 환경과 프로덕션 환경 분리
  </action>
  <verify>npm run test:run -- src/lib/auth.test.ts 모든 테스트 PASS</verify>
  <done>auth.test.ts 생성, 15개 이상 테스트 케이스, 모든 테스트 통과</done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] `npm run test:run` 전체 테스트 통과
- [ ] rbac.test.ts 15개 이상 테스트 케이스
- [ ] auth.test.ts 15개 이상 테스트 케이스
- [ ] 엣지 케이스 포함 (null, undefined, 빈 문자열)
- [ ] 보안 관련 시나리오 테스트 (만료 토큰, 잘못된 서명)
</verification>

<success_criteria>
- rbac.ts 핵심 함수 모두 테스트됨
- auth.ts 핵심 함수 모두 테스트됨
- 보안 엣지 케이스 처리 검증됨
- 모든 테스트 통과
</success_criteria>

<output>
After completion, create `.planning/phases/25-test-coverage-expansion/25-02-SUMMARY.md`:

# Phase 25 Plan 02: Auth & RBAC Tests Summary

**[실질적 한 줄 요약]**

## Accomplishments
- rbac.ts 테스트 완료
- auth.ts 테스트 완료

## Files Created/Modified
- `src/lib/rbac.test.ts` - RBAC 테스트 (신규)
- `src/lib/auth.test.ts` - Auth 테스트 (신규)

## Decisions Made
[결정 사항]

## Issues Encountered
[이슈]

## Next Step
Ready for 25-03-PLAN.md (Service Layer Tests)
</output>
