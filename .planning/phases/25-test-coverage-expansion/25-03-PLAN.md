---
phase: 25-test-coverage-expansion
plan: 03
type: execute
depends_on: []
files_modified: [src/lib/user-service.test.ts, src/lib/settings-service.test.ts]
---

<objective>
Service Layer 테스트로 비즈니스 로직 검증 - user-service와 settings-service 중심

Purpose: 서비스 레이어는 비즈니스 로직의 핵심이므로 테스트로 데이터 무결성과 로직 정확성 보장
Output: user-service.test.ts, settings-service.test.ts 생성 (각 10+ 테스트 케이스)
</objective>

<execution_context>
~/.claude/get-shit-done/workflows/execute-plan.md
~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@src/lib/user-service.ts
@src/lib/settings-service.ts
@src/lib/prisma.ts

**기존 테스트 패턴:**
@src/lib/utils.test.ts
@src/app/api/auth/session/route.test.ts

**Phase 17-20 서비스 결정:**
- Prisma ORM 사용
- user-service: CRUD, 역할 관리
- settings-service: 사용자 설정 저장/조회

**Mocking 전략:**
- Prisma client mock 필요 (vi.mock)
- 실제 DB 호출 없이 테스트
</context>

<tasks>

<task type="auto">
  <name>Task 1: user-service.ts 단위 테스트 작성</name>
  <files>src/lib/user-service.test.ts</files>
  <action>
    user-service 핵심 함수들의 단위 테스트 작성 (Prisma mocking):

    1. getUserById 테스트:
       - 존재하는 사용자 조회
       - 존재하지 않는 사용자 처리 (null 반환)
       - ID 형식 검증

    2. getUserByEmail 테스트:
       - 이메일로 사용자 조회
       - 대소문자 처리
       - 잘못된 이메일 형식

    3. createUser 테스트:
       - 새 사용자 생성
       - 중복 이메일 처리
       - 필수 필드 검증

    4. updateUserRole 테스트:
       - 역할 변경 성공
       - 잘못된 역할 처리
       - 존재하지 않는 사용자

    Prisma mocking 패턴:
    ```typescript
    import { vi, beforeEach } from 'vitest';
    import { prisma } from './prisma';

    vi.mock('./prisma', () => ({
      prisma: {
        user: {
          findUnique: vi.fn(),
          findFirst: vi.fn(),
          create: vi.fn(),
          update: vi.fn(),
        },
      },
    }));

    beforeEach(() => {
      vi.clearAllMocks();
    });
    ```

    AVOID: 실제 DB 연결 테스트 (통합 테스트 영역)
    WHY: 단위 테스트는 빠르고 격리되어야 함
  </action>
  <verify>npm run test:run -- src/lib/user-service.test.ts 모든 테스트 PASS</verify>
  <done>user-service.test.ts 생성, 10개 이상 테스트 케이스, 모든 테스트 통과</done>
</task>

<task type="auto">
  <name>Task 2: settings-service.ts 단위 테스트 작성</name>
  <files>src/lib/settings-service.test.ts</files>
  <action>
    settings-service 핵심 함수들의 단위 테스트 작성:

    1. getUserSettings 테스트:
       - 기존 설정 조회
       - 설정 없는 경우 기본값 반환
       - 사용자 ID 검증

    2. updateUserSettings 테스트:
       - 테마 설정 업데이트
       - 위젯 설정 업데이트
       - 부분 업데이트 (일부 필드만)

    3. getDefaultSettings 테스트:
       - 기본 설정값 구조 검증
       - 모든 필수 필드 포함 확인

    4. 엣지 케이스:
       - 잘못된 설정값 타입
       - 빈 설정 객체
       - null 사용자 ID

    Prisma mocking (UserSettings 모델):
    ```typescript
    vi.mock('./prisma', () => ({
      prisma: {
        userSettings: {
          findUnique: vi.fn(),
          upsert: vi.fn(),
        },
      },
    }));
    ```

    AVOID: 복잡한 중첩 설정 테스트 (JSON 필드)
    WHY: 단순한 케이스부터 시작, 점진적 확장
  </action>
  <verify>npm run test:run -- src/lib/settings-service.test.ts 모든 테스트 PASS</verify>
  <done>settings-service.test.ts 생성, 10개 이상 테스트 케이스, 모든 테스트 통과</done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] `npm run test:run` 전체 테스트 통과
- [ ] user-service.test.ts 10개 이상 테스트 케이스
- [ ] settings-service.test.ts 10개 이상 테스트 케이스
- [ ] Prisma mock 정상 동작
- [ ] 엣지 케이스 처리 검증
</verification>

<success_criteria>
- user-service 핵심 CRUD 함수 테스트됨
- settings-service 설정 관리 함수 테스트됨
- Prisma mocking 패턴 확립
- 모든 테스트 통과
</success_criteria>

<output>
After completion, create `.planning/phases/25-test-coverage-expansion/25-03-SUMMARY.md`:

# Phase 25 Plan 03: Service Layer Tests Summary

**[실질적 한 줄 요약]**

## Accomplishments
- user-service.ts 테스트 완료
- settings-service.ts 테스트 완료

## Files Created/Modified
- `src/lib/user-service.test.ts` - User Service 테스트 (신규)
- `src/lib/settings-service.test.ts` - Settings Service 테스트 (신규)

## Decisions Made
[결정 사항]

## Issues Encountered
[이슈]

## Next Step
Ready for 25-04-PLAN.md (API Routes & Coverage Check)
</output>
