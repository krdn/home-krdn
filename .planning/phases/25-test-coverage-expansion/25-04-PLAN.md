---
phase: 25-test-coverage-expansion
plan: 04
type: execute
depends_on: ["25-01", "25-02", "25-03"]
files_modified: [src/app/api/auth/login/route.test.ts, src/app/api/auth/register/route.test.ts, src/app/api/docker/containers/route.test.ts]
---

<objective>
API Routes 테스트 확장 및 최종 커버리지 검증으로 Phase 25 완료

Purpose: 주요 API 엔드포인트 테스트로 통합 수준의 신뢰성 확보, 60% 커버리지 목표 달성 확인
Output: 3개 API route 테스트 파일 생성, 최종 커버리지 60% 이상 확인
</objective>

<execution_context>
~/.claude/get-shit-done/workflows/execute-plan.md
~/.claude/get-shit-done/templates/summary.md
~/.claude/get-shit-done/references/checkpoints.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@src/app/api/auth/login/route.ts
@src/app/api/auth/register/route.ts
@src/app/api/docker/containers/route.ts

**기존 API 테스트 패턴:**
@src/app/api/system/route.test.ts
@src/app/api/auth/session/route.test.ts

**이전 Plan 결과 (depends_on):**
- 25-01: Coverage 설정 완료, alertEngine 테스트
- 25-02: rbac, auth 테스트
- 25-03: user-service, settings-service 테스트
</context>

<tasks>

<task type="auto">
  <name>Task 1: Auth Login API 테스트 작성</name>
  <files>src/app/api/auth/login/route.test.ts</files>
  <action>
    POST /api/auth/login 엔드포인트 테스트:

    1. 성공 케이스:
       - 올바른 자격 증명으로 로그인 성공
       - JWT 토큰 반환 확인
       - 응답 구조 검증 (success, user 객체)

    2. 실패 케이스:
       - 잘못된 이메일
       - 잘못된 비밀번호
       - 존재하지 않는 사용자

    3. 입력 검증:
       - 빈 이메일
       - 빈 비밀번호
       - 잘못된 이메일 형식

    Mocking 필요:
    - user-service.getUserByEmail
    - auth.comparePassword
    - auth.createToken

    기존 패턴 따르기:
    ```typescript
    import { describe, it, expect, vi, beforeEach } from 'vitest';
    import { POST } from './route';
    import { NextRequest } from 'next/server';

    vi.mock('@/lib/user-service');
    vi.mock('@/lib/auth');

    describe('POST /api/auth/login', () => {
      it('should return token for valid credentials', async () => {
        const request = new NextRequest('http://localhost/api/auth/login', {
          method: 'POST',
          body: JSON.stringify({ email: 'test@test.com', password: 'password' }),
        });
        const response = await POST(request);
        expect(response.status).toBe(200);
      });
    });
    ```
  </action>
  <verify>npm run test:run -- src/app/api/auth/login/route.test.ts 모든 테스트 PASS</verify>
  <done>login route 테스트 8개 이상, 모든 테스트 통과</done>
</task>

<task type="auto">
  <name>Task 2: Auth Register API 테스트 작성</name>
  <files>src/app/api/auth/register/route.test.ts</files>
  <action>
    POST /api/auth/register 엔드포인트 테스트:

    1. 성공 케이스:
       - 새 사용자 등록 성공
       - 응답에 사용자 정보 포함
       - 비밀번호가 응답에 포함되지 않음

    2. 실패 케이스:
       - 이미 존재하는 이메일
       - 비밀번호 정책 위반 (너무 짧음)

    3. 입력 검증:
       - 필수 필드 누락
       - 이메일 형식 검증
       - 이름 길이 검증

    Mocking:
    - user-service.getUserByEmail (중복 체크)
    - user-service.createUser
    - auth.hashPassword
  </action>
  <verify>npm run test:run -- src/app/api/auth/register/route.test.ts 모든 테스트 PASS</verify>
  <done>register route 테스트 8개 이상, 모든 테스트 통과</done>
</task>

<task type="auto">
  <name>Task 3: Docker Containers API 테스트 작성</name>
  <files>src/app/api/docker/containers/route.test.ts</files>
  <action>
    GET /api/docker/containers 엔드포인트 테스트:

    1. 성공 케이스:
       - 컨테이너 목록 반환
       - 각 컨테이너 필드 검증 (id, name, status, image)

    2. 에러 케이스:
       - Docker 소켓 연결 실패
       - Docker daemon 응답 에러

    3. 필터링 (있다면):
       - running 상태만 필터
       - 특정 이미지 필터

    Mocking:
    - docker.listContainers 함수

    ```typescript
    vi.mock('@/lib/docker', () => ({
      listContainers: vi.fn(),
    }));
    ```

    AVOID: 실제 Docker 소켓 연결
    WHY: 테스트 환경에 Docker가 없을 수 있음
  </action>
  <verify>npm run test:run -- src/app/api/docker/containers/route.test.ts 모든 테스트 PASS</verify>
  <done>docker containers route 테스트 6개 이상, 모든 테스트 통과</done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>
    Phase 25 전체 테스트 커버리지:
    - 25-01: Coverage 설정 + alertEngine TDD
    - 25-02: rbac + auth 테스트
    - 25-03: user-service + settings-service 테스트
    - 25-04: API routes 테스트 (login, register, docker/containers)
  </what-built>
  <how-to-verify>
    1. 터미널에서 실행:
       ```
       npm run test:coverage -- --run
       ```
    2. 커버리지 결과 확인:
       - Statements: 60% 이상
       - Lines: 60% 이상
       - 또는 coverage/index.html 열어서 상세 확인
    3. 테스트 수 확인:
       - 총 테스트 케이스 수 (기존 103개 + 신규 ~80개 = ~180개 이상)
    4. 모든 테스트 PASS 확인
  </how-to-verify>
  <resume-signal>
    커버리지 60% 이상이면 "approved" 입력.
    부족하면 어떤 영역이 낮은지 알려주세요.
  </resume-signal>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] `npm run test:run` 전체 테스트 통과
- [ ] `npm run test:coverage` 60% 이상 달성
- [ ] login route 테스트 8개 이상
- [ ] register route 테스트 8개 이상
- [ ] docker/containers route 테스트 6개 이상
- [ ] 사용자 커버리지 확인 완료 (checkpoint)
</verification>

<success_criteria>
- 전체 테스트 통과
- 커버리지 60% 목표 달성
- API 엔드포인트 핵심 로직 검증됨
- Phase 25 complete
</success_criteria>

<output>
After completion, create `.planning/phases/25-test-coverage-expansion/25-04-SUMMARY.md`:

# Phase 25 Plan 04: API Routes & Coverage Check Summary

**[실질적 한 줄 요약 - 최종 커버리지 수치 포함]**

## Accomplishments
- Auth Login API 테스트 완료
- Auth Register API 테스트 완료
- Docker Containers API 테스트 완료
- 최종 커버리지: XX% (목표 60%)

## Files Created/Modified
- `src/app/api/auth/login/route.test.ts` (신규)
- `src/app/api/auth/register/route.test.ts` (신규)
- `src/app/api/docker/containers/route.test.ts` (신규)

## Decisions Made
[결정 사항]

## Issues Encountered
[이슈]

## Phase Complete
Phase 25 Test Coverage Expansion 완료. 다음: Phase 26 E2E Test Activation
</output>
