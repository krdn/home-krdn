---
phase: 24-offline-caching
plan: 01
type: execute
depends_on: [23-01]
files_modified: [public/sw.js, src/app/offline/page.tsx, src/hooks/useOnlineStatus.ts, src/components/pwa/OfflineIndicator.tsx]
domain: next-js
---

<objective>
오프라인 캐싱 전략을 개선하고 오프라인 사용자 경험을 향상시킵니다.

Purpose: 네트워크 연결이 불안정하거나 없을 때도 기본 기능 사용 가능
Output: 개선된 SW 캐싱 + 오프라인 폴백 페이지 + 오프라인 상태 UI
</objective>

<context>
@public/sw.js
@src/app/layout.tsx

**Tech stack available:** Next.js 16, TypeScript, React 19
**Established patterns:** Service Worker (Phase 22), PWA 컴포넌트
**Constraining decisions:**
- Phase 22: 기본 SW 캐싱 구현됨 (Network-first API, Cache-first 정적)
- Workbox 미사용: 직접 sw.js 확장 (의존성 최소화)

**Research findings (2026-01-15):**
- StaleWhileRevalidate: JS/CSS에 적합 (캐시 먼저, 백그라운드 업데이트)
- CacheFirst with expiration: 이미지에 적합 (캐시 우선, 만료 관리)
- 오프라인 폴백: 네비게이션 실패 시 /offline 페이지 표시

Sources:
- https://web.dev/learn/pwa/workbox
- https://www.getfishtank.com/insights/building-native-like-offline-experience-in-nextjs-pwas
</context>

<tasks>

<task type="auto">
  <name>Task 1: Service Worker 캐싱 전략 개선</name>
  <files>public/sw.js</files>
  <action>
1. public/sw.js 캐싱 전략 개선:

```javascript
// 캐시 이름 및 버전 관리
const CACHE_VERSION = 'v2';
const STATIC_CACHE = `static-${CACHE_VERSION}`;
const DYNAMIC_CACHE = `dynamic-${CACHE_VERSION}`;
const IMAGE_CACHE = `images-${CACHE_VERSION}`;

// 캐시 만료 설정 (1주일)
const IMAGE_CACHE_MAX_AGE = 7 * 24 * 60 * 60 * 1000;
const DYNAMIC_CACHE_MAX_ENTRIES = 50;

// 정적 자산 (프리캐시)
const STATIC_ASSETS = [
  '/',
  '/offline',
  '/icons/icon-192x192.png',
  '/icons/icon-512x512.png',
];

// Install: 정적 자산 프리캐시
self.addEventListener('install', (event) => {
  event.waitUntil(
    caches.open(STATIC_CACHE).then((cache) => cache.addAll(STATIC_ASSETS))
  );
  self.skipWaiting();
});

// Activate: 오래된 캐시 정리
self.addEventListener('activate', (event) => {
  event.waitUntil(
    caches.keys().then((keys) =>
      Promise.all(
        keys
          .filter((key) => !key.includes(CACHE_VERSION))
          .map((key) => caches.delete(key))
      )
    )
  );
  self.clients.claim();
});

// Fetch 전략
self.addEventListener('fetch', (event) => {
  const { request } = event;
  const url = new URL(request.url);

  // 다른 도메인 요청은 무시
  if (url.origin !== location.origin) return;

  // API 요청: Network-first (오프라인 시 에러 응답)
  if (url.pathname.startsWith('/api/')) {
    event.respondWith(networkFirst(request));
    return;
  }

  // 이미지: Cache-first with expiration
  if (isImageRequest(request)) {
    event.respondWith(cacheFirstWithExpiration(request, IMAGE_CACHE));
    return;
  }

  // JS/CSS: Stale-while-revalidate
  if (isStaticAsset(request)) {
    event.respondWith(staleWhileRevalidate(request, DYNAMIC_CACHE));
    return;
  }

  // 페이지 네비게이션: Network-first with offline fallback
  if (request.mode === 'navigate') {
    event.respondWith(networkFirstWithFallback(request));
    return;
  }

  // 기타: Network-first
  event.respondWith(networkFirst(request));
});

// 헬퍼 함수들...
```
  </action>
  <verify>npm run build 성공, SW 동작 확인</verify>
  <done>캐싱 전략 개선 완료</done>
</task>

<task type="auto">
  <name>Task 2: 오프라인 폴백 페이지</name>
  <files>src/app/offline/page.tsx</files>
  <action>
1. src/app/offline/page.tsx 생성:
```typescript
import { WifiOff, RefreshCw } from 'lucide-react';

export const metadata = {
  title: '오프라인 - Home Dashboard',
};

export default function OfflinePage() {
  return (
    <div className="min-h-screen flex items-center justify-center p-4">
      <div className="text-center max-w-md">
        <div className="mb-6 p-4 bg-muted rounded-full inline-block">
          <WifiOff className="w-12 h-12 text-muted-foreground" />
        </div>
        <h1 className="text-2xl font-bold mb-2">오프라인 상태</h1>
        <p className="text-muted-foreground mb-6">
          인터넷 연결이 없습니다. 연결을 확인하고 다시 시도해주세요.
        </p>
        <button
          onClick={() => window.location.reload()}
          className="inline-flex items-center gap-2 px-4 py-2 bg-primary text-primary-foreground rounded-lg hover:bg-primary/90 transition-colors"
        >
          <RefreshCw className="w-4 h-4" />
          다시 시도
        </button>
      </div>
    </div>
  );
}
```

2. 클라이언트 새로고침 버튼을 위한 클라이언트 컴포넌트 분리
  </action>
  <verify>/offline 페이지 접근 가능</verify>
  <done>오프라인 폴백 페이지 생성 완료</done>
</task>

<task type="auto">
  <name>Task 3: 오프라인 상태 UI</name>
  <files>src/hooks/useOnlineStatus.ts, src/components/pwa/OfflineIndicator.tsx, src/app/layout.tsx</files>
  <action>
1. src/hooks/useOnlineStatus.ts 생성:
```typescript
'use client';

import { useState, useEffect } from 'react';

export function useOnlineStatus() {
  const [isOnline, setIsOnline] = useState(true);

  useEffect(() => {
    setIsOnline(navigator.onLine);

    const handleOnline = () => setIsOnline(true);
    const handleOffline = () => setIsOnline(false);

    window.addEventListener('online', handleOnline);
    window.addEventListener('offline', handleOffline);

    return () => {
      window.removeEventListener('online', handleOnline);
      window.removeEventListener('offline', handleOffline);
    };
  }, []);

  return isOnline;
}
```

2. src/components/pwa/OfflineIndicator.tsx 생성:
```typescript
'use client';

import { motion, AnimatePresence } from 'framer-motion';
import { WifiOff } from 'lucide-react';
import { useOnlineStatus } from '@/hooks/useOnlineStatus';

export function OfflineIndicator() {
  const isOnline = useOnlineStatus();

  return (
    <AnimatePresence>
      {!isOnline && (
        <motion.div
          initial={{ opacity: 0, y: -50 }}
          animate={{ opacity: 1, y: 0 }}
          exit={{ opacity: 0, y: -50 }}
          className="fixed top-0 left-0 right-0 z-50 bg-destructive text-destructive-foreground py-2 px-4 text-center text-sm"
        >
          <div className="flex items-center justify-center gap-2">
            <WifiOff className="w-4 h-4" />
            <span>오프라인 상태입니다. 일부 기능이 제한될 수 있습니다.</span>
          </div>
        </motion.div>
      )}
    </AnimatePresence>
  );
}
```

3. layout.tsx에 OfflineIndicator 추가
4. pwa/index.ts 배럴 파일에 OfflineIndicator 추가
  </action>
  <verify>npm run build 성공, 오프라인 인디케이터 렌더링 확인</verify>
  <done>오프라인 상태 UI 구현 완료</done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] `npm run build` 빌드 성공
- [ ] /offline 페이지 접근 가능
- [ ] SW 캐싱 전략 동작 확인
- [ ] OfflineIndicator 컴포넌트 렌더링됨
</verification>

<success_criteria>

- Service Worker 캐싱 전략 개선 (버전 관리, 다양한 전략)
- 오프라인 폴백 페이지 구현
- 오프라인 상태 감지 및 UI 표시
- v2.0 마일스톤 완료
</success_criteria>

<output>
After completion, create `.planning/phases/24-offline-caching/24-01-SUMMARY.md`
Then update STATE.md and ROADMAP.md to mark v2.0 milestone complete.
</output>
