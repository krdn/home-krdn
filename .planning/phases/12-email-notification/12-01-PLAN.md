---
phase: 12-email-notification
plan: 01
type: execute
depends_on: []
files_modified: [src/types/notification.ts, src/app/api/notifications/email/route.ts, src/stores/notificationStore.ts, src/hooks/useAlertNotifications.ts, src/components/admin/EmailSettings.tsx, src/app/admin/alerts/page.tsx, src/config/constants.ts]
domain: notification
---

<objective>
이메일 알림 채널 구현 - 임계값 초과 시 Resend API를 통한 이메일 발송

Purpose: Critical 알림 발생 시 관리자에게 이메일로 알림하여 즉각적인 대응 가능
Output: 이메일 전송 API, 설정 UI, 기존 알림 시스템 통합
</objective>

<execution_context>
~/.claude/get-shit-done/workflows/execute-plan.md
./summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/12-email-notification/DISCOVERY.md

# 기존 알림 시스템 파일:
@src/types/alert.ts
@src/stores/alertStore.ts
@src/lib/alertEngine.ts
@src/hooks/useAlertNotifications.ts

# 관련 설정:
@src/config/constants.ts

**Tech stack available:** zustand, zod, @tanstack/react-query
**Established patterns:** Zustand persist, API Route with Zod validation
**Constraining decisions:**
- Resend API 사용 (DISCOVERY.md 결정)
- Critical 알림만 이메일 발송 (사용자 피로도 고려)
- 쿨다운 메커니즘 적용 (기존 alertEngine 패턴)
</context>

<tasks>

<task type="auto">
  <name>Task 1: 이메일 알림 타입 및 인프라 설정</name>
  <files>src/types/notification.ts, src/config/constants.ts, package.json</files>
  <action>
1. Resend SDK 설치: `npm install resend`

2. src/types/notification.ts 생성:
```typescript
// 알림 채널 타입 (이메일, Slack 등 확장 가능)
export type NotificationChannel = 'email' | 'slack' | 'toast' | 'browser';

// 이메일 알림 설정
export interface EmailNotificationConfig {
  enabled: boolean;
  recipientEmail: string;
  sendOnCriticalOnly: boolean; // true면 critical만 발송
  cooldownMinutes: number; // 같은 규칙 이메일 쿨다운
}

// 이메일 발송 요청 타입
export interface SendEmailRequest {
  to: string;
  subject: string;
  html: string;
  ruleId?: string; // 쿨다운 추적용
}

// 이메일 발송 응답 타입
export interface SendEmailResponse {
  success: boolean;
  messageId?: string;
  error?: string;
}
```

3. src/config/constants.ts에 EMAIL_CONFIG 추가:
```typescript
export const EMAIL_CONFIG = {
  DEFAULT_COOLDOWN_MINUTES: 30, // 같은 규칙 이메일 30분 쿨다운
  MAX_DAILY_EMAILS: 50, // 일일 발송 제한 (안전장치)
  SUBJECT_PREFIX: '[Home-KRDN]',
} as const;
```
  </action>
  <verify>npm install 성공, TypeScript 타입 체크 통과 (npx tsc --noEmit)</verify>
  <done>Resend 설치됨, notification 타입 정의됨, EMAIL_CONFIG 상수 추가됨</done>
</task>

<task type="auto">
  <name>Task 2: 이메일 전송 API Route 구현</name>
  <files>src/app/api/notifications/email/route.ts</files>
  <action>
1. src/app/api/notifications/email/route.ts 생성:
```typescript
import { NextResponse } from 'next/server';
import { Resend } from 'resend';
import { z } from 'zod';
import { EMAIL_CONFIG } from '@/config/constants';

// Resend 클라이언트 (API 키 없으면 null)
const resend = process.env.RESEND_API_KEY
  ? new Resend(process.env.RESEND_API_KEY)
  : null;

// 요청 스키마
const SendEmailSchema = z.object({
  to: z.string().email(),
  subject: z.string().min(1).max(200),
  html: z.string().min(1),
  ruleId: z.string().optional(),
});

// 이메일 쿨다운 추적 (인메모리)
const emailCooldowns = new Map<string, number>();

// 일일 발송 카운트 추적
let dailyEmailCount = 0;
let lastResetDate = new Date().toDateString();

// 일일 카운트 리셋 체크
function checkDailyReset(): void {
  const today = new Date().toDateString();
  if (today !== lastResetDate) {
    dailyEmailCount = 0;
    lastResetDate = today;
  }
}

// 쿨다운 체크
function isInCooldown(ruleId: string, cooldownMinutes: number): boolean {
  const lastSent = emailCooldowns.get(ruleId);
  if (!lastSent) return false;
  return Date.now() - lastSent < cooldownMinutes * 60 * 1000;
}

export async function POST(request: Request) {
  try {
    // API 키 체크
    if (!resend) {
      return NextResponse.json(
        { success: false, error: 'RESEND_API_KEY not configured' },
        { status: 503 }
      );
    }

    // 일일 제한 체크
    checkDailyReset();
    if (dailyEmailCount >= EMAIL_CONFIG.MAX_DAILY_EMAILS) {
      return NextResponse.json(
        { success: false, error: 'Daily email limit reached' },
        { status: 429 }
      );
    }

    // 요청 파싱 및 검증
    const body = await request.json();
    const result = SendEmailSchema.safeParse(body);

    if (!result.success) {
      return NextResponse.json(
        { success: false, error: result.error.message },
        { status: 400 }
      );
    }

    const { to, subject, html, ruleId } = result.data;

    // ruleId가 있으면 쿨다운 체크
    if (ruleId && isInCooldown(ruleId, EMAIL_CONFIG.DEFAULT_COOLDOWN_MINUTES)) {
      return NextResponse.json(
        { success: false, error: 'Email cooldown active for this rule' },
        { status: 429 }
      );
    }

    // 이메일 발송
    const response = await resend.emails.send({
      from: process.env.ALERT_EMAIL_FROM || 'alerts@resend.dev',
      to,
      subject: `${EMAIL_CONFIG.SUBJECT_PREFIX} ${subject}`,
      html,
    });

    // 성공 시 쿨다운 및 카운트 업데이트
    if (ruleId) {
      emailCooldowns.set(ruleId, Date.now());
    }
    dailyEmailCount++;

    return NextResponse.json({
      success: true,
      messageId: response.data?.id,
    });

  } catch (error) {
    console.error('[Email API] Send failed:', error);
    return NextResponse.json(
      { success: false, error: error instanceof Error ? error.message : 'Unknown error' },
      { status: 500 }
    );
  }
}
```

2. 환경 변수 템플릿 (.env.example에 추가 필요):
- RESEND_API_KEY: Resend API 키
- ALERT_EMAIL_FROM: 발신자 이메일 (기본값: alerts@resend.dev)
  </action>
  <verify>
curl -X POST http://localhost:3000/api/notifications/email \
  -H "Content-Type: application/json" \
  -d '{"to":"test@example.com","subject":"Test","html":"<p>Test</p>"}'
→ API 키 없으면 503 반환, 있으면 이메일 발송 시도
  </verify>
  <done>이메일 API Route 동작, Zod 검증, 쿨다운 적용, 일일 제한 동작</done>
</task>

<task type="auto">
  <name>Task 3: 알림 스토어 확장 및 훅 통합</name>
  <files>src/stores/notificationStore.ts, src/hooks/useAlertNotifications.ts</files>
  <action>
1. src/stores/notificationStore.ts 생성 (이메일 설정 전용 스토어):
```typescript
'use client';

import { create } from 'zustand';
import { persist } from 'zustand/middleware';
import type { EmailNotificationConfig } from '@/types/notification';
import { EMAIL_CONFIG } from '@/config/constants';

interface NotificationState {
  emailConfig: EmailNotificationConfig;
  updateEmailConfig: (config: Partial<EmailNotificationConfig>) => void;
  resetEmailConfig: () => void;
}

const defaultEmailConfig: EmailNotificationConfig = {
  enabled: false,
  recipientEmail: '',
  sendOnCriticalOnly: true,
  cooldownMinutes: EMAIL_CONFIG.DEFAULT_COOLDOWN_MINUTES,
};

export const useNotificationStore = create<NotificationState>()(
  persist(
    (set) => ({
      emailConfig: defaultEmailConfig,

      updateEmailConfig: (config) =>
        set((state) => ({
          emailConfig: { ...state.emailConfig, ...config },
        })),

      resetEmailConfig: () =>
        set({ emailConfig: defaultEmailConfig }),
    }),
    {
      name: 'notification-store',
    }
  )
);
```

2. src/hooks/useAlertNotifications.ts 수정 - 이메일 발송 로직 추가:

기존 `useAlertNotifications` 훅에 이메일 발송 로직 추가:
- useNotificationStore에서 emailConfig 가져오기
- Critical 알림 발생 시 이메일 설정 확인
- enabled && (sendOnCriticalOnly ? severity === 'critical' : true) 조건에서 이메일 발송
- 이메일 발송은 비동기로 처리 (UI 블로킹 방지)

```typescript
// 이메일 발송 함수 추가
async function sendAlertEmail(
  alert: NewAlert,
  recipientEmail: string
): Promise<void> {
  try {
    const response = await fetch('/api/notifications/email', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({
        to: recipientEmail,
        subject: `${alert.severity.toUpperCase()}: ${alert.ruleName}`,
        html: `
          <h2>${alert.ruleName}</h2>
          <p>${alert.message}</p>
          <p><strong>심각도:</strong> ${alert.severity}</p>
          <p><strong>현재 값:</strong> ${alert.value.toFixed(1)}%</p>
          <p><strong>임계값:</strong> ${alert.threshold}%</p>
          <p><small>발생 시각: ${new Date().toLocaleString('ko-KR')}</small></p>
        `,
        ruleId: alert.ruleId,
      }),
    });

    if (!response.ok) {
      const data = await response.json();
      console.warn('[Alert Email] Failed:', data.error);
    }
  } catch (error) {
    console.error('[Alert Email] Error:', error);
  }
}

// useAlertNotifications 훅 내부에서:
// const { emailConfig } = useNotificationStore();
// 알림 처리 루프에서 이메일 발송 조건 추가
```
  </action>
  <verify>
1. npm run build 성공
2. 알림 발생 시 콘솔에서 이메일 API 호출 확인
3. 이메일 설정 비활성화 시 API 호출 없음
  </verify>
  <done>notificationStore 생성됨, useAlertNotifications에 이메일 통합됨</done>
</task>

<task type="auto">
  <name>Task 4: 이메일 설정 UI 컴포넌트</name>
  <files>src/components/admin/EmailSettings.tsx, src/app/admin/alerts/page.tsx</files>
  <action>
1. src/components/admin/EmailSettings.tsx 생성:
```typescript
'use client';

import { Mail, Settings, Check } from 'lucide-react';
import { useNotificationStore } from '@/stores/notificationStore';
import { useState } from 'react';

export function EmailSettings() {
  const { emailConfig, updateEmailConfig } = useNotificationStore();
  const [email, setEmail] = useState(emailConfig.recipientEmail);
  const [saved, setSaved] = useState(false);

  const handleSave = () => {
    updateEmailConfig({ recipientEmail: email });
    setSaved(true);
    setTimeout(() => setSaved(false), 2000);
  };

  return (
    <div className="rounded-lg border border-border bg-card p-6">
      <div className="flex items-center gap-2 mb-4">
        <Mail className="h-5 w-5 text-primary" />
        <h3 className="font-semibold">이메일 알림 설정</h3>
      </div>

      <div className="space-y-4">
        {/* 활성화 토글 */}
        <label className="flex items-center justify-between">
          <span>이메일 알림 활성화</span>
          <button
            onClick={() => updateEmailConfig({ enabled: !emailConfig.enabled })}
            className={`relative w-11 h-6 rounded-full transition-colors ${
              emailConfig.enabled ? 'bg-primary' : 'bg-muted'
            }`}
          >
            <span
              className={`absolute top-0.5 left-0.5 w-5 h-5 bg-white rounded-full transition-transform ${
                emailConfig.enabled ? 'translate-x-5' : ''
              }`}
            />
          </button>
        </label>

        {/* 수신 이메일 */}
        <div>
          <label className="block text-sm text-muted-foreground mb-1">
            수신 이메일
          </label>
          <div className="flex gap-2">
            <input
              type="email"
              value={email}
              onChange={(e) => setEmail(e.target.value)}
              placeholder="admin@example.com"
              className="flex-1 px-3 py-2 rounded-md border border-border bg-background"
              disabled={!emailConfig.enabled}
            />
            <button
              onClick={handleSave}
              disabled={!emailConfig.enabled || !email}
              className="px-4 py-2 bg-primary text-primary-foreground rounded-md disabled:opacity-50"
            >
              {saved ? <Check className="h-4 w-4" /> : '저장'}
            </button>
          </div>
        </div>

        {/* Critical만 발송 옵션 */}
        <label className="flex items-center justify-between">
          <span className="text-sm">Critical 알림만 이메일 발송</span>
          <input
            type="checkbox"
            checked={emailConfig.sendOnCriticalOnly}
            onChange={(e) => updateEmailConfig({ sendOnCriticalOnly: e.target.checked })}
            disabled={!emailConfig.enabled}
            className="w-4 h-4"
          />
        </label>

        {/* 쿨다운 설정 */}
        <div>
          <label className="block text-sm text-muted-foreground mb-1">
            이메일 쿨다운 (분)
          </label>
          <input
            type="number"
            value={emailConfig.cooldownMinutes}
            onChange={(e) => updateEmailConfig({ cooldownMinutes: parseInt(e.target.value) || 30 })}
            min={5}
            max={120}
            className="w-24 px-3 py-2 rounded-md border border-border bg-background"
            disabled={!emailConfig.enabled}
          />
        </div>

        {/* 안내 메시지 */}
        <p className="text-xs text-muted-foreground">
          * RESEND_API_KEY 환경 변수가 설정되어야 이메일이 발송됩니다.
        </p>
      </div>
    </div>
  );
}
```

2. src/app/admin/alerts/page.tsx 수정:
- EmailSettings 컴포넌트 import
- 알림 규칙 섹션 아래에 이메일 설정 섹션 추가
  </action>
  <verify>
1. npm run dev로 개발 서버 실행
2. /admin/alerts 페이지에서 이메일 설정 UI 표시 확인
3. 토글, 입력, 저장 기능 동작 확인
  </verify>
  <done>EmailSettings 컴포넌트 렌더링됨, 설정 변경 시 store 업데이트됨</done>
</task>

</tasks>

<verification>
Before declaring phase complete:
- [ ] `npm run build` 성공
- [ ] `npx tsc --noEmit` 타입 에러 없음
- [ ] /api/notifications/email POST 요청 처리됨
- [ ] /admin/alerts 페이지에 이메일 설정 UI 표시됨
- [ ] 이메일 설정 변경이 localStorage에 저장됨
- [ ] Critical 알림 발생 시 이메일 API 호출됨 (설정 활성화 시)
</verification>

<success_criteria>

- 모든 Task 완료
- 빌드 및 타입 체크 통과
- 이메일 설정 UI 동작
- 이메일 API Route 응답 정상
- Phase 12 complete
</success_criteria>

<output>
After completion, create `.planning/phases/12-email-notification/12-01-SUMMARY.md`:

# Phase 12 Plan 01: 이메일 알림 채널 Summary

**[Substantive one-liner - what shipped]**

## Accomplishments

- [Key outcome 1]
- [Key outcome 2]

## Files Created/Modified

- `path/to/file.ts` - Description

## Decisions Made

[Key decisions and rationale, or "None"]

## Issues Encountered

[Problems and resolutions, or "None"]

## Next Step

Ready for Phase 13 (Slack Integration)
</output>
