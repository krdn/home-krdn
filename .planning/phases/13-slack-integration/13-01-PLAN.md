---
phase: 13-slack-integration
plan: 01
type: execute
depends_on: []
files_modified: [src/types/notification.ts, src/app/api/notifications/slack/route.ts, src/stores/notificationStore.ts, src/hooks/useAlertNotifications.ts, src/components/admin/SlackSettings.tsx, src/app/admin/alerts/page.tsx, src/config/constants.ts]
domain: notification
---

<objective>
Slack ì›¹í›… ì•Œë¦¼ ì±„ë„ êµ¬í˜„ - ì„ê³„ê°’ ì´ˆê³¼ ì‹œ Slack ì±„ë„ë¡œ Block Kit ë©”ì‹œì§€ ë°œì†¡

Purpose: Critical ì•Œë¦¼ ë°œìƒ ì‹œ íŒ€ Slack ì±„ë„ë¡œ ì¦‰ì‹œ ì•Œë¦¼í•˜ì—¬ ë¹ ë¥¸ í˜‘ì—… ëŒ€ì‘ ê°€ëŠ¥
Output: Slack ì›¹í›… API, Block Kit ë©”ì‹œì§€ í¬ë§·, ì„¤ì • UI, ê¸°ì¡´ ì•Œë¦¼ ì‹œìŠ¤í…œ í†µí•©
</objective>

<execution_context>
~/.claude/get-shit-done/workflows/execute-plan.md
./summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/13-slack-integration/DISCOVERY.md

# Phase 12 êµ¬í˜„ ì°¸ê³  (ë™ì¼ íŒ¨í„´):
@.planning/phases/12-email-notification/12-01-SUMMARY.md

# ê¸°ì¡´ ì•Œë¦¼ ì‹œìŠ¤í…œ íŒŒì¼:
@src/types/notification.ts
@src/stores/notificationStore.ts
@src/hooks/useAlertNotifications.ts
@src/components/admin/EmailSettings.tsx

# ê´€ë ¨ ì„¤ì •:
@src/config/constants.ts

**Tech stack available:** zustand, zod
**Established patterns:**
- NotificationChannel íƒ€ì… ì¶”ìƒí™”
- ì¿¨ë‹¤ìš´ + ì¼ì¼ ë°œì†¡ ì œí•œ ë©”ì»¤ë‹ˆì¦˜
- Zustand persist ìŠ¤í† ì–´
- ì•Œë¦¼ ì„¤ì • UI ì»´í¬ë„ŒíŠ¸ íŒ¨í„´

**Constraining decisions:**
- Native fetch ì‚¬ìš© (Slack SDK ë¶ˆí•„ìš” - DISCOVERY.md)
- Block Kit ë©”ì‹œì§€ í¬ë§· (ì‹œê°ì ìœ¼ë¡œ í’ë¶€í•œ ì•Œë¦¼)
- Critical ì•Œë¦¼ë§Œ ê¸°ë³¸ ë°œì†¡ (ì‚¬ìš©ì í”¼ë¡œë„ ê³ ë ¤)
</context>

<tasks>

<task type="auto">
  <name>Task 1: Slack ì•Œë¦¼ íƒ€ì… ë° ìƒìˆ˜ ì„¤ì •</name>
  <files>src/types/notification.ts, src/config/constants.ts</files>
  <action>
1. src/types/notification.tsì— Slack ê´€ë ¨ íƒ€ì… ì¶”ê°€:
```typescript
// Slack ì•Œë¦¼ ì„¤ì •
export interface SlackNotificationConfig {
  enabled: boolean;
  webhookUrl: string; // ì‚¬ìš©ìê°€ ì…ë ¥ (ë³´ì•ˆìƒ í´ë¼ì´ì–¸íŠ¸ì— ì €ì¥)
  sendOnCriticalOnly: boolean;
  cooldownMinutes: number;
}

// Slack Block Kit ë©”ì‹œì§€ íƒ€ì…
export interface SlackBlockKitMessage {
  text: string; // Fallback for notifications
  blocks: SlackBlock[];
}

export type SlackBlock =
  | SlackHeaderBlock
  | SlackSectionBlock
  | SlackContextBlock
  | SlackDividerBlock;

export interface SlackHeaderBlock {
  type: 'header';
  text: { type: 'plain_text'; text: string; emoji?: boolean };
}

export interface SlackSectionBlock {
  type: 'section';
  text?: { type: 'mrkdwn'; text: string };
  fields?: Array<{ type: 'mrkdwn'; text: string }>;
}

export interface SlackContextBlock {
  type: 'context';
  elements: Array<{ type: 'mrkdwn'; text: string }>;
}

export interface SlackDividerBlock {
  type: 'divider';
}

// Slack ë°œì†¡ ì‘ë‹µ íƒ€ì…
export interface SendSlackResponse {
  success: boolean;
  error?: string;
}
```

2. src/config/constants.tsì— SLACK_CONFIG ì¶”ê°€:
```typescript
export const SLACK_CONFIG = {
  DEFAULT_COOLDOWN_MINUTES: 30,
  MAX_DAILY_MESSAGES: 100, // Slackì€ ì´ë©”ì¼ë³´ë‹¤ ê´€ëŒ€
  WEBHOOK_URL_PATTERN: /^https:\/\/hooks\.slack\.com\/services\//, // URL ê²€ì¦ìš©
} as const;
```
  </action>
  <verify>npx tsc --noEmit íƒ€ì… ì²´í¬ í†µê³¼</verify>
  <done>SlackNotificationConfig, SlackBlockKitMessage íƒ€ì… ì •ì˜ë¨, SLACK_CONFIG ìƒìˆ˜ ì¶”ê°€ë¨</done>
</task>

<task type="auto">
  <name>Task 2: Slack ì›¹í›… API Route êµ¬í˜„</name>
  <files>src/app/api/notifications/slack/route.ts</files>
  <action>
1. src/app/api/notifications/slack/route.ts ìƒì„±:
```typescript
import { NextResponse } from 'next/server';
import { z } from 'zod';
import { SLACK_CONFIG } from '@/config/constants';
import type { SlackBlockKitMessage } from '@/types/notification';

// ìš”ì²­ ìŠ¤í‚¤ë§ˆ
const SendSlackSchema = z.object({
  webhookUrl: z.string().regex(
    SLACK_CONFIG.WEBHOOK_URL_PATTERN,
    'Invalid Slack webhook URL format'
  ),
  message: z.object({
    text: z.string().min(1),
    blocks: z.array(z.any()).optional(),
  }),
  ruleId: z.string().optional(),
});

// Slack ì¿¨ë‹¤ìš´ ì¶”ì  (ì¸ë©”ëª¨ë¦¬)
const slackCooldowns = new Map<string, number>();

// ì¼ì¼ ë°œì†¡ ì¹´ìš´íŠ¸ ì¶”ì 
let dailySlackCount = 0;
let lastResetDate = new Date().toDateString();

// ì¼ì¼ ì¹´ìš´íŠ¸ ë¦¬ì…‹ ì²´í¬
function checkDailyReset(): void {
  const today = new Date().toDateString();
  if (today !== lastResetDate) {
    dailySlackCount = 0;
    lastResetDate = today;
  }
}

// ì¿¨ë‹¤ìš´ ì²´í¬
function isInCooldown(ruleId: string, cooldownMinutes: number): boolean {
  const lastSent = slackCooldowns.get(ruleId);
  if (!lastSent) return false;
  return Date.now() - lastSent < cooldownMinutes * 60 * 1000;
}

export async function POST(request: Request) {
  try {
    // ì¼ì¼ ì œí•œ ì²´í¬
    checkDailyReset();
    if (dailySlackCount >= SLACK_CONFIG.MAX_DAILY_MESSAGES) {
      return NextResponse.json(
        { success: false, error: 'Daily Slack message limit reached' },
        { status: 429 }
      );
    }

    // ìš”ì²­ íŒŒì‹± ë° ê²€ì¦
    const body = await request.json();
    const result = SendSlackSchema.safeParse(body);

    if (!result.success) {
      return NextResponse.json(
        { success: false, error: result.error.message },
        { status: 400 }
      );
    }

    const { webhookUrl, message, ruleId } = result.data;

    // ruleIdê°€ ìˆìœ¼ë©´ ì¿¨ë‹¤ìš´ ì²´í¬
    if (ruleId && isInCooldown(ruleId, SLACK_CONFIG.DEFAULT_COOLDOWN_MINUTES)) {
      return NextResponse.json(
        { success: false, error: 'Slack cooldown active for this rule' },
        { status: 429 }
      );
    }

    // Slack ì›¹í›…ìœ¼ë¡œ ë©”ì‹œì§€ ë°œì†¡
    const response = await fetch(webhookUrl, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify(message),
    });

    if (!response.ok) {
      const errorText = await response.text();
      console.error('[Slack API] Send failed:', response.status, errorText);
      return NextResponse.json(
        { success: false, error: `Slack API error: ${response.status}` },
        { status: 502 }
      );
    }

    // ì„±ê³µ ì‹œ ì¿¨ë‹¤ìš´ ë° ì¹´ìš´íŠ¸ ì—…ë°ì´íŠ¸
    if (ruleId) {
      slackCooldowns.set(ruleId, Date.now());
    }
    dailySlackCount++;

    return NextResponse.json({ success: true });

  } catch (error) {
    console.error('[Slack API] Error:', error);
    return NextResponse.json(
      { success: false, error: error instanceof Error ? error.message : 'Unknown error' },
      { status: 500 }
    );
  }
}
```

**í•µì‹¬ ì„¤ê³„:**
- webhookUrlì€ ìš”ì²­ë§ˆë‹¤ í´ë¼ì´ì–¸íŠ¸ì—ì„œ ì „ë‹¬ (ì„œë²„ì— ì €ì¥í•˜ì§€ ì•ŠìŒ)
- Slack Webhook URL í˜•ì‹ ê²€ì¦ (hooks.slack.com/services/)
- ì¿¨ë‹¤ìš´ + ì¼ì¼ ì œí•œ ì ìš© (ì´ë©”ì¼ê³¼ ë™ì¼ íŒ¨í„´)
  </action>
  <verify>
curl -X POST http://localhost:3000/api/notifications/slack \
  -H "Content-Type: application/json" \
  -d '{"webhookUrl":"https://invalid.com","message":{"text":"Test"}}'
â†’ 400 Invalid webhook URL ë°˜í™˜
  </verify>
  <done>Slack API Route ë™ì‘, Zod ê²€ì¦, ì¿¨ë‹¤ìš´ ì ìš©, ì¼ì¼ ì œí•œ ë™ì‘</done>
</task>

<task type="auto">
  <name>Task 3: ì•Œë¦¼ ìŠ¤í† ì–´ í™•ì¥ ë° í›… í†µí•©</name>
  <files>src/stores/notificationStore.ts, src/hooks/useAlertNotifications.ts</files>
  <action>
1. src/stores/notificationStore.ts ìˆ˜ì • - slackConfig ìƒíƒœ ì¶”ê°€:
```typescript
import type { EmailNotificationConfig, SlackNotificationConfig } from '@/types/notification';
import { EMAIL_CONFIG, SLACK_CONFIG } from '@/config/constants';

interface NotificationState {
  emailConfig: EmailNotificationConfig;
  slackConfig: SlackNotificationConfig;
  updateEmailConfig: (config: Partial<EmailNotificationConfig>) => void;
  updateSlackConfig: (config: Partial<SlackNotificationConfig>) => void;
  resetEmailConfig: () => void;
  resetSlackConfig: () => void;
}

const defaultSlackConfig: SlackNotificationConfig = {
  enabled: false,
  webhookUrl: '',
  sendOnCriticalOnly: true,
  cooldownMinutes: SLACK_CONFIG.DEFAULT_COOLDOWN_MINUTES,
};

// ìŠ¤í† ì–´ì— slackConfig ë° ê´€ë ¨ ë©”ì„œë“œ ì¶”ê°€
```

2. src/hooks/useAlertNotifications.ts ìˆ˜ì • - Slack ë°œì†¡ ë¡œì§ ì¶”ê°€:

Block Kit ë©”ì‹œì§€ ìƒì„± í•¨ìˆ˜:
```typescript
import type { NewAlert } from '@/types/alert';
import type { SlackBlockKitMessage } from '@/types/notification';

function createSlackMessage(alert: NewAlert): SlackBlockKitMessage {
  const severityEmoji = alert.severity === 'critical' ? 'ğŸš¨' :
                        alert.severity === 'warning' ? 'âš ï¸' : 'â„¹ï¸';

  return {
    text: `[${alert.severity.toUpperCase()}] ${alert.ruleName}`,
    blocks: [
      {
        type: 'header',
        text: {
          type: 'plain_text',
          text: `${severityEmoji} ${alert.ruleName}`,
          emoji: true
        },
      },
      {
        type: 'section',
        text: { type: 'mrkdwn', text: alert.message },
      },
      {
        type: 'section',
        fields: [
          { type: 'mrkdwn', text: `*ì‹¬ê°ë„:*\n${alert.severity}` },
          { type: 'mrkdwn', text: `*í˜„ì¬ ê°’:*\n${alert.value.toFixed(1)}%` },
          { type: 'mrkdwn', text: `*ì„ê³„ê°’:*\n${alert.threshold}%` },
          { type: 'mrkdwn', text: `*ì‹œê°:*\n${new Date().toLocaleString('ko-KR')}` },
        ],
      },
      { type: 'divider' },
      {
        type: 'context',
        elements: [
          { type: 'mrkdwn', text: 'ğŸ  Home-KRDN ëª¨ë‹ˆí„°ë§ ì‹œìŠ¤í…œ' },
        ],
      },
    ],
  };
}
```

Slack ë°œì†¡ í•¨ìˆ˜:
```typescript
async function sendSlackAlert(
  alert: NewAlert,
  webhookUrl: string
): Promise<void> {
  try {
    const message = createSlackMessage(alert);
    const response = await fetch('/api/notifications/slack', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({
        webhookUrl,
        message,
        ruleId: alert.ruleId,
      }),
    });

    if (!response.ok) {
      const data = await response.json();
      console.warn('[Alert Slack] Failed:', data.error);
    }
  } catch (error) {
    console.error('[Alert Slack] Error:', error);
  }
}
```

useAlertNotifications í›… ë‚´ë¶€ì—ì„œ:
- useNotificationStoreì—ì„œ slackConfig ê°€ì ¸ì˜¤ê¸°
- ì•Œë¦¼ ì²˜ë¦¬ ë£¨í”„ì—ì„œ Slack ë°œì†¡ ì¡°ê±´ ì¶”ê°€ (ì´ë©”ì¼ê³¼ ë™ì¼ íŒ¨í„´)
  </action>
  <verify>
1. npm run build ì„±ê³µ
2. ì•Œë¦¼ ë°œìƒ ì‹œ ì½˜ì†”ì—ì„œ Slack API í˜¸ì¶œ í™•ì¸ (ì„¤ì • í™œì„±í™” ì‹œ)
3. Slack ì„¤ì • ë¹„í™œì„±í™” ì‹œ API í˜¸ì¶œ ì—†ìŒ
  </verify>
  <done>notificationStoreì— slackConfig ì¶”ê°€ë¨, useAlertNotificationsì— Slack í†µí•©ë¨</done>
</task>

<task type="auto">
  <name>Task 4: Slack ì„¤ì • UI ì»´í¬ë„ŒíŠ¸</name>
  <files>src/components/admin/SlackSettings.tsx, src/app/admin/alerts/page.tsx</files>
  <action>
1. src/components/admin/SlackSettings.tsx ìƒì„±:
```typescript
'use client';

import { MessageSquare, Check, AlertCircle } from 'lucide-react';
import { useNotificationStore } from '@/stores/notificationStore';
import { useState, useEffect } from 'react';
import { SLACK_CONFIG } from '@/config/constants';

export function SlackSettings() {
  const { slackConfig, updateSlackConfig } = useNotificationStore();
  const [webhookUrl, setWebhookUrl] = useState(slackConfig.webhookUrl);
  const [saved, setSaved] = useState(false);
  const [urlError, setUrlError] = useState('');

  useEffect(() => {
    setWebhookUrl(slackConfig.webhookUrl);
  }, [slackConfig.webhookUrl]);

  const validateUrl = (url: string): boolean => {
    if (!url) return true; // ë¹ˆ ê°’ì€ í—ˆìš©
    return SLACK_CONFIG.WEBHOOK_URL_PATTERN.test(url);
  };

  const handleSave = () => {
    if (!validateUrl(webhookUrl)) {
      setUrlError('ì˜¬ë°”ë¥¸ Slack Webhook URL í˜•ì‹ì´ ì•„ë‹™ë‹ˆë‹¤');
      return;
    }
    setUrlError('');
    updateSlackConfig({ webhookUrl });
    setSaved(true);
    setTimeout(() => setSaved(false), 2000);
  };

  return (
    <div className="rounded-lg border border-border bg-card p-6">
      <div className="mb-4 flex items-center gap-2">
        <MessageSquare className="h-5 w-5 text-primary" />
        <h3 className="font-semibold">Slack ì•Œë¦¼ ì„¤ì •</h3>
      </div>

      <div className="space-y-4">
        {/* í™œì„±í™” í† ê¸€ */}
        <label className="flex items-center justify-between">
          <span>Slack ì•Œë¦¼ í™œì„±í™”</span>
          <button
            onClick={() => updateSlackConfig({ enabled: !slackConfig.enabled })}
            className={`relative h-6 w-11 rounded-full transition-colors ${
              slackConfig.enabled ? 'bg-primary' : 'bg-muted'
            }`}
          >
            <span
              className={`absolute left-0.5 top-0.5 h-5 w-5 rounded-full bg-white transition-transform ${
                slackConfig.enabled ? 'translate-x-5' : ''
              }`}
            />
          </button>
        </label>

        {/* Webhook URL */}
        <div>
          <label className="mb-1 block text-sm text-muted-foreground">
            Slack Webhook URL
          </label>
          <div className="flex gap-2">
            <input
              type="url"
              value={webhookUrl}
              onChange={(e) => {
                setWebhookUrl(e.target.value);
                setUrlError('');
              }}
              placeholder="https://hooks.slack.com/services/XXX/YYY/ZZZ"
              className={`flex-1 rounded-md border bg-background px-3 py-2 ${
                urlError ? 'border-destructive' : 'border-border'
              }`}
              disabled={!slackConfig.enabled}
            />
            <button
              onClick={handleSave}
              disabled={!slackConfig.enabled || !webhookUrl}
              className="rounded-md bg-primary px-4 py-2 text-primary-foreground disabled:opacity-50"
            >
              {saved ? <Check className="h-4 w-4" /> : 'ì €ì¥'}
            </button>
          </div>
          {urlError && (
            <p className="mt-1 flex items-center gap-1 text-xs text-destructive">
              <AlertCircle className="h-3 w-3" />
              {urlError}
            </p>
          )}
        </div>

        {/* Criticalë§Œ ë°œì†¡ ì˜µì…˜ */}
        <label className="flex items-center justify-between">
          <span className="text-sm">Critical ì•Œë¦¼ë§Œ Slack ë°œì†¡</span>
          <input
            type="checkbox"
            checked={slackConfig.sendOnCriticalOnly}
            onChange={(e) =>
              updateSlackConfig({ sendOnCriticalOnly: e.target.checked })
            }
            disabled={!slackConfig.enabled}
            className="h-4 w-4"
          />
        </label>

        {/* ì¿¨ë‹¤ìš´ ì„¤ì • */}
        <div>
          <label className="mb-1 block text-sm text-muted-foreground">
            ë©”ì‹œì§€ ì¿¨ë‹¤ìš´ (ë¶„)
          </label>
          <input
            type="number"
            value={slackConfig.cooldownMinutes}
            onChange={(e) =>
              updateSlackConfig({
                cooldownMinutes: parseInt(e.target.value) || 30,
              })
            }
            min={5}
            max={120}
            className="w-24 rounded-md border border-border bg-background px-3 py-2"
            disabled={!slackConfig.enabled}
          />
        </div>

        {/* ì„¤ì • ì•ˆë‚´ */}
        <div className="rounded-md bg-muted/50 p-3 text-xs text-muted-foreground">
          <p className="font-medium mb-1">Webhook URL ì–»ëŠ” ë°©ë²•:</p>
          <ol className="list-decimal list-inside space-y-1">
            <li>api.slack.com/appsì—ì„œ ì•± ìƒì„±</li>
            <li>Incoming Webhooks í™œì„±í™”</li>
            <li>Add New Webhook to Workspace í´ë¦­</li>
            <li>ì±„ë„ ì„ íƒ í›„ URL ë³µì‚¬</li>
          </ol>
        </div>
      </div>
    </div>
  );
}
```

2. src/app/admin/alerts/page.tsx ìˆ˜ì •:
- SlackSettings ì»´í¬ë„ŒíŠ¸ import
- EmailSettings ì•„ë˜ì— SlackSettings ì»´í¬ë„ŒíŠ¸ ì¶”ê°€
  </action>
  <verify>
1. npm run devë¡œ ê°œë°œ ì„œë²„ ì‹¤í–‰
2. /admin/alerts í˜ì´ì§€ì—ì„œ Slack ì„¤ì • UI í‘œì‹œ í™•ì¸
3. URL ê²€ì¦, í† ê¸€, ì €ì¥ ê¸°ëŠ¥ ë™ì‘ í™•ì¸
  </verify>
  <done>SlackSettings ì»´í¬ë„ŒíŠ¸ ë Œë”ë§ë¨, URL ê²€ì¦ ë™ì‘, ì„¤ì • ë³€ê²½ ì‹œ store ì—…ë°ì´íŠ¸ë¨</done>
</task>

</tasks>

<verification>
Before declaring phase complete:
- [ ] `npm run build` ì„±ê³µ
- [ ] `npx tsc --noEmit` íƒ€ì… ì—ëŸ¬ ì—†ìŒ
- [ ] /api/notifications/slack POST ìš”ì²­ ì²˜ë¦¬ë¨
- [ ] Webhook URL í˜•ì‹ ê²€ì¦ ë™ì‘
- [ ] /admin/alerts í˜ì´ì§€ì— Slack ì„¤ì • UI í‘œì‹œë¨
- [ ] Slack ì„¤ì • ë³€ê²½ì´ localStorageì— ì €ì¥ë¨
- [ ] Critical ì•Œë¦¼ ë°œìƒ ì‹œ Slack API í˜¸ì¶œë¨ (ì„¤ì • í™œì„±í™” ì‹œ)
</verification>

<success_criteria>

- ëª¨ë“  Task ì™„ë£Œ
- ë¹Œë“œ ë° íƒ€ì… ì²´í¬ í†µê³¼
- Slack ì„¤ì • UI ë™ì‘
- Slack API Route ì‘ë‹µ ì •ìƒ
- Block Kit ë©”ì‹œì§€ í¬ë§· ì ìš©
- Phase 13 complete
</success_criteria>

<output>
After completion, create `.planning/phases/13-slack-integration/13-01-SUMMARY.md`:

# Phase 13 Plan 01: Slack ì›¹í›… ì•Œë¦¼ Summary

**[Substantive one-liner - what shipped]**

## Accomplishments

- [Key outcome 1]
- [Key outcome 2]

## Files Created/Modified

- `path/to/file.ts` - Description

## Decisions Made

[Key decisions and rationale, or "None"]

## Issues Encountered

[Problems and resolutions, or "None"]

## Next Step

Ready for Phase 14 (Project Admin CRUD)
</output>
