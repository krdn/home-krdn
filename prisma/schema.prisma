// Prisma Schema for Home-KRDN
// Prisma 7 - datasource URL은 prisma.config.ts에서 관리

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "sqlite"
}

// ============================================================
// 사용자 및 팀 관련 모델
// ============================================================

// 사용자 역할
// SQLite는 native enum을 지원하지 않으므로 String으로 저장됨
enum Role {
  ADMIN
  USER
  VIEWER
}

// 사용자 모델
model User {
  id           String @id @default(cuid())
  email        String @unique
  username     String @unique
  passwordHash String

  // 역할 (기본값: USER)
  role Role @default(USER)

  // 프로필 정보
  displayName String?
  avatarUrl   String?

  // 타임스탬프
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
  lastLoginAt DateTime?

  // 관계: 소유한 팀
  ownedTeams Team[] @relation("TeamOwner")

  // 관계: 팀 멤버십 (다대다)
  teamMemberships TeamMember[]

  // 관계: 사용자 설정 (1:1)
  settings UserSettings?

  // 관계: 비밀번호 재설정 토큰
  passwordResetTokens PasswordResetToken[]

  // 관계: 팀 초대 (초대한 사람)
  teamInvites TeamInvite[] @relation("TeamInviter")
}

// 팀 모델
model Team {
  id          String  @id @default(cuid())
  name        String
  slug        String  @unique
  description String?

  // 팀 소유자
  ownerId String
  owner   User   @relation("TeamOwner", fields: [ownerId], references: [id])

  // 타임스탬프
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // 관계: 팀 멤버
  members TeamMember[]

  // 관계: 팀 초대
  invites TeamInvite[]

  // 관계: 팀 설정 (1:1)
  settings TeamSettings?
}

// 팀 알림 설정 모델 (Phase 21)
model TeamSettings {
  id String @id @default(cuid())

  // 팀 연결 (1:1)
  teamId String @unique
  team   Team   @relation(fields: [teamId], references: [id], onDelete: Cascade)

  // 알림 채널 설정
  emailNotifications Boolean @default(true)
  slackWebhookUrl    String? // 팀 전용 Slack 웹훅

  // 알림 대상 설정
  notifyOnAlert       Boolean @default(true)  // 시스템 경고 알림
  notifyOnMemberJoin  Boolean @default(true)  // 멤버 가입 알림
  notifyOnMemberLeave Boolean @default(false) // 멤버 탈퇴 알림

  updatedAt DateTime @updatedAt
}

// 팀 멤버십 (다대다 조인 테이블)
model TeamMember {
  id   String @id @default(cuid())
  role Role   @default(USER)

  // 사용자 외래키
  userId String
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  // 팀 외래키
  teamId String
  team   Team   @relation(fields: [teamId], references: [id], onDelete: Cascade)

  // 가입 시간
  joinedAt DateTime @default(now())

  // 유니크 제약: 한 사용자가 한 팀에 한 번만 가입 가능
  @@unique([userId, teamId])
}

// 사용자 설정 모델 (Phase 20 준비)
model UserSettings {
  id String @id @default(cuid())

  // 사용자 연결 (1:1)
  userId String @unique
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  // 대시보드 설정
  dashboardLayout String? // JSON string으로 저장
  theme           String  @default("dark")

  // 알림 설정
  emailNotifications Boolean @default(true)
  pushNotifications  Boolean @default(false)

  // 타임스탬프
  updatedAt DateTime @updatedAt
}

// ============================================================
// 인증 관련 모델
// ============================================================

// 비밀번호 재설정 토큰
model PasswordResetToken {
  id        String    @id @default(cuid())
  token     String    @unique
  userId    String
  user      User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  expiresAt DateTime
  usedAt    DateTime?
  createdAt DateTime  @default(now())

  // 인덱스: 토큰 조회 최적화
  @@index([token])
  // 인덱스: 사용자별 토큰 조회
  @@index([userId])
}

// 팀 초대 토큰
model TeamInvite {
  id    String @id @default(cuid())
  token String @unique
  email String // 초대받는 이메일 주소
  role  Role   @default(USER) // 초대 시 부여될 역할

  // 팀 외래키
  teamId String
  team   Team   @relation(fields: [teamId], references: [id], onDelete: Cascade)

  // 초대한 사용자
  invitedById String
  invitedBy   User   @relation("TeamInviter", fields: [invitedById], references: [id])

  // 타임스탬프
  expiresAt DateTime
  usedAt    DateTime?
  createdAt DateTime  @default(now())

  // 인덱스
  @@index([token])
  @@index([teamId])
  @@index([email])
}
