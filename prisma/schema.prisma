// Prisma Schema for Home-KRDN
// Prisma 7 - datasource URL은 prisma.config.ts에서 관리

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "sqlite"
}

// ============================================================
// 사용자 및 팀 관련 모델
// ============================================================

// 사용자 역할
// SQLite는 native enum을 지원하지 않으므로 String으로 저장됨
enum Role {
  ADMIN
  USER
  VIEWER
}

// 사용자 모델
model User {
  id           String @id @default(cuid())
  email        String @unique
  username     String @unique
  passwordHash String

  // 역할 (기본값: USER)
  role Role @default(USER)

  // 프로필 정보
  displayName String?
  avatarUrl   String?

  // 타임스탬프
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
  lastLoginAt DateTime?

  // 관계: 소유한 팀
  ownedTeams Team[] @relation("TeamOwner")

  // 관계: 팀 멤버십 (다대다)
  teamMemberships TeamMember[]

  // 관계: 사용자 설정 (1:1)
  settings UserSettings?

  // 관계: 비밀번호 재설정 토큰
  passwordResetTokens PasswordResetToken[]

  // 관계: 팀 초대 (초대한 사람)
  teamInvites TeamInvite[] @relation("TeamInviter")

  // 관계: 푸시 구독 (Phase 23)
  pushSubscriptions PushSubscription[]

  // 관계: 포트 레지스트리 (Phase 33)
  portRegistries PortRegistry[]

  // 관계: GitHub 설정 (Phase 34)
  gitHubSettings GitHubSettings?

  // 관계: 로그 알림 규칙 (Phase 38)
  logAlertRules LogAlertRule[]

  // 관계: Kubernetes 클러스터 (Phase 39)
  kubernetesClusters KubernetesCluster[]
}

// 팀 모델
model Team {
  id          String  @id @default(cuid())
  name        String
  slug        String  @unique
  description String?

  // 팀 소유자
  ownerId String
  owner   User   @relation("TeamOwner", fields: [ownerId], references: [id])

  // 타임스탬프
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // 관계: 팀 멤버
  members TeamMember[]

  // 관계: 팀 초대
  invites TeamInvite[]

  // 관계: 팀 설정 (1:1)
  settings TeamSettings?
}

// 팀 알림 설정 모델 (Phase 21)
model TeamSettings {
  id String @id @default(cuid())

  // 팀 연결 (1:1)
  teamId String @unique
  team   Team   @relation(fields: [teamId], references: [id], onDelete: Cascade)

  // 알림 채널 설정
  emailNotifications Boolean @default(true)
  slackWebhookUrl    String? // 팀 전용 Slack 웹훅

  // 알림 대상 설정
  notifyOnAlert       Boolean @default(true)  // 시스템 경고 알림
  notifyOnMemberJoin  Boolean @default(true)  // 멤버 가입 알림
  notifyOnMemberLeave Boolean @default(false) // 멤버 탈퇴 알림

  updatedAt DateTime @updatedAt
}

// 팀 멤버십 (다대다 조인 테이블)
model TeamMember {
  id   String @id @default(cuid())
  role Role   @default(USER)

  // 사용자 외래키
  userId String
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  // 팀 외래키
  teamId String
  team   Team   @relation(fields: [teamId], references: [id], onDelete: Cascade)

  // 가입 시간
  joinedAt DateTime @default(now())

  // 유니크 제약: 한 사용자가 한 팀에 한 번만 가입 가능
  @@unique([userId, teamId])
}

// 사용자 설정 모델 (Phase 20 준비)
model UserSettings {
  id String @id @default(cuid())

  // 사용자 연결 (1:1)
  userId String @unique
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  // 대시보드 설정
  dashboardLayout String? // JSON string으로 저장
  theme           String  @default("dark")

  // 알림 설정
  emailNotifications Boolean @default(true)
  pushNotifications  Boolean @default(false)

  // 타임스탬프
  updatedAt DateTime @updatedAt
}

// ============================================================
// 인증 관련 모델
// ============================================================

// 비밀번호 재설정 토큰
model PasswordResetToken {
  id        String    @id @default(cuid())
  token     String    @unique
  userId    String
  user      User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  expiresAt DateTime
  usedAt    DateTime?
  createdAt DateTime  @default(now())

  // 인덱스: 토큰 조회 최적화
  @@index([token])
  // 인덱스: 사용자별 토큰 조회
  @@index([userId])
}

// 팀 초대 토큰
model TeamInvite {
  id    String @id @default(cuid())
  token String @unique
  email String // 초대받는 이메일 주소
  role  Role   @default(USER) // 초대 시 부여될 역할

  // 팀 외래키
  teamId String
  team   Team   @relation(fields: [teamId], references: [id], onDelete: Cascade)

  // 초대한 사용자
  invitedById String
  invitedBy   User   @relation("TeamInviter", fields: [invitedById], references: [id])

  // 타임스탬프
  expiresAt DateTime
  usedAt    DateTime?
  createdAt DateTime  @default(now())

  // 인덱스
  @@index([token])
  @@index([teamId])
  @@index([email])
}

// ============================================================
// 푸시 알림 관련 모델 (Phase 23)
// ============================================================

// 푸시 구독 모델
model PushSubscription {
  id String @id @default(cuid())

  // 사용자 연결
  userId String
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  // 푸시 구독 정보
  endpoint String @unique // Push 서버 엔드포인트
  p256dh   String // 암호화 키 (ECDH P-256)
  auth     String // 인증 시크릿

  // 타임스탬프
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // 인덱스: 사용자별 구독 조회
  @@index([userId])
}

// ============================================================
// Port Registry 모델 (Phase 33)
// ============================================================

// 포트 레지스트리 모델
model PortRegistry {
  id String @id @default(cuid())

  // 포트 정보
  port     Int    @unique
  protocol String @default("tcp") // tcp, udp

  // 프로젝트 정보
  projectId   String? // 연결된 프로젝트 ID (nullable - 수동 등록 시)
  projectName String // 프로젝트/서비스 이름
  description String? // 포트 용도 설명

  // 환경 및 상태
  environment String @default("development") // development, staging, production
  status      String @default("active") // active, reserved, deprecated

  // URL 정보
  internalUrl String? // 내부 접근 URL (예: http://localhost:3000)
  externalUrl String? // 외부 접근 URL (예: https://app.example.com)

  // 메타데이터
  category String? // ai, web, n8n, system 등
  tags     String? // JSON 배열 문자열로 저장

  // 타임스탬프
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // 등록자 (선택)
  createdById String?
  createdBy   User?   @relation(fields: [createdById], references: [id], onDelete: SetNull)

  // 인덱스
  @@index([projectId])
  @@index([category])
  @@index([status])
}

// ============================================================
// GitHub Integration 모델 (Phase 34)
// ============================================================

// GitHub 설정 모델 (사용자별 1:1)
model GitHubSettings {
  id String @id @default(cuid())

  // 사용자 연결 (1:1)
  userId String @unique
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  // GitHub 인증 정보
  accessToken    String    // 암호화된 Personal Access Token 저장
  tokenExpiresAt DateTime? // 선택적 만료일

  // GitHub 프로필 정보 (API 응답에서 획득)
  username  String? // GitHub 사용자명
  avatarUrl String? // GitHub 아바타 URL

  // 타임스탬프
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // 인덱스: 사용자별 조회 최적화
  @@index([userId])
}

// ============================================================
// Log Aggregation 모델 (Phase 36)
// ============================================================

// 로그 엔트리 모델
// Docker, systemd journal, 애플리케이션 로그를 통합 저장
model LogEntry {
  id        String   @id @default(uuid())
  source    String   // docker, journal, app
  sourceId  String   // container id, unit name, file path
  level     String   // trace, debug, info, warn, error, fatal
  message   String
  timestamp DateTime @default(now())
  metadata  String?  // JSON string (optional)
  createdAt DateTime @default(now())

  // 인덱스: 소스별 시간순 조회
  @@index([source, timestamp])
  // 인덱스: 레벨별 시간순 조회
  @@index([level, timestamp])
  // 인덱스: 전체 시간순 조회
  @@index([timestamp])
  // 인덱스: 특정 소스(컨테이너 등) 조회
  @@index([sourceId])
}

// ============================================================
// Log Alert 모델 (Phase 38)
// ============================================================

// 로그 알림 규칙 모델
// 로그 패턴 기반 알림 규칙 (키워드, 정규식, 빈도)
model LogAlertRule {
  id          String  @id @default(uuid())
  name        String
  description String?

  // JSON으로 조건 저장 (flexibility)
  // { type, keywords?, pattern?, caseSensitive?, threshold?, windowMinutes?, level? }
  condition String

  // 필터 조건 (JSON 배열)
  sources   String? // JSON: ["docker", "journal", "app"]
  sourceIds String? // JSON: ["container-id-1", "container-id-2"]

  // 알림 설정
  severity String  @default("warning") // info, warning, critical
  enabled  Boolean @default(true)
  cooldown Int     @default(300) // 쿨다운 시간 (초), 기본 5분

  // 소유자 (null이면 전역 규칙)
  userId String?
  user   User?   @relation(fields: [userId], references: [id], onDelete: SetNull)

  // 타임스탬프
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // 인덱스
  @@index([userId])
  @@index([enabled])
}

// ============================================================
// Kubernetes Integration 모델 (Phase 39)
// ============================================================

// Kubernetes 클러스터 설정 모델
// 사용자별 여러 클러스터 연결 가능 (1:N)
model KubernetesCluster {
  id   String @id @default(cuid())
  name String // 클러스터 표시 이름

  // 사용자 연결 (N:1 - 한 사용자가 여러 클러스터 가능)
  userId String
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  // 클러스터 연결 정보
  server        String  // API 서버 URL (https://...)
  caData        String? // Base64 인코딩된 CA 인증서
  skipTLSVerify Boolean @default(false)

  // 인증 정보 (토큰 또는 인증서)
  authType          String  @default("token") // token, certificate
  token             String? // Bearer 토큰 (암호화 저장)
  clientCertificate String? // 클라이언트 인증서 (Base64)
  clientKey         String? // 클라이언트 키 (Base64)

  // 기본 namespace
  defaultNamespace String @default("default")

  // 상태
  isActive Boolean @default(true)

  // 타임스탬프
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // 인덱스
  @@index([userId])
  @@unique([userId, name]) // 사용자별 클러스터 이름 유일
}
